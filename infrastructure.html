<!doctype html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>Infrastructure - Planning Data</title>

    <link href="stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="digital-land.github.io/infrastructure.html">

      <meta name="robots" content="noindex" />
      <meta name="twitter:card" content="summary" />
      <meta name="twitter:image" content="digital-land.github.io/images/govuk-large.png" />
      <meta name="twitter:title" content="Infrastructure - Planning Data" />
      <meta name="twitter:url" content="digital-land.github.io/infrastructure.html" />

      <meta property="og:image" content="digital-land.github.io/images/govuk-large.png" />
      <meta property="og:site_name" content="Planning Data" />
      <meta property="og:title" content="Infrastructure" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="digital-land.github.io/infrastructure.html" />

    
  </head>

  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link" data-module="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="https://planning.data.gov.uk" class="govuk-header__link govuk-header__link--homepage">
        <span class="govuk-header__product-name">
          Planning Data
        </span>
      </a>
        <strong class="govuk-tag">Beta</strong>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <button type="button" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </button>
        </div>

      <div class="app-pane__body" data-module="in-page-navigation">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents" tabindex="-1" aria-label="Table of contents" role="dialog">
              <div class="search" data-module="search" data-path-to-site-root="./">
  <form action="https://www.google.co.uk/search" method="get" role="search" class="search__form govuk-!-margin-bottom-4">
    <input type="hidden" name="as_sitesearch" value="digital-land.github.io"/>
    <label class="govuk-label search__label" for="search" aria-hidden="true">
      Search (via Google)
    </label>
    <input
      type="text"
      id="search" name="q"
      class="govuk-input govuk-!-margin-bottom-0 search__input"
      aria-controls="search-results"
      placeholder="Search">
    <button type="submit" class="search__button">Search</button>
  </form>
</div>

              <button type="button" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></button>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading" data-module="collapsible-navigation">
                      <ul>
  <li>
    <a href="./index.html"><span>Planning Data Service</span></a>
  </li>
  <li>
    <a href="./documentation/index.html"><span>Documentation</span></a>
    <ul>
      <li>
        <a href="./documentation/index.html#documentation-overview"><span>Overview</span></a>
      </li>
      <li>
        <a href="./documentation/index.html#architecture"><span>Architecture</span></a>
      </li>
      <li>
        <a href="./documentation/index.html#documentation-infrastructure"><span>Infrastructure</span></a>
      </li>
      <li>
        <a href="./documentation/index.html#data-collection"><span>Data Collection</span></a>
        <ul>
          <li>
            <a href="./documentation/index.html#pipeline-run-process"><span>Pipeline run process</span></a>
          </li>
          <li>
            <a href="./documentation/index.html#anatomy-of-a-collection-repository"><span>Anatomy of a collection repository</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="./documentation/index.html#monitoring"><span>Monitoring</span></a>
      </li>
      <li>
        <a href="./documentation/index.html#services"><span>Services</span></a>
        <ul>
          <li>
            <a href="./documentation/index.html#user-facing-services"><span>User-Facing Services</span></a>
          </li>
          <li>
            <a href="./documentation/index.html#user-facing-service-libraries"><span>User-Facing Service Libraries</span></a>
          </li>
          <li>
            <a href="./documentation/index.html#datasettee"><span>Datasettee</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="./documentation/index.html#data-model"><span>Data model</span></a>
        <ul>
          <li>
            <a href="./documentation/index.html#domain-terminology"><span>Domain Terminology</span></a>
          </li>
          <li>
            <a href="./documentation/index.html#processes"><span>Processes</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="./documentation/index.html#list-of-datasets"><span>List of Datasets</span></a>
      </li>
      <li>
        <a href="./documentation/index.html#external-links"><span>External Links</span></a>
        <ul>
          <li>
            <a href="./documentation/index.html#live-site"><span>Live Site</span></a>
          </li>
          <li>
            <a href="./documentation/index.html#useful-repositories"><span>Useful Repositories</span></a>
          </li>
          <li>
            <a href="./documentation/index.html#other-documentation"><span>Other Documentation</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
<li><a href="./architecture/index.html"><span>Architecture</span></a>
<ul>
<li><a href="./architecture/design/index.html"><span>Solution design index</span></a>
<ul>
<li><a href="./architecture/design/archive/index.html"><span>Solution design archive</span></a>
<ul>
  <li>
    <a href="./architecture/design/archive/2022-11/index.html"><span>Solution design - November 2022</span></a>
    <ul>
      <li>
        <a href="./architecture/design/archive/2022-11/index.html#system-context"><span>System Context</span></a>
      </li>
    </ul>
  </li>
</ul>
</li>
<li><a href="./architecture/design/latest/index.html"><span>Solution design</span></a>
<ul>
  <li>
    <a href="./architecture/design/latest/data-pipelines/index.html"><span>Solution design - Data Pipelines</span></a>
    <ul>
      <li>
        <a href="./architecture/design/latest/data-pipelines/index.html#solution-design-data-pipelines-containers"><span>Containers</span></a>
        <ul>
          <li>
            <a href="./architecture/design/latest/data-pipelines/index.html#structure"><span>Structure</span></a>
          </li>
          <li>
            <a href="./architecture/design/latest/data-pipelines/index.html#interaction"><span>Interaction</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="./architecture/design/latest/data-pipelines/index.html#code"><span>Code</span></a>
        <ul>
          <li>
            <a href="./architecture/design/latest/data-pipelines/index.html#classes-wip"><span>Classes (WIP)</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <a href="./architecture/design/latest/planning-data-platform/index.html"><span>Solution design - Planning Data Platform</span></a>
    <ul>
      <li>
        <a href="./architecture/design/latest/planning-data-platform/index.html#solution-design-planning-data-platform-containers"><span>Containers</span></a>
        <ul>
          <li>
            <a href="./architecture/design/latest/planning-data-platform/index.html#solution-design-planning-data-platform-containers-structure"><span>Structure</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <a href="./architecture/design/latest/publish-service/index.html"><span>Solution design - Publish Service</span></a>
    <ul>
      <li>
        <a href="./architecture/design/latest/publish-service/index.html#solution-design-publish-service-containers"><span>Containers</span></a>
        <ul>
          <li>
            <a href="./architecture/design/latest/publish-service/index.html#solution-design-publish-service-containers-structure"><span>Structure</span></a>
          </li>
          <li>
            <a href="./architecture/design/latest/publish-service/index.html#solution-design-publish-service-containers-interaction"><span>Interaction</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
</li>
</ul>
</li>
  <li>
    <a href="./architecture/decision-records/index.html"><span>Architecture Decision Records (ADRs)</span></a>
    <ul>
      <li>
        <a href="./architecture/decision-records/index.html#1-record-architecture-decisions"><span>1. Record architecture decisions</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="./architecture/decision-records/index.html#2-floating-package-dependencies"><span>2. floating-package-dependencies</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="./architecture/decision-records/index.html#3-use-the-repository-pattern-to-access-a-database"><span>3. Use the repository-pattern to access a database</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="./architecture/decision-records/index.html#4-implement-plugins-using-pluggy"><span>4. Implement plugins using pluggy</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="./architecture/decision-records/index.html#5-load-external-frontend-assets-first"><span>5. Load external frontend assets first</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="./architecture/decision-records/index.html#6-use-github-pages-for-our-content"><span>6. Use Github pages for our content</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="./architecture/decision-records/index.html#7-provide-unique-ids-for-dataset-entries"><span>7. Provide unique IDs for dataset entries</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="./architecture/decision-records/index.html#8-use-files-for-repositories-databases-as-indexes"><span>8. Use files for repositories, databases as indexes</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="./architecture/decision-records/index.html#9-use-sqlite-for-data-packages"><span>9. Use SQLite for data packages</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="./architecture/decision-records/index.html#10-use-the-entity-value-attribute-pattern-for-our-data-model"><span>10. Use the Entity-Value-Attribute pattern for our data model</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="./architecture/decision-records/index.html#11-avoid-git-submodules-wherever-possible"><span>11. Avoid git submodules wherever possible</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="./architecture/decision-records/index.html#12-collection-names-should-be-singular"><span>12. Collection names should be singular</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="./architecture/decision-records/index.html#13-use-github-lfs-for-large-git-files"><span>13. Use Github LFS for large git files</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="./architecture/decision-records/index.html#14-use-kebab-case-for-names-in-data"><span>14. Use kebab-case for names in data</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="./architecture/decision-records/index.html#15-write-new-tests-at-the-lowest-possible-levels"><span>15. Write new tests at the lowest possible levels</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="./architecture/decision-records/index.html#16-missing-entry-dates"><span>16. Missing entry-dates</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="./architecture/decision-records/index.html#17-use-vector-tiles-to-display-geographic-data-on-a-map"><span>17. Use vector tiles to display geographic data on a map</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="./architecture/decision-records/index.html#18-use-nodejs-to-serve-the-frontend-of-the-new-data-validation-tool-and-interact-with-other-apis"><span>18. Use NodeJS to serve the frontend of the new data validation tool and interact with other APIs</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="./architecture/decision-records/index.html#19-use-pytest-and-jsonschema-as-the-contract-validation-and-testing-solution"><span>19. Use PyTest and JSONSchema as the Contract validation and testing solution</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
</li>
  <li>
    <a href="./infrastructure.html"><span>Infrastructure</span></a>
    <ul>
      <li>
        <a href="./infrastructure.html#overview"><span>Overview</span></a>
        <ul>
          <li>
            <a href="./infrastructure.html#planning-data-platform-deployment-diagram"><span>Planning Data Platform - Deployment Diagram</span></a>
          </li>
          <li>
            <a href="./infrastructure.html#data-collection-pipeline-deployment-diagram"><span>Data Collection Pipeline - Deployment Diagram</span></a>
          </li>
          <li>
            <a href="./infrastructure.html#publish-service-deployment-diagram"><span>Publish Service - Deployment Diagram</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="./infrastructure.html#deploying"><span>Deploying</span></a>
        <ul>
          <li>
          </li>
          <li>
            <a href="./infrastructure.html#an-existing-environment"><span>An Existing Environment</span></a>
          </li>
          <li>
            <a href="./infrastructure.html#a-new-environment"><span>A New Environment</span></a>
          </li>
          <li>
            <a href="./infrastructure.html#lambda-functions"><span>Lambda functions</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="./infrastructure.html#configuration-changes"><span>Configuration Changes</span></a>
        <ul>
          <li>
            <a href="./infrastructure.html#add-a-new-application"><span>Add a new application</span></a>
          </li>
          <li>
            <a href="./infrastructure.html#add-a-new-background-task"><span>Add a new background task</span></a>
          </li>
          <li>
            <a href="./infrastructure.html#rds-autoscaling"><span>RDS autoscaling</span></a>
          </li>
          <li>
            <a href="./infrastructure.html#synthetics-canaries"><span>Synthetics Canaries</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <a href="./data-operations-manual.html"><span>Data Operations</span></a>
    <ul>
      <li>
        <ul>
          <li>
            <a href="./data-operations-manual.html#audience-for-this-document"><span>Audience for this document</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="./data-operations-manual.html#key-concepts"><span>Key Concepts</span></a>
        <ul>
          <li>
            <a href="./data-operations-manual.html#source"><span>Source</span></a>
          </li>
          <li>
            <a href="./data-operations-manual.html#endpoint"><span>Endpoint</span></a>
          </li>
          <li>
            <a href="./data-operations-manual.html#key-concepts-entity"><span>Entity</span></a>
          </li>
          <li>
            <a href="./data-operations-manual.html#lookups"><span>Lookups</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="./data-operations-manual.html#key-processes"><span>Key Processes</span></a>
        <ul>
          <li>
            <a href="./data-operations-manual.html#checking-data-before-loading-it-onto-the-platform-with-endpoint-checker"><span>Checking Data before loading it onto the platform with Endpoint Checker</span></a>
          </li>
          <li>
            <a href="./data-operations-manual.html#loading-data-onto-the-platform"><span>Loading data onto the platform</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="./data-operations-manual.html#other-processes"><span>Other Processes</span></a>
        <ul>
          <li>
            <a href="./data-operations-manual.html#adding-endpoints-to-a-collection-manually"><span>Adding Endpoints To A Collection Manually</span></a>
          </li>
          <li>
            <a href="./data-operations-manual.html#creating-a-new-collection"><span>Creating a new collection</span></a>
          </li>
          <li>
            <a href="./data-operations-manual.html#adding-a-new-dataset"><span>Adding a new dataset</span></a>
          </li>
          <li>
            <a href="./data-operations-manual.html#ending-an-endpoint"><span>Ending an endpoint</span></a>
          </li>
          <li>
            <a href="./data-operations-manual.html#retiring-a-resource"><span>Retiring a resource</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="./data-operations-manual.html#validating-an-endpoint"><span>Validating an Endpoint</span></a>
        <ul>
          <li>
            <a href="./data-operations-manual.html#validating-an-endpoint-using-the-command-line"><span>Validating an Endpoint using the command-line</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="./data-operations-manual.html#reference"><span>Reference</span></a>
        <ul>
          <li>
            <a href="./data-operations-manual.html#technical-glossary"><span>Technical Glossary</span></a>
          </li>
          <li>
            <a href="./data-operations-manual.html#key-repositories"><span>Key Repositories</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <a href="./runbook.html"><span>Run Book</span></a>
    <ul>
      <li>
        <a href="./runbook.html#outage-procedure"><span>Outage Procedure</span></a>
      </li>
      <li>
        <a href="./runbook.html#common-issues"><span>Common Issues</span></a>
      </li>
      <li>
        <a href="./runbook.html#incident-response-history"><span>Incident Response History</span></a>
        <ul>
          <li>
            <a href="./runbook.html#planning-data-gov-uk-outage-2023-10-05"><span>Planning.data.gov.uk outage - 2023-10-05</span></a>
          </li>
          <li>
            <a href="./runbook.html#national-map-url-39-dataset-39-parameter-key-changed-to-39-layer-39-2023-10-02"><span>National map url ‘dataset’ parameter key changed to ‘layer’ - 2023-10-02</span></a>
          </li>
          <li>
            <a href="./runbook.html#post-incident-actions"><span>Post incident actions</span></a>
          </li>
          <li>
            <a href="./runbook.html#maptiler-started-returning-403-errors-2023-08-16"><span>maptiler started returning 403 errors - 2023-08-16</span></a>
          </li>
          <li>
            <a href="./runbook.html#aws-alarms-raised-for-datasette-and-datasette-tiles-canaries-2023-08-14"><span>aws alarms raised for datasette and datasette-tiles canaries - 2023-08-14</span></a>
          </li>
          <li>
            <a href="./runbook.html#documentation-section-on-planning-data-gov-uk-showing-error-2023-06-12"><span>Documentation section on planning.data.gov.uk showing error - 2023-06-12</span></a>
          </li>
          <li>
            <a href="./runbook.html#slowness-reported-on-planning-data-gov-uk-2023-06-01"><span>Slowness reported on planning.data.gov.uk - 2023-06-01</span></a>
          </li>
          <li>
            <a href="./runbook.html#getting-error-500-on-planning-data-gov-uk-2023-04-11"><span>Getting error 500 on planning.data.gov.uk - 2023-04-11</span></a>
          </li>
          <li>
            <a href="./runbook.html#all-applications-on-planning-data-gov-uk-2022-11-22"><span>All applications on planning.data.gov.uk - 2022-11-22</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <a href="./WorkingWithLPA_GIS.html"><span>Working with LPA GIS Systems</span></a>
    <ul>
      <li>
        <a href="./WorkingWithLPA_GIS.html#core-concepts"><span>Core Concepts</span></a>
      </li>
      <li>
        <a href="./WorkingWithLPA_GIS.html#terminology"><span>Terminology</span></a>
      </li>
      <li>
        <a href="./WorkingWithLPA_GIS.html#get-the-servers-cabilities"><span>Get the servers cabilities</span></a>
        <ul>
          <li>
            <a href="./WorkingWithLPA_GIS.html#interesting-useful-items-in-a-servers-capabilties"><span>Interesting / useful items in a servers capabilties</span></a>
          </li>
          <li>
            <a href="./WorkingWithLPA_GIS.html#getting-info-about-a-feature-type"><span>Getting info about a Feature Type</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="./WorkingWithLPA_GIS.html#getting-some-map-data-for-a-feature-type"><span>Getting some map data for a Feature Type</span></a>
      </li>
      <li>
        <a href="./WorkingWithLPA_GIS.html#useful-links"><span>Useful links</span></a>
      </li>
    </ul>
  </li>
  <li>
    <a href="./HowTos.html"><span>How-to Guides</span></a>
    <ul>
      <li>
        <a href="./HowTos.html#python-versions-on-wsl2"><span>Python versions on WSL2</span></a>
        <ul>
          <li>
            <a href="./HowTos.html#using-python-3-8"><span>Using Python 3.8</span></a>
          </li>
          <li>
            <a href="./HowTos.html#using-a-later-version-too"><span>Using a later version too</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled" aria-label="Content" tabindex="0">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
            <h1 id="infrastructure">Infrastructure</h1>
<p>The planning data <a href="https://github.com/digital-land/digital-land-infrastructure">infrastructure repository</a> contains
terraform configuration files that create the necessary services to deploy applications and background tasks for the
planning data system.</p>
<h2 id="overview">Overview</h2>
<p>There are two repositories that handle our infrastructure:</p>

<ul>
<li><a href="https://github.com/digital-land/digital-land-infrastructure">Digital Land Infrastructure</a> - this contains our primary infrastructure and allows the user to interact all environments and is what the instructions in this guide aim to help with.</li>
<li><a href="https://github.com/digital-land/global-digital-land-infrastructure">Global Digital Land Infrastructure</a> - this mainly contains infrastructure that needs to lie outside of the other repo such as nameserver records to subdomains as well as lagacy infrustructure such as s3 buckets who&rsquo;s content is stored in glacier</li>
</ul>
<h3 id="planning-data-platform-deployment-diagram">Planning Data Platform - Deployment Diagram</h3>
<p><a href="images/planning-data-platform-deployment.drawio.png" rel="noopener noreferrer"><img src="images/planning-data-platform-deployment.drawio.png" alt="Planning Data Platform Deployment" /></a></p>
<h3 id="data-collection-pipeline-deployment-diagram">Data Collection Pipeline - Deployment Diagram</h3>
<p>Coming soon</p>
<h3 id="publish-service-deployment-diagram">Publish Service - Deployment Diagram</h3>
<p>Coming soon</p>
<h2 id="deploying">Deploying</h2>
<h4 id="authentication">Authentication</h4>
<p><a href="https://github.com/99designs/aws-vault">aws-vault</a> is recommended to assume the correct role for deploying resources to
the AWS environments. This guide does not cover the correct configuration of aws-vault.</p>
<p>Once configured correctly all the following commands can be executed as follows.</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code>aws-vault <span class="nb">exec</span> &lt;profile&gt; <span class="nt">--</span> &lt;<span class="nb">command</span><span class="o">&gt;</span>
</code></pre></div><h3 id="an-existing-environment">An Existing Environment</h3>
<p>To deploy updates to an existing environment first, clone the
<a href="https://github.com/digital-land/digital-land-infrastructure">infrastructure repository</a>
<code>git clone git@github.com:digital-land/digital-land-infrastructure.git</code>.</p>
<p>Once cloned, run <code>make apply STAGE=&lt;environment&gt;</code> to deploy the updated infrastructure configuration.</p>
<h3 id="a-new-environment">A New Environment</h3>
<p>To deploy a new environment the following details are needed:</p>

<ul>
<li>Environment name</li>
<li>Root domain name</li>
</ul>
<p>First, clone the <a href="https://github.com/digital-land/digital-land-infrastructure">infrastructure repository</a>
<code>git clone git@github.com:digital-land/digital-land-infrastructure.git</code>.</p>
<p>Once cloned, run <code>make new-environment STAGE=&lt;environment&gt; DOMAIN=&lt;root domain&gt;</code> to create the needed configuration
files. Commit the created files to the repository.</p>
<p>Run <code>make apply STAGE=&lt;environment&gt;</code> to deploy the new environment, do not worry about errors, this will fail the first
time you deploy a new environment. There should be roughly 500 new resources created to action the deployment.</p>
<p>On completion of the first deployment run you will see errors regarding the verification of SSL certificates created for
the environment.</p>
<p><strong>First <code>terraform apply</code> output</strong></p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code>│ Error: error creating CloudFront Distribution: InvalidViewerCertificate: The specified SSL certificate doesn<span class="s1">'t exist, isn'</span>t <span class="k">in </span>us-east-1 region, isn<span class="s1">'t valid, or doesn'</span>t include a valid certificate chain.
│       status code: 400, request <span class="nb">id</span>: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
│
│   with module.application_main.aws_cloudfront_distribution.cdn,
│   on modules/application/application_traffic.tf line 28, <span class="k">in </span>resource <span class="s2">"aws_cloudfront_distribution"</span> <span class="s2">"cdn"</span>:
│   28: resource <span class="s2">"aws_cloudfront_distribution"</span> <span class="s2">"cdn"</span> <span class="o">{</span>
│
</code></pre></div><p>To resolve this error we must configure the DNS provider for the root domain to use these nameservers, and then run the
deployment for the environment a second time. To obtain the DNS nameservers, first log into the AWS console
(<code>aws-vault login &lt;profile&gt;</code>), then access Route53 &gt; Hosted Zones &gt; [domain] and get the four values for the NS record,
configuring these servers with the domain&rsquo;s DNS provider.</p>
<p>This can be done by using the global digital land infrastructure to create the required record.</p>
<p>Once DNS delegation is complete, you may check that the SSL certificate has been generated by logging into AWS for the
appropriate account and checking the ACM service in the us-east-1 region. The relevant certificate will show as verified
once delegation is complete.</p>
<p>You can now run <code>make apply STAGE=&lt;environment&gt;</code> for the second time and should see changes to the CDN and Route53
resources. The new infrastructure is now set up, and all that remains is to deploy applications into the new
environment. At this point all applications will serve a page stating that the service will shortly be resumed.</p>
<p><strong>Note:</strong> The following slack bot token parameters required to be update manaully in the aws Parameter Store (SSM). 
The slack bot token <code>(dl-github-actions)</code> values are the same across all envirnments and can be obtains from other environment notification slack token or from Slack direct.</p>

<ul>
<li><code>/&lt;environment&gt;-datasette-tiles/notifications/slack-token</code></li>
<li><code>/&lt;environment&gt;-datasette/notifications/slack-token</code></li>
<li><code>/&lt;environment&gt;-main/notifications/slack-token</code></li>
<li><code>/&lt;environment&gt;-status/notifications/slack-token</code></li>
</ul>
<h4 id="deploying-data">Deploying data</h4>
<p>In order for the applications to start and run we must have data in the platform. Firstly we need both background tasks
deployed to the environment prior to uploading data for processing.</p>
<p>Deploy the following applications using the dispatch workflow</p>

<ul>
<li><a href="https://github.com/digital-land/tiles-builder/actions/workflows/deploy-task.yml">datasette-tiles (task)</a>
A background task that builds <a href="https://github.com/mapbox/mbtiles-spec">MBTiles</a> files for use in the datasette-tiles
application.</li>
<li><a href="https://github.com/digital-land/digital-land-postgres/actions/workflows/deploy.yml">postgres-importer</a>
A background task that imports the digital-land.sqlite3 in a postgres database.</li>
</ul>
<p>Once both applications are deployed we can now copy data into the environment. Data generally enters the environment via
upload as part of a <a href="https://github.com/digital-land?q=-collection">collection job</a> or via the
<a href="https://github.com/digital-land/entity-builder">entity-builder</a> and
<a href="https://github.com/digital-land/digital-land-builder">digital-land-builder</a> jobs.</p>
<p>While these data pipelines run on a regular basis you may need to start with a set of data from another environment in
order to successfully deploy the various applications needed to run the system. The AWS command line application has a
command to make this easier. Run with <code>--dryrun</code> to preview the files to be synced (though the output is not useful).</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code>aws s3 <span class="nb">sync </span>s3://[source]-collection-data s3://[destination]-collection-data
</code></pre></div><p><strong>Note:</strong> It may be worth deployed the main application once before deploying data and once after as the database schema is applied when the application is</p>
<h4 id="deploying-applications">Deploying applications</h4>
<p>Now the new environment is up and running you should deploy the following applications:</p>

<ul>
<li><a href="https://github.com/digital-land/digital-land.info/actions/workflows/continuous-deployment.yml">main</a>
The main digital land web application.</li>
<li><a href="https://github.com/digital-land/datasette-builder/actions/workflows/deploy.yml">datasette</a>
A web service and API allowing SQL queries against sqlite databases.</li>
<li><a href="https://github.com/digital-land/tiles-builder/actions/workflows/deploy-application.yml">datasette-tiles (application)</a>
A web service that allows the main application&rsquo;s frontend to draw vector tiles on the map feature from our datasets.</li>
<li><a href="https://github.com/digital-land/digital-land-status/actions/workflows/deploy.yml">digital-land-status</a>
A simple web page which show the digital land dependencies status.</li>
</ul>
<p><strong>Note:</strong> data may need to be re-deployed to the postgres db once the application has been deployed due to the build failing if no data is found but the database schema only being deployed when the app is</p>
<h3 id="lambda-functions">Lambda functions</h3>

<ul>
<li>EFS Sync collection</li>
<li>Slack Notification </li>
</ul>
<p>The creation of the actual aws lambda functions are still in the <a href="https://github.com/digital-land/digital-land-infrastructure">infrastructure repo</a>, but the function code are now located in this repo <code>https://github.com/digital-land/digital-land-lambda</code>.</p>
<p><strong>GitHub deployment workflow (Lambda functions)</strong></p>
<div class="highlight"><pre class="highlight yaml" tabindex="0"><code><span class="na">name</span><span class="pi">:</span> <span class="s">Deploy</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="na">push</span><span class="pi">:</span>
    <span class="na">branches</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">main</span><span class="pi">]</span>
  <span class="na">workflow_dispatch</span><span class="pi">:</span>
    <span class="na">inputs</span><span class="pi">:</span>
      <span class="na">environment</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">environment</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">The environment to deploy to.</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">detect-environments</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">outputs</span><span class="pi">:</span>
      <span class="na">environments</span><span class="pi">:</span> <span class="s">${{ steps.environments.outputs.result }}</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/github-script@v6</span>
        <span class="na">id</span><span class="pi">:</span> <span class="s">environments</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">github-token</span><span class="pi">:</span> <span class="s">${{ secrets.GITHUB_TOKEN }}</span>
          <span class="na">result-encoding</span><span class="pi">:</span> <span class="s">json</span>
          <span class="na">script</span><span class="pi">:</span> <span class="pi">|</span>
            <span class="s">if (context.payload?.inputs?.environment) return [context.payload?.inputs?.environment];</span>
            <span class="s">const {data: {environments}} = </span>
              <span class="s">await github.request(`GET /repos/${process.env.GITHUB_REPOSITORY}/environments`);</span>
            <span class="s">return environments.map(e =&gt; e.name)</span>

  <span class="na">deploy</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">needs</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">detect-environments</span><span class="pi">]</span>
    <span class="na">strategy</span><span class="pi">:</span>
      <span class="na">matrix</span><span class="pi">:</span>
        <span class="na">environment</span><span class="pi">:</span> <span class="s">${{ fromJSON(needs.detect-environments.outputs.environments) }}</span>
    <span class="na">environment</span><span class="pi">:</span> <span class="s">${{ matrix.environment }}</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v3</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install aws cli</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"</span>
          <span class="s">unzip -q awscliv2.zip</span>
          <span class="s">sudo ./aws/install --update</span>
          <span class="s">sudo apt-get update</span>
          <span class="s">sudo apt-get install -y rsync</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Build efs sync collection</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">rm -rf node_modules/</span>
          <span class="s">docker build -t efs-sync-collection-lambda-builder ./efs-sync-collection</span>
          <span class="s">docker run -i -v ${GITHUB_WORKSPACE}/efs-sync-collection:/var/task efs-sync-collection-lambda-builder</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Build Notification functions</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">rm -rf node_modules/</span>
          <span class="s">docker build -t ${{ matrix.environment }}-notification-builder ./notification-code</span>
          <span class="s">docker run -i -v ${GITHUB_WORKSPACE}/notification-code:/var/task ${{ matrix.environment }}-notification-builder</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Set File Permissions</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">chmod 0666 ./efs-sync-collection</span>
          <span class="s">chmod 0666 ./notification-code</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Create efs sync Archive</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">sudo -s sh -c 'cd efs-sync-collection &amp;&amp; zip -r ../efs-sync-collection.zip ./*'</span>
          <span class="s">sudo -s sh -c  'pwd'</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Upload efs sync artifact for deployment job</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/upload-artifact@v3</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">efs-sync-collection</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">efs-sync-collection.zip</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Create Notification Archive</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">sudo -s sh -c 'cd notification-code &amp;&amp; zip -r ../notification-code.zip ./*'</span>
          <span class="s">sudo -s sh -c  'pwd'</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Upload Notification artifact for deployment job</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/upload-artifact@v3</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">name</span><span class="pi">:</span> <span class="s">notification-code</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">notification-code.zip</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Set up AWS credentials</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">aws-actions/configure-aws-credentials@v1-node16</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">aws-access-key-id</span><span class="pi">:</span> <span class="s">${{ secrets.DEPLOY_AWS_ACCESS_KEY_ID }}</span>
          <span class="na">aws-secret-access-key</span><span class="pi">:</span> <span class="s">${{ secrets.DEPLOY_AWS_SECRET_ACCESS_KEY }}</span>
          <span class="na">aws-region</span><span class="pi">:</span> <span class="s">eu-west-2</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Deploy aws Lambda functions</span>
        <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">aws lambda update-function-code --function-name ${{ matrix.environment }}-efs-sync-collection --zip-file fileb://./efs-sync-collection.zip</span>
          <span class="s">aws lambda update-function-code --function-name ${{ matrix.environment }}-main-slack-notifier --zip-file fileb://./notification-code.zip</span>
          <span class="s">aws lambda update-function-code --function-name ${{ matrix.environment }}-status-slack-notifier --zip-file fileb://./notification-code.zip</span>
          <span class="s">aws lambda update-function-code --function-name ${{ matrix.environment }}-datasette-tiles-slack-notifier --zip-file fileb://./notification-code.zip</span>
          <span class="s">aws lambda update-function-code --function-name ${{ matrix.environment }}-datasette-slack-notifier --zip-file fileb://./notification-code.zip</span>
</code></pre></div><h2 id="configuration-changes">Configuration Changes</h2>
<h3 id="add-a-new-application">Add a new application</h3>
<p>To create a new application in the terraform configuration, you will need to know the following:</p>

<ul>
<li>The <strong>GitHub repository</strong> (under the <a href="https://github.com/digital-land">digital-land</a> organisation) hosting the application code.</li>
<li>The <strong>subdomain</strong> of <code>planning.data.gov.uk</code> that the application will run under.</li>
<li>An estimate of the <strong>memory usage</strong> of the application.</li>
<li>A list of the application <strong>environment variables</strong>.</li>
<li>If the application needs access to the SQLite or MBTiles files generated by background tasks.</li>
</ul>
<p>Add a new section to <code>variables.tf</code> under <code>locals.application_defaults</code>, replacing attributes as required.</p>
<div class="highlight"><pre class="highlight hcl" tabindex="0"><code><span class="err">&lt;</span><span class="nx">name</span><span class="err">&gt;</span> <span class="err">=</span> <span class="p">{</span>
  <span class="c1">// The subdomain to serve the application from</span>
  <span class="nx">access</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">domain</span> <span class="p">=</span> <span class="s2">"&lt;subdomain&gt;"</span>
  <span class="p">}</span>

  <span class="c1">// Any static environment variables</span>
  <span class="nx">environment</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">PORT</span> <span class="p">=</span> <span class="mi">5000</span> <span class="c1">// Defaults to 80</span>
  <span class="p">}</span>

  <span class="c1">// The GitHub repository that hosts the application code</span>
  <span class="nx">github_repository</span> <span class="p">=</span> <span class="s2">"&lt;organisation&gt;/&lt;repository&gt;"</span>

  <span class="c1">// Set to true if the GitHub repository contains both an</span>
  <span class="c1">// application and a background task.</span>
  <span class="nx">github_repository_dual</span> <span class="p">=</span> <span class="kc">false</span>

  <span class="c1">// The application healthcheck path and timeout</span>
  <span class="nx">healthcheck</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">endpoint</span> <span class="p">=</span> <span class="s2">"/"</span>
    <span class="nx">timeout</span> <span class="p">=</span> <span class="s2">"30"</span>
  <span class="p">}</span>

  <span class="c1">// Minimum and maximum number of application instances</span>
  <span class="c1">// The auto-scaling configuration scales the initial</span>
  <span class="c1">// number on 60% CPU Utilisation</span>
  <span class="nx">instances</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">minimum</span> <span class="p">=</span> <span class="mi">1</span>
    <span class="nx">maximum</span> <span class="p">=</span> <span class="mi">2</span>
    <span class="nx">initial</span> <span class="p">=</span> <span class="mi">1</span>
  <span class="p">}</span>

  <span class="c1">// The resources needed per application instance</span>
  <span class="nx">resources</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">memory</span>      <span class="p">=</span> <span class="mi">1024</span>
    <span class="nx">cpu_credits</span> <span class="p">=</span> <span class="mi">20</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>Add a new application block in <code>main_apps.tf</code>, replacing attributes as required.</li>
</ul>
<div class="highlight"><pre class="highlight hcl" tabindex="0"><code><span class="nx">module</span> <span class="s2">"application_&lt;name&gt;"</span> <span class="p">{</span>
  <span class="nx">source</span> <span class="p">=</span> <span class="s2">"./modules/application"</span>

  <span class="c1">// Application name</span>
  <span class="nx">name</span>                   <span class="p">=</span> <span class="s2">"&lt;name&gt;"</span>

  <span class="c1">// The environment this application is deployed to (do not change)</span>
  <span class="nx">stage</span>                  <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">stage</span>

  <span class="c1">// All resources created by this module with have their names</span>
  <span class="c1">// prefixed with the string here.</span>
  <span class="nx">resource_prefix</span>        <span class="p">=</span> <span class="s2">"${var.stage}-&lt;name&gt;"</span>

  <span class="c1">// The ECS cluster this application is deployed to</span>
  <span class="nx">cluster</span>                <span class="p">=</span> <span class="nx">module</span><span class="err">.</span><span class="nx">cluster</span><span class="err">.</span><span class="nx">cluster</span>
  <span class="c1">// Tags associated with</span>
  <span class="nx">tags</span>                   <span class="p">=</span> <span class="nx">module</span><span class="err">.</span><span class="nx">tags</span><span class="err">.</span><span class="nx">computed</span>
  <span class="c1">// The environment variables to expose to the application</span>
  <span class="nx">environment</span>            <span class="p">=</span> <span class="nx">merge</span><span class="err">(</span>
    <span class="nx">module</span><span class="err">.</span><span class="nx">storage</span><span class="err">.</span><span class="nx">environment</span><span class="err">,</span>
    <span class="nx">local</span><span class="err">.</span><span class="nx">applications</span><span class="p">[</span><span class="s2">"&lt;name&gt;"</span><span class="p">]</span><span class="err">.</span><span class="nx">environment</span><span class="err">,</span>
  <span class="err">)</span>
  <span class="c1">// The stored secrets to inject into the application environment</span>
  <span class="nx">secrets</span>                <span class="p">=</span> <span class="nx">module</span><span class="err">.</span><span class="nx">storage</span><span class="err">.</span><span class="nx">secrets</span>
  <span class="c1">// var.deployment_approval set to a list of users will enforce approvals</span>
  <span class="c1">//   to deploy to this environment</span>
  <span class="nx">deployment_approval</span>    <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">deployment_approval</span>

  <span class="c1">// These are set via the `locals.application_defaults` section in `variables.tf`</span>
  <span class="nx">github_repository</span>      <span class="p">=</span> <span class="nx">local</span><span class="err">.</span><span class="nx">applications</span><span class="p">[</span><span class="s2">"&lt;name&gt;"</span><span class="p">]</span><span class="err">.</span><span class="nx">github_repository</span>
  <span class="nx">github_repository_dual</span> <span class="p">=</span> <span class="nx">local</span><span class="err">.</span><span class="nx">applications</span><span class="p">[</span><span class="s2">"&lt;name&gt;"</span><span class="p">]</span><span class="err">.</span><span class="nx">github_repository_dual</span>
  <span class="nx">healthcheck</span>            <span class="p">=</span> <span class="nx">local</span><span class="err">.</span><span class="nx">applications</span><span class="p">[</span><span class="s2">"&lt;name&gt;"</span><span class="p">]</span><span class="err">.</span><span class="nx">healthcheck</span>
  <span class="nx">instances</span>              <span class="p">=</span> <span class="nx">local</span><span class="err">.</span><span class="nx">applications</span><span class="p">[</span><span class="s2">"&lt;name&gt;"</span><span class="p">]</span><span class="err">.</span><span class="nx">instances</span>
  <span class="nx">resources</span>              <span class="p">=</span> <span class="nx">local</span><span class="err">.</span><span class="nx">applications</span><span class="p">[</span><span class="s2">"&lt;name&gt;"</span><span class="p">]</span><span class="err">.</span><span class="nx">resources</span>
  <span class="nx">access</span>                 <span class="p">=</span> <span class="nx">merge</span><span class="err">(</span>
    <span class="nx">local</span><span class="err">.</span><span class="nx">applications</span><span class="p">[</span><span class="s2">"&lt;name&gt;"</span><span class="p">]</span><span class="err">.</span><span class="nx">access</span><span class="err">,</span>
    <span class="p">{</span>
      <span class="nx">certificate_arn</span> <span class="p">=</span> <span class="nx">module</span><span class="err">.</span><span class="nx">domain</span><span class="err">.</span><span class="nx">certificate_arn</span>
      <span class="nx">zone_id</span>         <span class="p">=</span> <span class="nx">module</span><span class="err">.</span><span class="nx">domain</span><span class="err">.</span><span class="nx">zone_id</span>
    <span class="p">}</span>
  <span class="err">)</span>

  <span class="c1">// EFS volumes to mount for this application</span>
  <span class="c1">//   (must set network mode to awsvpc)</span>
  <span class="nx">volumes</span>                <span class="p">=</span> <span class="p">{</span>
    <span class="nx">datasets</span> <span class="p">=</span> <span class="nx">merge</span><span class="err">(</span>
      <span class="nx">module</span><span class="err">.</span><span class="nx">storage</span><span class="err">.</span><span class="nx">files</span><span class="err">.</span><span class="nx">datasets</span><span class="err">,</span>
      <span class="c1">// Add this if you wish the volume to be mounted read-only</span>
      <span class="p">{</span>
          <span class="nx">readonly</span> <span class="p">=</span> <span class="kc">true</span>
      <span class="p">}</span>
    <span class="err">)</span>
  <span class="p">}</span>

  <span class="c1">// Additional IAM permissions, see `outputs.tf` in `modules/storage`</span>
  <span class="c1">//   for a list of permissions</span>
  <span class="nx">additional_permissions</span> <span class="p">=</span> <span class="nx">merge</span><span class="err">(</span><span class="nx">module</span><span class="err">.</span><span class="nx">storage</span><span class="err">.</span><span class="nx">permissions</span><span class="err">.</span><span class="nx">efs_read</span><span class="err">)</span>

  <span class="nx">network</span> <span class="p">=</span> <span class="p">{</span>
    <span class="c1">// Set to awsvpc if you need to mount a volume, bridge otherwise</span>
    <span class="nx">mode</span>            <span class="p">=</span> <span class="s2">"awsvpc"</span>
    <span class="nx">vpc_id</span>          <span class="p">=</span> <span class="nx">module</span><span class="err">.</span><span class="nx">network</span><span class="err">.</span><span class="nx">vpc_id</span>
    <span class="nx">subnets</span>         <span class="p">=</span> <span class="nx">module</span><span class="err">.</span><span class="nx">network</span><span class="err">.</span><span class="nx">subnet_public_ids</span>
    <span class="nx">security_groups</span> <span class="p">=</span> <span class="p">[</span><span class="nx">module</span><span class="err">.</span><span class="nx">network</span><span class="err">.</span><span class="nx">security_group_public_id</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>Run terraform apply</li>
<li>Check that the service is running on the appropriate domain name, if it is you will see a holding page.</li>
<li>Update the slackbot token at <code>/&lt;environment&gt;-&lt;application&gt;/notifications/slack-token</code> in AWS SSM</li>
<li>If configured with a GitHub repository add a deployment workflow to the repo,
otherwise you need only authenticate using the details under <code>/&lt;environment&gt;-&lt;name&gt;/deployer/access_*</code>
and push a built docker image to the</li>
</ul>
<p><strong>GitHub deployment workflow (Application Only)</strong></p>
<div class="highlight"><pre class="highlight yaml" tabindex="0"><code><span class="na">name</span><span class="pi">:</span> <span class="s">Deploy</span>
<span class="na">on</span><span class="pi">:</span>
  <span class="na">push</span><span class="pi">:</span>
    <span class="na">branches</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">main</span><span class="pi">]</span>
  <span class="na">workflow_dispatch</span><span class="pi">:</span>
    <span class="na">inputs</span><span class="pi">:</span>
      <span class="na">environment</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">environment</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">The environment to deploy to.</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="c1"># Include any tests or audits in jobs prior to detect-environments.</span>
  <span class="na">detect-environments</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">needs</span><span class="pi">:</span> <span class="pi">[]</span> <span class="c1"># Add any previous jobs here</span>
    <span class="na">outputs</span><span class="pi">:</span>
      <span class="na">environments</span><span class="pi">:</span> <span class="s">${{ steps.environments.outputs.result }}</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/github-script@v6</span>
        <span class="na">id</span><span class="pi">:</span> <span class="s">environments</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">github-token</span><span class="pi">:</span> <span class="s">${{ secrets.GITHUB_TOKEN }}</span>
          <span class="na">result-encoding</span><span class="pi">:</span> <span class="s">json</span>
          <span class="na">script</span><span class="pi">:</span> <span class="pi">|</span>
            <span class="s">if (context.payload?.inputs?.environment) return [context.payload?.inputs?.environment];</span>
            <span class="s">const {data: {environments}} =</span>
              <span class="s">await github.request(`GET /repos/${process.env.GITHUB_REPOSITORY}/environments`);</span>
            <span class="s">return environments.map(e =&gt; e.name)</span>

  <span class="na">deploy</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">env</span><span class="pi">:</span>
      <span class="na">DOCKER_REPO</span><span class="pi">:</span> <span class="s">${{ secrets.DEPLOY_DOCKER_REPOSITORY }}</span>
    <span class="na">needs</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">detect-environments</span><span class="pi">]</span>
    <span class="na">strategy</span><span class="pi">:</span>
      <span class="na">matrix</span><span class="pi">:</span>
        <span class="na">environment</span><span class="pi">:</span> <span class="s">${{ fromJSON(needs.detect-environments.outputs.environments) }}</span>
    <span class="na">environment</span><span class="pi">:</span> <span class="s">${{ matrix.environment }}</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v3</span>
      <span class="pi">-</span> <span class="na">id</span><span class="pi">:</span> <span class="s">vars</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">echo "sha_short=$(git rev-parse --short HEAD)" &gt;&gt; $GITHUB_OUTPUT</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">sudo apt-get update</span>
          <span class="s">sudo apt-get install -y rsync</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">aws-actions/configure-aws-credentials@v1-node16</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">aws-access-key-id</span><span class="pi">:</span> <span class="s">${{ secrets.DEPLOY_AWS_ACCESS_KEY_ID }}</span>
          <span class="na">aws-secret-access-key</span><span class="pi">:</span> <span class="s">${{ secrets.DEPLOY_AWS_SECRET_ACCESS_KEY }}</span>
          <span class="na">aws-region</span><span class="pi">:</span> <span class="s">eu-west-2</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">aws-actions/amazon-ecr-login@v1</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker pull $DOCKER_REPO:latest</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker build -t $DOCKER_REPO:${{ steps.vars.outputs.sha_short }} .</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker tag $DOCKER_REPO:${{ steps.vars.outputs.sha_short }} $DOCKER_REPO:latest</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker push $DOCKER_REPO:${{ steps.vars.outputs.sha_short }}</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker push $DOCKER_REPO:latest</span>
</code></pre></div><h3 id="add-a-new-background-task">Add a new background task</h3>
<p>To create a new background task in the terraform configuration, you will need to know the following:</p>

<ul>
<li>The <strong>GitHub repository</strong> (under the <a href="https://github.com/digital-land">digital-land</a> organisation) hosting the task code.</li>
<li>A list of events that should trigger a background task run (currently only s3 events are supported).</li>
<li>An estimate of the <strong>memory usage</strong> of the task.</li>
<li>A list of the task <strong>environment variables</strong>.</li>
<li>If the task needs access to the SQLite or MBTiles files.</li>
</ul>
<p>Add a new section to <code>variables.tf</code> under <code>locals.task_defaults</code>, replacing attributes as required.</p>
<div class="highlight"><pre class="highlight hcl" tabindex="0"><code><span class="err">&lt;</span><span class="nx">name</span><span class="err">&gt;</span> <span class="err">=</span> <span class="p">{</span>
  <span class="c1">// The GitHub repository that hosts the background task code</span>
  <span class="nx">github_repository</span> <span class="p">=</span> <span class="s2">"&lt;organisation&gt;/&lt;repository&gt;"</span>

  <span class="c1">// Set to true if the GitHub repository contains both a</span>
  <span class="c1">// background task and an application.</span>
  <span class="nx">github_repository_dual</span> <span class="p">=</span> <span class="kc">false</span>

  <span class="c1">// The resources needed per background task invocation</span>
  <span class="nx">resources</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">memory</span>      <span class="p">=</span> <span class="mi">8192</span>
    <span class="nx">cpu_credits</span> <span class="p">=</span> <span class="mi">1024</span>
  <span class="p">}</span>

  <span class="c1">// A map of the events that should trigger this task</span>
  <span class="nx">triggers</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">entity</span><span class="err">-</span><span class="nx">uploaded</span> <span class="p">=</span> <span class="p">{</span>
      <span class="c1">// The events that trigger the task</span>
      <span class="nx">events</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"PutObject"</span><span class="p">,</span> <span class="s2">"CompleteMultipartUpload"</span><span class="p">]</span>
      <span class="c1">// The S3 bucket to watch for events</span>
      <span class="nx">bucket</span> <span class="p">=</span> <span class="s2">"${var.stage}-collection-data"</span>
      <span class="c1">// The keys of S3 objects to watch for</span>
      <span class="nx">watch</span>  <span class="p">=</span> <span class="p">[</span><span class="s2">"/entity-builder/dataset/entity.sqlite3"</span><span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>Add a new task block in <code>main_tasks.tf</code>, replacing attributes as required.</li>
</ul>
<div class="highlight"><pre class="highlight hcl" tabindex="0"><code><span class="nx">module</span> <span class="s2">"task_&lt;name&gt;"</span> <span class="p">{</span>
  <span class="nx">source</span> <span class="p">=</span> <span class="s2">"./modules/application-task"</span>

  <span class="c1">// Application name</span>
  <span class="nx">name</span>                   <span class="p">=</span> <span class="s2">"&lt;name&gt;"</span>

  <span class="c1">// The environment this task is deployed to (do not change)</span>
  <span class="nx">stage</span>                  <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">stage</span>

  <span class="c1">// All resources created by this module with have their names</span>
  <span class="c1">// prefixed with the string here.</span>
  <span class="nx">resource_prefix</span>        <span class="p">=</span> <span class="s2">"${var.stage}-&lt;name&gt;"</span>

  <span class="c1">// The ECS cluster this task is deployed to</span>
  <span class="nx">cluster</span>                <span class="p">=</span> <span class="nx">module</span><span class="err">.</span><span class="nx">cluster</span><span class="err">.</span><span class="nx">cluster</span>
  <span class="c1">// Tags associated with</span>
  <span class="nx">tags</span>                   <span class="p">=</span> <span class="nx">module</span><span class="err">.</span><span class="nx">tags</span><span class="err">.</span><span class="nx">computed</span>
  <span class="c1">// The environment variables to expose to the task</span>
  <span class="nx">environment</span>            <span class="p">=</span> <span class="nx">merge</span><span class="err">(</span>
    <span class="nx">module</span><span class="err">.</span><span class="nx">storage</span><span class="err">.</span><span class="nx">environment</span><span class="err">,</span>
    <span class="nx">local</span><span class="err">.</span><span class="nx">tasks</span><span class="p">[</span><span class="s2">"&lt;name&gt;"</span><span class="p">]</span><span class="err">.</span><span class="nx">environment</span><span class="err">,</span>
  <span class="err">)</span>
  <span class="c1">// The stored secrets to inject into the task environment</span>
  <span class="nx">secrets</span>                <span class="p">=</span> <span class="nx">module</span><span class="err">.</span><span class="nx">storage</span><span class="err">.</span><span class="nx">secrets</span>
  <span class="c1">// var.deployment_approval set to a list of users will enforce approvals</span>
  <span class="c1">//   to deploy to this environment</span>
  <span class="nx">deployment_approval</span>    <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">deployment_approval</span>

  <span class="c1">// These are set via the `locals.task_defaults` section in `variables.tf`</span>
  <span class="nx">github_repository</span>      <span class="p">=</span> <span class="nx">local</span><span class="err">.</span><span class="nx">tasks</span><span class="p">[</span><span class="s2">"&lt;name&gt;"</span><span class="p">]</span><span class="err">.</span><span class="nx">github_repository</span>
  <span class="nx">github_repository_dual</span> <span class="p">=</span> <span class="nx">local</span><span class="err">.</span><span class="nx">tasks</span><span class="p">[</span><span class="s2">"&lt;name&gt;"</span><span class="p">]</span><span class="err">.</span><span class="nx">github_repository_dual</span>
  <span class="nx">triggers</span>               <span class="p">=</span> <span class="nx">local</span><span class="err">.</span><span class="nx">tasks</span><span class="p">[</span><span class="s2">"&lt;name&gt;"</span><span class="p">]</span><span class="err">.</span><span class="nx">triggers</span>
  <span class="nx">instances</span>              <span class="p">=</span> <span class="nx">local</span><span class="err">.</span><span class="nx">tasks</span><span class="p">[</span><span class="s2">"&lt;name&gt;"</span><span class="p">]</span><span class="err">.</span><span class="nx">instances</span>
  <span class="nx">resources</span>              <span class="p">=</span> <span class="nx">local</span><span class="err">.</span><span class="nx">tasks</span><span class="p">[</span><span class="s2">"&lt;name&gt;"</span><span class="p">]</span><span class="err">.</span><span class="nx">resources</span>

  <span class="c1">// EFS volumes to mount for this task</span>
  <span class="nx">volumes</span>                <span class="p">=</span> <span class="p">{</span>
    <span class="nx">datasets</span> <span class="p">=</span> <span class="nx">merge</span><span class="err">(</span>
      <span class="nx">module</span><span class="err">.</span><span class="nx">storage</span><span class="err">.</span><span class="nx">files</span><span class="err">.</span><span class="nx">datasets</span><span class="err">,</span>
      <span class="c1">// Add this if you wish the volume to be mounted read-only</span>
      <span class="p">{</span>
          <span class="nx">readonly</span> <span class="p">=</span> <span class="kc">true</span>
      <span class="p">}</span>
    <span class="err">)</span>
  <span class="p">}</span>

  <span class="c1">// Additional IAM permissions, see `outputs.tf` in `modules/storage`</span>
  <span class="c1">//   for a list of permissions</span>
  <span class="nx">additional_permissions</span> <span class="p">=</span> <span class="nx">merge</span><span class="err">(</span><span class="nx">module</span><span class="err">.</span><span class="nx">storage</span><span class="err">.</span><span class="nx">permissions</span><span class="err">.</span><span class="nx">efs_read</span><span class="err">)</span>

  <span class="nx">network</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">vpc_id</span>          <span class="p">=</span> <span class="nx">module</span><span class="err">.</span><span class="nx">network</span><span class="err">.</span><span class="nx">vpc_id</span>
    <span class="nx">subnets</span>         <span class="p">=</span> <span class="nx">module</span><span class="err">.</span><span class="nx">network</span><span class="err">.</span><span class="nx">subnet_public_ids</span>
    <span class="nx">security_groups</span> <span class="p">=</span> <span class="p">[</span><span class="nx">module</span><span class="err">.</span><span class="nx">network</span><span class="err">.</span><span class="nx">security_group_public_id</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>Run terraform apply</li>
<li>If configured with a GitHub repository add a deployment workflow to the repo,
otherwise you need only authenticate using the details under <code>/&lt;environment&gt;-&lt;name&gt;/deployer/access_*</code>
and push a built docker image to the</li>
</ul>
<p><strong>GitHub deployment workflow (Task Only)</strong></p>
<div class="highlight"><pre class="highlight yaml" tabindex="0"><code><span class="na">name</span><span class="pi">:</span> <span class="s">Deploy</span>
<span class="na">on</span><span class="pi">:</span>
  <span class="na">push</span><span class="pi">:</span>
    <span class="na">branches</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">main</span><span class="pi">]</span>
  <span class="na">workflow_dispatch</span><span class="pi">:</span>
    <span class="na">inputs</span><span class="pi">:</span>
      <span class="na">environment</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">environment</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">The environment to deploy to.</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">detect-environments</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">outputs</span><span class="pi">:</span>
      <span class="na">environments</span><span class="pi">:</span> <span class="s">${{ steps.environments.outputs.result }}</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/github-script@v6</span>
        <span class="na">id</span><span class="pi">:</span> <span class="s">environments</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">github-token</span><span class="pi">:</span> <span class="s">${{ secrets.GITHUB_TOKEN }}</span>
          <span class="na">result-encoding</span><span class="pi">:</span> <span class="s">json</span>
          <span class="na">script</span><span class="pi">:</span> <span class="pi">|</span>
            <span class="s">if (context.payload?.inputs?.environment) return [context.payload?.inputs?.environment];</span>
            <span class="s">const {data: {environments}} =</span>
              <span class="s">await github.request(`GET /repos/${process.env.GITHUB_REPOSITORY}/environments`);</span>
            <span class="s">return environments.map(e =&gt; e.name)</span>

  <span class="na">deploy</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">env</span><span class="pi">:</span>
      <span class="na">DOCKER_REPO</span><span class="pi">:</span> <span class="s">${{ secrets.DEPLOY_DOCKER_REPOSITORY }}</span>
    <span class="na">needs</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">detect-environments</span><span class="pi">]</span>
    <span class="na">strategy</span><span class="pi">:</span>
      <span class="na">matrix</span><span class="pi">:</span>
        <span class="na">environment</span><span class="pi">:</span> <span class="s">${{ fromJSON(needs.detect-environments.outputs.environments) }}</span>
    <span class="na">environment</span><span class="pi">:</span> <span class="s">${{ matrix.environment }}</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v3</span>
      <span class="pi">-</span> <span class="na">id</span><span class="pi">:</span> <span class="s">vars</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">echo "sha_short=$(git rev-parse --short HEAD)" &gt;&gt; $GITHUB_OUTPUT</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">sudo apt-get update</span>
          <span class="s">sudo apt-get install -y rsync</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">aws-actions/configure-aws-credentials@v1-node16</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">aws-access-key-id</span><span class="pi">:</span> <span class="s">${{ secrets.DEPLOY_AWS_ACCESS_KEY_ID }}</span>
          <span class="na">aws-secret-access-key</span><span class="pi">:</span> <span class="s">${{ secrets.DEPLOY_AWS_SECRET_ACCESS_KEY }}</span>
          <span class="na">aws-region</span><span class="pi">:</span> <span class="s">eu-west-2</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">aws-actions/amazon-ecr-login@v1</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker pull $DOCKER_REPO:latest</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker build -t $DOCKER_REPO:${{ steps.vars.outputs.sha_short }} .</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker tag $DOCKER_REPO:${{ steps.vars.outputs.sha_short }} $DOCKER_REPO:latest</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker push $DOCKER_REPO:${{ steps.vars.outputs.sha_short }}</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker push $DOCKER_REPO:latest</span>
</code></pre></div><h4 id="deploy-a-task-and-application">Deploy a Task and Application</h4>
<p>To deploy both a task and application from the same repository, use the following two github actions workflows.</p>
<p><strong><code>.github/workflows/deploy-application.yml</code></strong></p>
<div class="highlight"><pre class="highlight yaml" tabindex="0"><code><span class="na">name</span><span class="pi">:</span> <span class="s">Deploy Application</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="na">push</span><span class="pi">:</span>
    <span class="na">branches</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">main</span><span class="pi">]</span>
    <span class="c1"># Put a path here for the folder to watch for changes</span>
    <span class="na">paths</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">application/</span><span class="pi">]</span>
  <span class="na">workflow_dispatch</span><span class="pi">:</span>
    <span class="na">inputs</span><span class="pi">:</span>
      <span class="na">environment</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">environment</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">The environment to deploy to (select an -application environment).</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">detect-environments</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">outputs</span><span class="pi">:</span>
      <span class="na">environments</span><span class="pi">:</span> <span class="s">${{ steps.environments.outputs.result }}</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/github-script@v6</span>
        <span class="na">id</span><span class="pi">:</span> <span class="s">environments</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">github-token</span><span class="pi">:</span> <span class="s">${{ secrets.GITHUB_TOKEN }}</span>
          <span class="na">result-encoding</span><span class="pi">:</span> <span class="s">json</span>
          <span class="na">script</span><span class="pi">:</span> <span class="pi">|</span>
            <span class="s">if (context.payload?.inputs?.environment) return [context.payload?.inputs?.environment];</span>
            <span class="s">const {data: {environments}} =</span>
              <span class="s">await github.request(`GET /repos/${process.env.GITHUB_REPOSITORY}/environments`);</span>
            <span class="s">return environments.map(e =&gt; e.name).filter(e =&gt; e.indexOf('-application') != -1)</span>

  <span class="na">deploy</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">env</span><span class="pi">:</span>
      <span class="na">DOCKER_REPO</span><span class="pi">:</span> <span class="s">${{ secrets.DEPLOY_DOCKER_REPOSITORY }}</span>
    <span class="na">needs</span><span class="pi">:</span> <span class="pi">[</span> <span class="nv">detect-environments</span> <span class="pi">]</span>
    <span class="na">strategy</span><span class="pi">:</span>
      <span class="na">matrix</span><span class="pi">:</span>
        <span class="na">environment</span><span class="pi">:</span> <span class="s">${{ fromJSON(needs.detect-environments.outputs.environments) }}</span>
    <span class="na">environment</span><span class="pi">:</span> <span class="s">${{ matrix.environment }}</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v3</span>

      <span class="pi">-</span> <span class="na">id</span><span class="pi">:</span> <span class="s">vars</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">echo "sha_short=$(git rev-parse --short HEAD)" &gt;&gt; $GITHUB_OUTPUT</span>

      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"</span>
          <span class="s">unzip -q awscliv2.zip</span>
          <span class="s">sudo ./aws/install --update</span>
          <span class="s">sudo apt-get update</span>
          <span class="s">sudo apt-get install -y rsync</span>

      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">aws-actions/configure-aws-credentials@v1-node16</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">aws-access-key-id</span><span class="pi">:</span> <span class="s">${{ secrets.DEPLOY_AWS_ACCESS_KEY_ID }}</span>
          <span class="na">aws-secret-access-key</span><span class="pi">:</span> <span class="s">${{ secrets.DEPLOY_AWS_SECRET_ACCESS_KEY }}</span>
          <span class="na">aws-region</span><span class="pi">:</span> <span class="s">eu-west-2</span>

      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">aws-actions/amazon-ecr-login@v1</span>

      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker pull $DOCKER_REPO:latest || echo "no current latest image"</span>

      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker build -t $DOCKER_REPO:${{ steps.vars.outputs.sha_short }} .</span>
        <span class="na">working-directory</span><span class="pi">:</span> <span class="s">./application</span>

      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker tag $DOCKER_REPO:${{ steps.vars.outputs.sha_short }} $DOCKER_REPO:latest</span>

      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker push $DOCKER_REPO:${{ steps.vars.outputs.sha_short }}</span>

      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker push $DOCKER_REPO:latest</span>
</code></pre></div><p><strong><code>.github/workflows/deploy-task.yml</code></strong></p>
<div class="highlight"><pre class="highlight yaml" tabindex="0"><code><span class="na">name</span><span class="pi">:</span> <span class="s">Deploy Task</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="na">push</span><span class="pi">:</span>
    <span class="na">branches</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">main</span><span class="pi">]</span>
    <span class="c1"># Put a path here for the folder to watch for changes</span>
    <span class="na">paths</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">task/</span><span class="pi">]</span>
  <span class="na">workflow_dispatch</span><span class="pi">:</span>
    <span class="na">inputs</span><span class="pi">:</span>
      <span class="na">environment</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">environment</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">The environment to deploy to (select an -application environment).</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">detect-environments</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">outputs</span><span class="pi">:</span>
      <span class="na">environments</span><span class="pi">:</span> <span class="s">${{ steps.environments.outputs.result }}</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/github-script@v6</span>
        <span class="na">id</span><span class="pi">:</span> <span class="s">environments</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">github-token</span><span class="pi">:</span> <span class="s">${{ secrets.GITHUB_TOKEN }}</span>
          <span class="na">result-encoding</span><span class="pi">:</span> <span class="s">json</span>
          <span class="na">script</span><span class="pi">:</span> <span class="pi">|</span>
            <span class="s">if (context.payload?.inputs?.environment) return [context.payload?.inputs?.environment];</span>
            <span class="s">const {data: {environments}} =</span>
              <span class="s">await github.request(`GET /repos/${process.env.GITHUB_REPOSITORY}/environments`);</span>
            <span class="s">return environments.map(e =&gt; e.name).filter(e =&gt; e.indexOf('-application') != -1)</span>

  <span class="na">deploy</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">env</span><span class="pi">:</span>
      <span class="na">DOCKER_REPO</span><span class="pi">:</span> <span class="s">${{ secrets.DEPLOY_DOCKER_REPOSITORY }}</span>
    <span class="na">needs</span><span class="pi">:</span> <span class="pi">[</span> <span class="nv">detect-environments</span> <span class="pi">]</span>
    <span class="na">strategy</span><span class="pi">:</span>
      <span class="na">matrix</span><span class="pi">:</span>
        <span class="na">environment</span><span class="pi">:</span> <span class="s">${{ fromJSON(needs.detect-environments.outputs.environments) }}</span>
    <span class="na">environment</span><span class="pi">:</span> <span class="s">${{ matrix.environment }}</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v3</span>

      <span class="pi">-</span> <span class="na">id</span><span class="pi">:</span> <span class="s">vars</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">echo "sha_short=$(git rev-parse --short HEAD)" &gt;&gt; $GITHUB_OUTPUT</span>

      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"</span>
          <span class="s">unzip -q awscliv2.zip</span>
          <span class="s">sudo ./aws/install --update</span>
          <span class="s">sudo apt-get update</span>
          <span class="s">sudo apt-get install -y rsync</span>

      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">aws-actions/configure-aws-credentials@v1-node16</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">aws-access-key-id</span><span class="pi">:</span> <span class="s">${{ secrets.DEPLOY_AWS_ACCESS_KEY_ID }}</span>
          <span class="na">aws-secret-access-key</span><span class="pi">:</span> <span class="s">${{ secrets.DEPLOY_AWS_SECRET_ACCESS_KEY }}</span>
          <span class="na">aws-region</span><span class="pi">:</span> <span class="s">eu-west-2</span>

      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">aws-actions/amazon-ecr-login@v1</span>

      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker pull $DOCKER_REPO:latest || echo "no current latest image"</span>

      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker build -t $DOCKER_REPO:${{ steps.vars.outputs.sha_short }} .</span>
        <span class="na">working-directory</span><span class="pi">:</span> <span class="s">./task</span>

      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker tag $DOCKER_REPO:${{ steps.vars.outputs.sha_short }} $DOCKER_REPO:latest</span>

      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker push $DOCKER_REPO:${{ steps.vars.outputs.sha_short }}</span>

      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker push $DOCKER_REPO:latest</span>
</code></pre></div><h3 id="rds-autoscaling">RDS autoscaling</h3>
<p>RDS database autoscaling is now enabled in all aws environments. The autoscaling_min_capacity &amp; autoscaling_max_capacity are 
configure in the <code>.config.&lt;env&gt;.tfvars</code> terraform config file.</p>
<p>The below config will create at least one writer and one reader node instance. A maximum of 3 additional reader node will be created 
based on the autoscaling policy which default set to 70% CPUUtilization.</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>resources = {
  database = {
    count                        = 2
    class                        = "db.t4g.large"
    autoscaling_enabled          = true
    autoscaling_min              = 0
    autoscaling_max              = 3
    performance_insights_enabled = true
  }
</code></pre></div><h3 id="synthetics-canaries">Synthetics Canaries</h3>
<p>There are 4 canaries created in each aws environment. <code>datasette</code> , <code>datasette-tiles</code>, <code>status</code>, <code>www</code></p>
<p>These are healthchecks to ensure the defined endpoints are returning status code within the range of <code>200 - 299</code>, otherwise it will raised an aws alarm.</p>
<p>The canary template is written in node.js</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>const { URL } = require('url');
const synthetics = require('Synthetics');
const log = require('SyntheticsLogger');
const syntheticsConfiguration = synthetics.getConfiguration();
const syntheticsLogHelper = require('SyntheticsLogHelper');
const { hostname } = require('os');

const loadBlueprint = async function () {

    // Set screenshot option
    let takeScreenshot = ('${enablescreenshot}' === 'true')
    /* Disabling default step screen shots taken during Synthetics.executeStep() calls
     * Step will be used to publish metrics on time taken to load dom content but
     * Screenshots will be taken outside the executeStep to allow for page to completely load with domcontentloaded
     * You can change it to load, networkidle0, networkidle2 depending on what works best for you.
     */
    syntheticsConfiguration.disableStepScreenshots();
    syntheticsConfiguration.setConfig({
       continueOnStepFailure: true,
       includeRequestHeaders: true, // Enable if headers should be displayed in HAR
       includeResponseHeaders: true, // Enable if headers should be displayed in HAR
       restrictedHeaders: [], // Value of these headers will be redacted from logs and reports
       restrictedUrlParameters: [] // Values of these url parameters will be redacted from logs and reports

    });

    let page = await synthetics.getPage();

    let hostnames = [];
    if ('${appname}' == "www") {
        hostnames = ['https://${hostname}','https://${hostname}/dataset','https://${hostname}/entity','https://${hostname}/map','https://${hostname}/docs','https://${hostname}/entity.json?limit=10','https://${hostname}/dataset.json'];
        takeScreenshot = false;
    } else {
        hostnames = ['https://${hostname}'];
    }

    for (const url of hostnames) {
        await loadUrl(page, url, takeScreenshot);
    }
};

// Reset the page in-between
const resetPage = async function(page) {
    try {
        await page.goto('about:blank',{waitUntil: ['load', 'networkidle0'], timeout: 30000} );
    } catch (e) {
        synthetics.addExecutionError('Unable to open a blank page. ', e);
    }
}

const loadUrl = async function (page, url, takeScreenshot) {
    let stepName = null;
    let domcontentloaded = false;

    try {
        if (url.includes("/entity.json?limit=10")) {
            stepName = "Entity API Check";
        }
        else if (url.includes("/dataset.json")){
            stepName = "Dataset API Check";
        }
        else {
            stepName = url;
        }
    } catch (e) {
        const errorString = 'Error parsing url:' + url + e;
        log.error(errorString);
        /* If we fail to parse the URL, don't emit a metric with a stepName based on it.
           It may not be a legal CloudWatch metric dimension name and we may not have an alarms
           setup on the malformed URL stepName.  Instead, fail this step which will
           show up in the logs and will fail the overall canary and alarm on the overall canary
           success rate.
        */
        throw e;
    }

    await synthetics.executeStep(stepName, async function () {
        const sanitizedUrl = syntheticsLogHelper.getSanitizedUrl(url);

        /* You can customize the wait condition here. For instance, using 'networkidle2' or 'networkidle0' to load page completely.
           networkidle0: Navigation is successful when the page has had no network requests for half a second. This might never happen if page is constantly loading multiple resources.
           networkidle2: Navigation is successful when the page has no more then 2 network requests for half a second.
           domcontentloaded: It's fired as soon as the page DOM has been loaded, without waiting for resources to finish loading. Can be used and then add explicit await page.waitFor(timeInMs)
        */
        const response = await page.goto(url, { waitUntil: ['domcontentloaded'], timeout: 30000});
        if (response) {
            domcontentloaded = true;
            const status = response.status();
            const statusText = response.statusText();

            logResponseString = 'Response from url:' + sanitizedUrl +  'Status:' + status + 'Status Text:' + statusText;

            //If the response status code is not a 2xx success code
            if (response.status() &lt; 200 || response.status() &gt; 299) {
                throw new Error('Failed to load url: ' + sanitizedUrl);
            }
        } else {
            const logNoResponseString = 'No response returned for url: ' + sanitizedUrl;
            log.error(logNoResponseString);
            throw new Error(logNoResponseString);
        }
    });

    // Wait for 15 seconds to let page load fully before taking screenshot.
    if (domcontentloaded &amp;&amp; takeScreenshot) {
        await page.waitFor(15000);
        await synthetics.takeScreenshot(stepName, 'loaded');
        await resetPage(page);
    }
};

let hostnames = [];

exports.handler = async () =&gt; {
    return await loadBlueprint();
};
</code></pre></div><p>aws alarm status</p>

<ul>
<li>OK - The metric or expression is within the defined threshold.</li>
<li>ALARM - The metric or expression is outside of the defined threshold.</li>
</ul>
<p>The canary alarm condition is currently set to <code>SuccessPercent &lt; 100 for 2 datapoints within 10 minutes</code></p>

            
          </main>

          <aside>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">


      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="javascripts/application.js"></script>
  </body>
</html>

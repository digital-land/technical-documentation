<!doctype html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>Infrastructure - Planning Data</title>

    <link href="stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="digital-land.github.io/infrastructure.html">

      <meta name="robots" content="noindex" />
      <meta name="twitter:card" content="summary" />
      <meta name="twitter:image" content="digital-land.github.io/images/govuk-large.png" />
      <meta name="twitter:title" content="Infrastructure - Planning Data" />
      <meta name="twitter:url" content="digital-land.github.io/infrastructure.html" />

      <meta property="og:image" content="digital-land.github.io/images/govuk-large.png" />
      <meta property="og:site_name" content="Planning Data" />
      <meta property="og:title" content="Infrastructure" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="digital-land.github.io/infrastructure.html" />

    
  </head>

  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link" data-module="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="https://planning.data.gov.uk" class="govuk-header__link govuk-header__link--homepage">
        <span class="govuk-header__product-name">
          Planning Data
        </span>
      </a>
        <strong class="govuk-tag">Beta</strong>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <button type="button" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </button>
        </div>

      <div class="app-pane__body" data-module="in-page-navigation">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents" tabindex="-1" aria-label="Table of contents" role="dialog">
              <div class="search" data-module="search" data-path-to-site-root="./">
  <form action="https://www.google.co.uk/search" method="get" role="search" class="search__form govuk-!-margin-bottom-4">
    <input type="hidden" name="as_sitesearch" value="digital-land.github.io"/>
    <label class="govuk-label search__label" for="search" aria-hidden="true">
      Search (via Google)
    </label>
    <input
      type="text"
      id="search" name="q"
      class="govuk-input govuk-!-margin-bottom-0 search__input"
      aria-controls="search-results"
      placeholder="Search">
    <button type="submit" class="search__button">Search</button>
  </form>
</div>

              <button type="button" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></button>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading" data-module="collapsible-navigation">
                      <ul>
  <li>
    <a href="./index.html"><span>Planning Data Service</span></a>
  </li>
  <li>
    <a href="./runbook.html"><span>Run Book</span></a>
    <ul>
      <li>
        <a href="./runbook.html#outage-procedure"><span>Outage Procedure</span></a>
      </li>
      <li>
        <a href="./runbook.html#common-issues"><span>Common Issues</span></a>
      </li>
      <li>
        <a href="./runbook.html#incident-response-history"><span>Incident Response History</span></a>
      </li>
    </ul>
  </li>
  <li>
    <a href="./infrastructure.html"><span>Infrastructure</span></a>
    <ul>
      <li>
        <a href="./infrastructure.html#overview"><span>Overview</span></a>
      </li>
      <li>
        <a href="./infrastructure.html#deploying"><span>Deploying</span></a>
        <ul>
          <li>
          </li>
          <li>
            <a href="./infrastructure.html#an-existing-environment"><span>An Existing Environment</span></a>
          </li>
          <li>
            <a href="./infrastructure.html#a-new-environment"><span>A New Environment</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="./infrastructure.html#configuration-changes"><span>Configuration Changes</span></a>
        <ul>
          <li>
            <a href="./infrastructure.html#add-a-new-application"><span>Add a new application</span></a>
          </li>
          <li>
            <a href="./infrastructure.html#add-a-new-background-task"><span>Add a new background task</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
            <h1 id="infrastructure">Infrastructure</h1>
<p>The planning data <a href="https://github.com/digital-land/digital-land-infrastructure">infrastructure repository</a> contains
terraform configuration files that create the necessary services to deploy applications and background tasks for the
planning data system.</p>
<h2 id="overview">Overview</h2>
<p><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="586px" preserveAspectRatio="none" style="width:1092px;height:586px;background:#FFFFFF;" version="1.1" viewBox="0 0 1092 586" width="1092px" zoomAndPan="magnify"><defs/><g><g id="elem_user_data_provider"><rect fill="#08427B" height="135.5156" rx="2.5" ry="2.5" style="stroke:#073B6F;stroke-width:0.5;" width="191" x="7" y="232"/><image height="48" width="48" x="78.5" xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAIAAADYYG7QAAACD0lEQVR4Xu2YoU4EMRCGT+4j8Ai8AhaH4QHgAUjQuFMECUgMIUgwJAgMhgQsAYUiJCiQIBBY+EITsjfTdme6V24v4c8vyGbb+ZjOtN0bNcvjQXmkH83WvYBWto6PLm6v7p7uH1/w2fXD+PBycX1Pv2l3IdDm/vn7x+dXQiAubRzoURa7gRZWd0iGRIiJbOnhnfYBQZNJjNbuyY2eJG8fkDE3bbG4ep6MHUAsgYxmE3nVs6VsBWJSGccsOlFPmLIViMzLOB7pCVO2AtHJMohH7Fh6zqitQK7m0rJvAVYgGcEpe//PLdDz65sM4pF9N7ICcXDKIB5Nv6j7tD0NoSdM2QrU9Gg0ewE1LqBhHR3BBdvj2vapnidjHxD/q6vd7Pvhr31AwcY8eXMTXAKECZZJFXuEq27aLgQK5uLMohCenGGuGewOxSjBvYBqeG6B+Nqiblggdjnc+ZXDy+FNFpFzw76O3UBAROuXh6FoiAcf5g9eTvUgzy0nWg6I8cXHRUpg5bOVBCo+KDpFajOf23GgPme7RSQ+lacIENUgJ6gg1k6HjgOlqnLqip4tEuhv0hNEMXUD0clyXE3p6pZA0S2nnvTlXwLJEZWlb7cTQH1+USgTN4VhAenm/wea1OCAOmqo6fE1WCb9WSKBah+rbUWPWAmE2Rvk0ApiB45eOyNAzU8xcTvj8KvkKEoOaIYeHNA3ZuygAvFMUO0AAAAASUVORK5CYII=" y="242"/><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" textLength="122" x="41.5" y="304.8516">Data Provider</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="100.5" y="321.6201"> </text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="163" x="21" y="337.917">Prepares and publishes</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="34" x="85.5" y="354.2139">data.</text></g><g id="elem_user_planner"><rect fill="#08427B" height="135.5156" rx="2.5" ry="2.5" style="stroke:#073B6F;stroke-width:0.5;" width="177" x="777" y="7"/><image height="48" width="48" x="841.5" xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAIAAADYYG7QAAACD0lEQVR4Xu2YoU4EMRCGT+4j8Ai8AhaH4QHgAUjQuFMECUgMIUgwJAgMhgQsAYUiJCiQIBBY+EITsjfTdme6V24v4c8vyGbb+ZjOtN0bNcvjQXmkH83WvYBWto6PLm6v7p7uH1/w2fXD+PBycX1Pv2l3IdDm/vn7x+dXQiAubRzoURa7gRZWd0iGRIiJbOnhnfYBQZNJjNbuyY2eJG8fkDE3bbG4ep6MHUAsgYxmE3nVs6VsBWJSGccsOlFPmLIViMzLOB7pCVO2AtHJMohH7Fh6zqitQK7m0rJvAVYgGcEpe//PLdDz65sM4pF9N7ICcXDKIB5Nv6j7tD0NoSdM2QrU9Gg0ewE1LqBhHR3BBdvj2vapnidjHxD/q6vd7Pvhr31AwcY8eXMTXAKECZZJFXuEq27aLgQK5uLMohCenGGuGewOxSjBvYBqeG6B+Nqiblggdjnc+ZXDy+FNFpFzw76O3UBAROuXh6FoiAcf5g9eTvUgzy0nWg6I8cXHRUpg5bOVBCo+KDpFajOf23GgPme7RSQ+lacIENUgJ6gg1k6HjgOlqnLqip4tEuhv0hNEMXUD0clyXE3p6pZA0S2nnvTlXwLJEZWlb7cTQH1+USgTN4VhAenm/wea1OCAOmqo6fE1WCb9WSKBah+rbUWPWAmE2Rvk0ApiB45eOyNAzU8xcTvj8KvkKEoOaIYeHNA3ZuygAvFMUO0AAAAASUVORK5CYII=" y="17"/><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" textLength="67" x="832" y="79.8516">Planner</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="863.5" y="96.6201"> </text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="149" x="791" y="112.917">Browses the available</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="64" x="833.5" y="129.2139">datasets.</text></g><g id="elem_app_data_provider"><rect fill="#999999" height="87.5156" rx="2.5" ry="2.5" style="stroke:#8A8A8A;stroke-width:0.5;" width="162" x="21.5" y="469.5"/><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" textLength="88" x="58.5" y="494.3516">Data Host</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="100.5" y="511.1201"> </text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="134" x="35.5" y="527.417">Hosts data provider</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="72.5" y="543.7139">datasets</text></g><g id="elem_pipeline_collection"><path d="M330.5,458.5 L510.5,458.5 C515.5,458.5 515.5,513.5547 515.5,513.5547 C515.5,513.5547 515.5,568.6094 510.5,568.6094 L330.5,568.6094 C325.5,568.6094 325.5,513.5547 325.5,513.5547 C325.5,513.5547 325.5,458.5 330.5,458.5 " fill="#1168BD" style="stroke:#3C7FC0;stroke-width:0.5;"/><path d="M510.5,458.5 C505.5,458.5 505.5,513.5547 505.5,513.5547 C505.5,568.6094 510.5,568.6094 510.5,568.6094 " fill="none" style="stroke:#3C7FC0;stroke-width:0.5;"/><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" textLength="160" x="335.5" y="478.3516">Collection Pipeline</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="413.5" y="495.1201"> </text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="124" x="353.5" y="511.417">Collects data from</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="165" x="331" y="527.7139">publishers, checking for</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="166" x="330.5" y="544.0107">errors and merging data</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="101" x="365" y="560.3076">before storing.</text></g><g id="elem_app_main"><rect fill="#1168BD" height="103.8125" rx="2.5" ry="2.5" style="stroke:#3C7FC0;stroke-width:0.5;" width="217" x="637" y="248"/><a href="https://www.planning.data.gov.uk" target="_top" title="https://www.planning.data.gov.uk" xlink:actuate="onRequest" xlink:href="https://www.planning.data.gov.uk" xlink:show="new" xlink:title="https://www.planning.data.gov.uk" xlink:type="simple"><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" text-decoration="underline" textLength="96" x="697.5" y="272.8516">Application</text></a><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="743.5" y="289.6201"> </text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="189" x="651" y="305.917">Main application presenting</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="165" x="661" y="322.2139">data to users in multiple</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="717.5" y="338.5107">formats.</text></g><g id="elem_app_datasette_tiles"><rect fill="#1168BD" height="103.8125" rx="2.5" ry="2.5" style="stroke:#3C7FC0;stroke-width:0.5;" width="197" x="889" y="248"/><a href="https://datasette-tiles.planning.data.gov.uk" target="_top" title="https://datasette-tiles.planning.data.gov.uk" xlink:actuate="onRequest" xlink:href="https://datasette-tiles.planning.data.gov.uk" xlink:show="new" xlink:title="https://datasette-tiles.planning.data.gov.uk" xlink:type="simple"><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" text-decoration="underline" textLength="109" x="933" y="272.8516">Map Tile API</text></a><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="985.5" y="289.6201"> </text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="158" x="908.5" y="305.917">Map tile server, serving</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="167" x="902" y="322.2139">vectors for use the main</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="177" x="899" y="338.5107">application user interface.</text></g><g id="elem_app_datasette"><rect fill="#1168BD" height="103.8125" rx="2.5" ry="2.5" style="stroke:#3C7FC0;stroke-width:0.5;" width="212" x="284.5" y="248"/><a href="https://datasette.planning.data.gov.uk" target="_top" title="https://datasette.planning.data.gov.uk" xlink:actuate="onRequest" xlink:href="https://datasette.planning.data.gov.uk" xlink:show="new" xlink:title="https://datasette.planning.data.gov.uk" xlink:type="simple"><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" text-decoration="underline" textLength="77" x="352" y="272.8516">Data API</text></a><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="388.5" y="289.6201"> </text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="184" x="298.5" y="305.917">Data server, responding to</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="182" x="297.5" y="322.2139">SQL queries from the main</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="78" x="351.5" y="338.5107">application.</text></g><g id="elem_data_static_files"><path d="M636.5,467 C636.5,457 745.5,457 745.5,457 C745.5,457 854.5,457 854.5,467 L854.5,559.8125 C854.5,569.8125 745.5,569.8125 745.5,569.8125 C745.5,569.8125 636.5,569.8125 636.5,559.8125 L636.5,467 " fill="#1168BD" style="stroke:#3C7FC0;stroke-width:0.5;"/><path d="M636.5,467 C636.5,477 745.5,477 745.5,477 C745.5,477 854.5,477 854.5,467 " fill="none" style="stroke:#3C7FC0;stroke-width:0.5;"/><a href="https://files.planning.data.gov.uk" target="_top" title="https://files.planning.data.gov.uk" xlink:actuate="onRequest" xlink:href="https://files.planning.data.gov.uk" xlink:show="new" xlink:title="https://files.planning.data.gov.uk" xlink:type="simple"><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" text-decoration="underline" textLength="142" x="674.5" y="495.8516">Archive Storage</text></a><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="743.5" y="512.6201"> </text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="190" x="650.5" y="528.917">Stores data from publishers</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="182" x="652.5" y="545.2139">making it available for sync</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="159" x="666" y="561.5107">with other applications.</text></g><g id="link_user_data_provider_app_data_provider"><path d="M102.5,368.21 C102.5,398.38 102.5,433.39 102.5,461.37 " fill="none" id="user_data_provider-to-app_data_provider" style="stroke:#666666;stroke-width:1.0;"/><polygon fill="#666666" points="102.5,469.44,105.5,461.44,99.5,461.44,102.5,469.44" style="stroke:#666666;stroke-width:1.0;"/><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="107" x="103.5" y="417.1387">Publishes Data</text></g><g id="link_app_data_provider_pipeline_collection"><path d="M191.79,513.5 C233.46,513.5 283.1,513.5 325.46,513.5 " fill="none" id="app_data_provider-backto-pipeline_collection" style="stroke:#666666;stroke-width:1.0;"/><polygon fill="#666666" points="183.57,513.5,191.57,516.5,191.57,510.5,183.57,513.5" style="stroke:#666666;stroke-width:1.0;"/><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="105" x="202" y="493.6387">Retrieves Data</text><text fill="#666666" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="48" x="230.5" y="507.6074">[HTTPS]</text></g><g id="link_pipeline_collection_data_static_files"><path d="M515.81,513.5 C550.99,513.5 591.26,513.5 628.16,513.5 " fill="none" id="pipeline_collection-to-data_static_files" style="stroke:#666666;stroke-width:1.0;"/><polygon fill="#666666" points="636.47,513.5,628.47,510.5,628.47,516.5,636.47,513.5" style="stroke:#666666;stroke-width:1.0;"/><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="84" x="534" y="493.6387">Stores data</text><text fill="#666666" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="48" x="552" y="507.6074">[HTTPS]</text></g><g id="link_app_datasette_data_static_files"><path d="M483.37,356.33 C535.42,387.34 600.15,425.91 652.26,456.95 " fill="none" id="app_datasette-backto-data_static_files" style="stroke:#666666;stroke-width:1.0;"/><polygon fill="#666666" points="476.44,352.2,481.7831,358.8672,484.8495,353.71,476.44,352.2" style="stroke:#666666;stroke-width:1.0;"/><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="117" x="600.5" y="410.1387">Sync SQLite files</text><text fill="#666666" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="60" x="629" y="424.1074">[Lambda]</text></g><g id="link_app_datasette_tiles_data_static_files"><path d="M929.49,357.58 C906.27,379.69 879.01,404.97 853.5,427 C842.1,436.84 829.76,447.02 817.65,456.77 " fill="none" id="app_datasette_tiles-backto-data_static_files" style="stroke:#666666;stroke-width:1.0;"/><polygon fill="#666666" points="935.31,352.03,927.4492,355.3777,931.5887,359.721,935.31,352.03" style="stroke:#666666;stroke-width:1.0;"/><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="128" x="884.5" y="410.1387">Sync map tile files</text><text fill="#666666" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="66" x="915.5" y="424.1074">[ECS Task]</text></g><g id="link_app_main_data_static_files"><path d="M745.5,360.55 C745.5,390.79 745.5,427.3 745.5,456.95 " fill="none" id="app_main-backto-data_static_files" style="stroke:#666666;stroke-width:1.0;"/><polygon fill="#666666" points="745.5,352.2,742.5,360.2,748.5,360.2,745.5,352.2" style="stroke:#666666;stroke-width:1.0;"/><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="98" x="746.5" y="410.1387">Sync live data</text><text fill="#666666" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="66" x="762.5" y="424.1074">[ECS Task]</text></g><g id="link_app_datasette_app_main"><path d="M504.66,300 C547.07,300 595.04,300 636.94,300 " fill="none" id="app_datasette-backto-app_main" style="stroke:#666666;stroke-width:1.0;"/><polygon fill="#666666" points="496.53,300,504.53,303,504.53,297,496.53,300" style="stroke:#666666;stroke-width:1.0;"/><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="104" x="514.75" y="280.1387">Requests data</text><text fill="#666666" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="48" x="542.75" y="294.1074">[HTTPS]</text></g><g id="link_user_planner_app_main"><path d="M829.33,143.21 C812.59,174.32 792.9,210.91 776.81,240.82 " fill="none" id="user_planner-to-app_main" style="stroke:#666666;stroke-width:1.0;"/><polygon fill="#666666" points="773.01,247.88,779.449,242.264,774.1685,239.4149,773.01,247.88" style="stroke:#666666;stroke-width:1.0;"/><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="99" x="813.5" y="185.1387">Browses Data</text><text fill="#666666" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="48" x="839" y="199.1074">[HTTPS]</text></g><g id="link_user_planner_app_datasette_tiles"><path d="M904.72,143.11 C910.42,153.09 916.16,163.29 921.5,173 C933.59,194.96 946.47,219.32 957.61,240.73 " fill="none" id="user_planner-to-app_datasette_tiles" style="stroke:#666666;stroke-width:1.0;"/><polygon fill="#666666" points="961.32,247.86,960.2967,239.3775,954.9715,242.1419,961.32,247.86" style="stroke:#666666;stroke-width:1.0;"/><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="113" x="936.5" y="185.1387">Views Map Tiles</text><text fill="#666666" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="48" x="969" y="199.1074">[HTTPS]</text></g></g></svg></p>
<h2 id="deploying">Deploying</h2>
<h4 id="authentication">Authentication</h4>
<p><a href="https://github.com/99designs/aws-vault">aws-vault</a> is recommended to assume the correct role for deploying resources to
the AWS environments. This guide does not cover the correct configuration of aws-vault.</p>
<p>Once configured correctly all the following commands can be executed as follows.</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code>aws-vault <span class="nb">exec</span> &lt;profile&gt; <span class="nt">--</span> &lt;<span class="nb">command</span><span class="o">&gt;</span>
</code></pre></div><h3 id="an-existing-environment">An Existing Environment</h3>
<p>To deploy updates to an existing environment first, clone the
<a href="https://github.com/digital-land/digital-land-infrastructure">infrastructure repository</a>
<code>git clone git@github.com:digital-land/digital-land-infrastructure.git</code>.</p>
<p>Once cloned, run <code>make apply STAGE=&lt;environment&gt;</code> to deploy the updated infrastructure configuration.</p>
<h3 id="a-new-environment">A New Environment</h3>
<p>To deploy a new environment the following details are needed:</p>

<ul>
<li>Environment name</li>
<li>Root domain name</li>
</ul>
<p>First, clone the <a href="https://github.com/digital-land/digital-land-infrastructure">infrastructure repository</a>
<code>git clone git@github.com:digital-land/digital-land-infrastructure.git</code>.</p>
<p>Once cloned, run <code>make new-environment STAGE=&lt;environment&gt; DOMAIN=&lt;root domain&gt;</code> to create the needed configuration
files. Commit the created files to the repository.</p>
<p>Run <code>make apply STAGE=&lt;environment&gt;</code> to deploy the new environment, do not worry about errors, this will fail the first
time you deploy a new environment. There should be roughly 500 new resources created to action the deployment.</p>
<p>On completion of the first deployment run you will see errors regarding the verification of SSL certificates created for
the environment.</p>
<p><strong>First <code>terraform apply</code> output</strong></p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code>│ Error: error creating CloudFront Distribution: InvalidViewerCertificate: The specified SSL certificate doesn<span class="s1">'t exist, isn'</span>t <span class="k">in </span>us-east-1 region, isn<span class="s1">'t valid, or doesn'</span>t include a valid certificate chain.
│       status code: 400, request <span class="nb">id</span>: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
│
│   with module.application_main.aws_cloudfront_distribution.cdn,
│   on modules/application/application_traffic.tf line 28, <span class="k">in </span>resource <span class="s2">"aws_cloudfront_distribution"</span> <span class="s2">"cdn"</span>:
│   28: resource <span class="s2">"aws_cloudfront_distribution"</span> <span class="s2">"cdn"</span> <span class="o">{</span>
│
</code></pre></div><p>To resolve this error we must configure the DNS provider for the root domain to use these nameservers, and then run the
deployment for the environment a second time. To obtain the DNS nameservers, first log into the AWS console
(<code>aws-vault login &lt;profile&gt;</code>), then access Route53 &gt; Hosted Zones &gt; [domain] and get the four values for the NS record,
configuring these servers with the domain&rsquo;s DNS provider.</p>
<p>Once DNS delegation is complete, you may check that the SSL certificate has been generated by logging into AWS for the
appropriate account and checking the ACM service in the us-east-1 region. The relevant certificate will show as verified
once delegation is complete.</p>
<p>You can now run <code>make apply STAGE=&lt;environment&gt;</code> for the second time and should see changes to the CDN and Route53
resources. The new infrastructure is now set up, and all that remains is to deploy applications into the new
environment. At this point all applications will serve a page stating that the service will shortly be resumed.</p>
<h4 id="deploying-data">Deploying data</h4>
<p>In order for the applications to start and run we must have data in the platform. Firstly we need both background tasks
deployed to the environment prior to uploading data for processing.</p>
<p>Deploy the following applications using the dispatch workflow</p>

<ul>
<li><a href="https://github.com/digital-land/tiles-builder/actions/workflows/deploy-task.yml">datasette-tiles (task)</a>
A background task that builds <a href="https://github.com/mapbox/mbtiles-spec">MBTiles</a> files for use in the datasette-tiles
application.</li>
<li><a href="https://github.com/digital-land/digital-land-postgres/actions/workflows/deploy.yml">postgres-importer</a>
A background task that imports the digital-land.sqlite3 in a postgres database.</li>
</ul>
<p>Once both applications are deployed we can now copy data into the environment. Data generally enters the environment via
upload as part of a <a href="https://github.com/digital-land?q=-collection">collection job</a> or via the
<a href="https://github.com/digital-land/entity-builder">entity-builder</a> and
<a href="https://github.com/digital-land/digital-land-builder">digital-land-builder</a> jobs.</p>
<p>While these data pipelines run on a regular basis you may need to start with a set of data from another environment in
order to successfully deploy the various applications needed to run the system. The AWS command line application has a
command to make this easier. Run with <code>--dryrun</code> to preview the files to be synced (though the output is not useful).</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code>aws s3 <span class="nb">sync </span>s3://[source]-collection-data s3://[destination]-collection-data
</code></pre></div><h4 id="deploying-applications">Deploying applications</h4>
<p>Now the new environment is up and running you should deploy the following applications:</p>

<ul>
<li><a href="https://github.com/digital-land/digital-land.info/actions/workflows/continuous-deployment.yml">main</a>
The main digital land web application.</li>
<li><a href="https://github.com/digital-land/datasette-builder/actions/workflows/deploy.yml">datasette</a>
A web service and API allowing SQL queries against sqlite databases.</li>
<li><a href="https://github.com/digital-land/tiles-builder/actions/workflows/deploy-application.yml">datasette-tiles (application)</a>
A web service that allows the main application&rsquo;s frontend to draw vector tiles on the map feature from our datasets.</li>
</ul>
<h2 id="configuration-changes">Configuration Changes</h2>
<h3 id="add-a-new-application">Add a new application</h3>
<p>To create a new application in the terraform configuration, you will need to know the following:</p>

<ul>
<li>The <strong>GitHub repository</strong> (under the <a href="https://github.com/digital-land">digital-land</a> organisation) hosting the application code.</li>
<li>The <strong>subdomain</strong> of <code>planning.data.gov.uk</code> that the application will run under.</li>
<li>An estimate of the <strong>memory usage</strong> of the application.</li>
<li>A list of the application <strong>environment variables</strong>.</li>
<li>If the application needs access to the SQLite or MBTiles files generated by backgroun tasks.</li>
</ul>
<p>Add a new section to <code>variables.tf</code> under <code>locals.application_defaults</code>, replacing attributes as required.</p>
<div class="highlight"><pre class="highlight hcl" tabindex="0"><code><span class="err">&lt;</span><span class="nx">name</span><span class="err">&gt;</span> <span class="err">=</span> <span class="p">{</span>
  <span class="c1">// The subdomain to serve the application from</span>
  <span class="nx">access</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">domain</span> <span class="p">=</span> <span class="s2">"&lt;subdomain&gt;"</span>
  <span class="p">}</span>
  <span class="c1">// Any static environment variables</span>
  <span class="nx">environment</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">PORT</span> <span class="p">=</span> <span class="mi">5000</span> <span class="c1">// Defaults to 80</span>
  <span class="p">}</span>
  <span class="c1">// The GitHub repository that hosts the application code</span>
  <span class="nx">github_repository</span> <span class="p">=</span> <span class="s2">"&lt;organisation&gt;/&lt;repository&gt;"</span>
  <span class="c1">// Set to true if the GitHub repository contains both an</span>
  <span class="c1">// application and a background task.</span>
  <span class="nx">github_repository_dual</span> <span class="p">=</span> <span class="kc">false</span>
  <span class="c1">// The application healthcheck path and timeout</span>
  <span class="nx">healthcheck</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">endpoint</span> <span class="p">=</span> <span class="s2">"/"</span>
    <span class="nx">timeout</span> <span class="p">=</span> <span class="s2">"30"</span>
  <span class="p">}</span>
  <span class="c1">// Minimum and maximum number of application instances</span>
  <span class="c1">// The auto-scaling configuration scales the initial</span>
  <span class="c1">// number on:</span>
  <span class="c1">//  - 60% CPU Utilisation</span>
  <span class="c1">//  - 80% Memory Utilisation</span>
  <span class="nx">instances</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">minimum</span> <span class="p">=</span> <span class="mi">1</span>
    <span class="nx">maximum</span> <span class="p">=</span> <span class="mi">2</span>
    <span class="nx">initial</span> <span class="p">=</span> <span class="mi">1</span>
  <span class="p">}</span>
  <span class="c1">// The resources needed per application instance</span>
  <span class="nx">resources</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">memory</span>      <span class="p">=</span> <span class="mi">1024</span>
    <span class="nx">cpu_credits</span> <span class="p">=</span> <span class="mi">20</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>Add a new application block in <code>main_apps.tf</code>, replacing attributes as required.</li>
</ul>
<div class="highlight"><pre class="highlight hcl" tabindex="0"><code><span class="nx">module</span> <span class="s2">"application_&lt;name&gt;"</span> <span class="p">{</span>
  <span class="nx">source</span> <span class="p">=</span> <span class="s2">"./modules/application"</span>

  <span class="nx">name</span>                <span class="p">=</span> <span class="s2">"&lt;name&gt;"</span>
  <span class="nx">stage</span>               <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">stage</span>
  <span class="nx">resource_prefix</span>     <span class="p">=</span> <span class="s2">"${var.stage}-&lt;name&gt;"</span>
  <span class="nx">cluster</span>             <span class="p">=</span> <span class="nx">module</span><span class="err">.</span><span class="nx">cluster</span><span class="err">.</span><span class="nx">cluster</span>
  <span class="nx">tags</span>                <span class="p">=</span> <span class="nx">module</span><span class="err">.</span><span class="nx">tags</span><span class="err">.</span><span class="nx">computed</span>
  <span class="nx">environment</span>         <span class="p">=</span> <span class="nx">merge</span><span class="err">(</span>
    <span class="nx">module</span><span class="err">.</span><span class="nx">storage</span><span class="err">.</span><span class="nx">environment</span><span class="err">,</span>
    <span class="p">{</span>
      <span class="nx">ENVIRONMENT</span> <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">stage</span>
      <span class="nx">PORT</span> <span class="p">=</span> <span class="mi">5000</span>
    <span class="p">}</span>
  <span class="err">)</span>
  <span class="nx">secrets</span>             <span class="p">=</span> <span class="nx">merge</span><span class="err">(</span>
    <span class="nx">module</span><span class="err">.</span><span class="nx">storage</span><span class="err">.</span><span class="nx">secrets</span>
  <span class="err">)</span>
  <span class="nx">github_repository</span>   <span class="p">=</span> <span class="nx">local</span><span class="err">.</span><span class="nx">applications</span><span class="p">[</span><span class="s2">"&lt;name&gt;"</span><span class="p">]</span><span class="err">.</span><span class="nx">github_repository</span>
  <span class="nx">github_repository_dual</span> <span class="p">=</span> <span class="nx">local</span><span class="err">.</span><span class="nx">applications</span><span class="p">[</span><span class="s2">"&lt;name&gt;"</span><span class="p">]</span><span class="err">.</span><span class="nx">github_repository_dual</span>
  <span class="nx">deployment_approval</span> <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">deployment_approval</span>
  <span class="nx">healthcheck</span>         <span class="p">=</span> <span class="nx">local</span><span class="err">.</span><span class="nx">applications</span><span class="p">[</span><span class="s2">"&lt;name&gt;"</span><span class="p">]</span><span class="err">.</span><span class="nx">healthcheck</span>
  <span class="nx">instances</span>           <span class="p">=</span> <span class="nx">local</span><span class="err">.</span><span class="nx">applications</span><span class="p">[</span><span class="s2">"&lt;name&gt;"</span><span class="p">]</span><span class="err">.</span><span class="nx">instances</span>
  <span class="nx">resources</span>           <span class="p">=</span> <span class="nx">local</span><span class="err">.</span><span class="nx">applications</span><span class="p">[</span><span class="s2">"&lt;name&gt;"</span><span class="p">]</span><span class="err">.</span><span class="nx">resources</span>
  <span class="nx">volumes</span>             <span class="p">=</span> <span class="p">{</span>
    <span class="nx">datasets</span> <span class="p">=</span> <span class="nx">merge</span><span class="err">(</span>
      <span class="nx">module</span><span class="err">.</span><span class="nx">storage</span><span class="err">.</span><span class="nx">files</span><span class="err">.</span><span class="nx">datasets</span><span class="err">,</span>
      <span class="p">{</span>
          <span class="nx">readonly</span> <span class="p">=</span> <span class="kc">true</span>
      <span class="p">}</span>
    <span class="err">)</span>
  <span class="p">}</span>

  <span class="nx">additional_permissions</span> <span class="p">=</span> <span class="nx">merge</span><span class="err">(</span>
    <span class="nx">module</span><span class="err">.</span><span class="nx">storage</span><span class="err">.</span><span class="nx">permissions</span><span class="err">.</span><span class="nx">efs_read</span>
  <span class="err">)</span>

  <span class="nx">access</span> <span class="p">=</span> <span class="nx">merge</span><span class="err">(</span><span class="nx">local</span><span class="err">.</span><span class="nx">applications</span><span class="p">[</span><span class="s2">"datasette"</span><span class="p">]</span><span class="err">.</span><span class="nx">access</span><span class="err">,</span> <span class="p">{</span>
    <span class="nx">certificate_arn</span> <span class="p">=</span> <span class="nx">module</span><span class="err">.</span><span class="nx">domain</span><span class="err">.</span><span class="nx">certificate_arn</span>
    <span class="nx">zone_id</span>         <span class="p">=</span> <span class="nx">module</span><span class="err">.</span><span class="nx">domain</span><span class="err">.</span><span class="nx">zone_id</span>
  <span class="p">}</span><span class="err">)</span>

  <span class="nx">network</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">mode</span>            <span class="p">=</span> <span class="s2">"awsvpc"</span>
    <span class="nx">vpc_id</span>          <span class="p">=</span> <span class="nx">module</span><span class="err">.</span><span class="nx">network</span><span class="err">.</span><span class="nx">vpc_id</span>
    <span class="nx">subnets</span>         <span class="p">=</span> <span class="nx">module</span><span class="err">.</span><span class="nx">network</span><span class="err">.</span><span class="nx">subnet_public_ids</span>
    <span class="nx">security_groups</span> <span class="p">=</span> <span class="p">[</span><span class="nx">module</span><span class="err">.</span><span class="nx">network</span><span class="err">.</span><span class="nx">security_group_public_id</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>Run terraform apply</li>
<li>Check that the service is running on the appropriate domain name</li>
<li>Update the slackbot token at <code>/&lt;environment&gt;-&lt;application&gt;/notifications/slack-token</code> in SSM</li>
<li>If configured with a GitHub repository add a deployment workflow to the repo</li>
</ul>
<div class="highlight"><pre class="highlight yaml" tabindex="0"><code><span class="na">name</span><span class="pi">:</span> <span class="s">Deploy</span>
<span class="na">on</span><span class="pi">:</span>
  <span class="na">push</span><span class="pi">:</span>
    <span class="na">branches</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">main</span><span class="pi">]</span>
<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">deploy-&lt;environment&gt;</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">env</span><span class="pi">:</span>
      <span class="na">DOCKER_REPO</span><span class="pi">:</span> <span class="s">${{ secrets.DEPLOY_DOCKER_REPOSITORY }}</span>
    <span class="na">environment</span><span class="pi">:</span> <span class="s">&lt;environment&gt;</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v3</span>
      <span class="pi">-</span> <span class="na">id</span><span class="pi">:</span> <span class="s">vars</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">echo "sha_short=$(git rev-parse --short HEAD)" &gt;&gt; $GITHUB_OUTPUT</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">sudo apt-get update</span>
          <span class="s">sudo apt-get install -y rsync</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">aws-actions/configure-aws-credentials@v1-node16</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">aws-access-key-id</span><span class="pi">:</span> <span class="s">${{ secrets.DEPLOY_AWS_ACCESS_KEY_ID }}</span>
          <span class="na">aws-secret-access-key</span><span class="pi">:</span> <span class="s">${{ secrets.DEPLOY_AWS_SECRET_ACCESS_KEY }}</span>
          <span class="na">aws-region</span><span class="pi">:</span> <span class="s">eu-west-2</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">aws-actions/amazon-ecr-login@v1</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker pull $DOCKER_REPO:latest</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker build -t $DOCKER_REPO:${{ steps.vars.outputs.sha_short }} .</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker tag $DOCKER_REPO:${{ steps.vars.outputs.sha_short }} $DOCKER_REPO:latest</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker push $DOCKER_REPO:${{ steps.vars.outputs.sha_short }}</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker push $DOCKER_REPO:latest</span>
</code></pre></div><h3 id="add-a-new-background-task">Add a new background task</h3>

            
          </main>

          <aside>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">


      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="javascripts/application.js"></script>
  </body>
</html>

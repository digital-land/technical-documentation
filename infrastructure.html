<!doctype html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>Infrastructure - Planning Data</title>

    <link href="stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="digital-land.github.io/infrastructure.html">

      <meta name="robots" content="noindex" />
      <meta name="twitter:card" content="summary" />
      <meta name="twitter:image" content="digital-land.github.io/images/govuk-large.png" />
      <meta name="twitter:title" content="Infrastructure - Planning Data" />
      <meta name="twitter:url" content="digital-land.github.io/infrastructure.html" />

      <meta property="og:image" content="digital-land.github.io/images/govuk-large.png" />
      <meta property="og:site_name" content="Planning Data" />
      <meta property="og:title" content="Infrastructure" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="digital-land.github.io/infrastructure.html" />

    
  </head>

  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link" data-module="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="https://planning.data.gov.uk" class="govuk-header__link govuk-header__link--homepage">
        <span class="govuk-header__product-name">
          Planning Data
        </span>
      </a>
        <strong class="govuk-tag">Beta</strong>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <button type="button" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </button>
        </div>

      <div class="app-pane__body" data-module="in-page-navigation">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents" tabindex="-1" aria-label="Table of contents" role="dialog">
              <div class="search" data-module="search" data-path-to-site-root="./">
  <form action="https://www.google.co.uk/search" method="get" role="search" class="search__form govuk-!-margin-bottom-4">
    <input type="hidden" name="as_sitesearch" value="digital-land.github.io"/>
    <label class="govuk-label search__label" for="search" aria-hidden="true">
      Search (via Google)
    </label>
    <input
      type="text"
      id="search" name="q"
      class="govuk-input govuk-!-margin-bottom-0 search__input"
      aria-controls="search-results"
      placeholder="Search">
    <button type="submit" class="search__button">Search</button>
  </form>
</div>

              <button type="button" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></button>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading" data-module="collapsible-navigation">
                      <ul>
  <li>
    <a href="./index.html"><span>Planning Data Service</span></a>
  </li>
  <li>
    <a href="./runbook.html"><span>Run Book</span></a>
    <ul>
      <li>
        <a href="./runbook.html#outage-procedure"><span>Outage Procedure</span></a>
      </li>
      <li>
        <a href="./runbook.html#common-issues"><span>Common Issues</span></a>
      </li>
      <li>
        <a href="./runbook.html#incident-response-history"><span>Incident Response History</span></a>
        <ul>
          <li>
            <a href="./runbook.html#all-applications-on-planning-data-gov-uk-2022-11-22"><span>All applications on planning.data.gov.uk - 2022-11-22</span></a>
          </li>
          <li>
            <a href="./runbook.html#getting-error-500-on-planning-data-gov-uk-2023-04-11"><span>Getting error 500 on planning.data.gov.uk - 2023-04-11</span></a>
          </li>
          <li>
            <a href="./runbook.html#slowness-reported-on-planning-data-gov-uk-2023-06-01"><span>Slowness reported on planning.data.gov.uk - 2023-06-01</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <a href="./infrastructure.html"><span>Infrastructure</span></a>
    <ul>
      <li>
        <a href="./infrastructure.html#overview"><span>Overview</span></a>
      </li>
      <li>
        <a href="./infrastructure.html#deploying"><span>Deploying</span></a>
        <ul>
          <li>
          </li>
          <li>
            <a href="./infrastructure.html#an-existing-environment"><span>An Existing Environment</span></a>
          </li>
          <li>
            <a href="./infrastructure.html#a-new-environment"><span>A New Environment</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="./infrastructure.html#configuration-changes"><span>Configuration Changes</span></a>
        <ul>
          <li>
            <a href="./infrastructure.html#add-a-new-application"><span>Add a new application</span></a>
          </li>
          <li>
            <a href="./infrastructure.html#add-a-new-background-task"><span>Add a new background task</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <a href="./decision-record.html"><span>Architecture Decision Record</span></a>
    <ul>
      <li>
        <a href="./decision-record.html#1-record-architecture-decisions"><span>1. Record architecture decisions</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="./decision-record.html#2-floating-package-dependencies"><span>2. floating-package-dependencies</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="./decision-record.html#3-use-the-repository-pattern-to-access-a-database"><span>3. Use the repository-pattern to access a database</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="./decision-record.html#4-implement-plugins-using-pluggy"><span>4. Implement plugins using pluggy</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="./decision-record.html#5-load-external-frontend-assets-first"><span>5. Load external frontend assets first</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="./decision-record.html#6-use-github-pages-for-our-content"><span>6. Use Github pages for our content</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="./decision-record.html#7-provide-unique-ids-for-dataset-entries"><span>7. Provide unique IDs for dataset entries</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="./decision-record.html#8-use-files-for-repositories-databases-as-indexes"><span>8. Use files for repositories, databases as indexes</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="./decision-record.html#9-use-sqlite-for-data-packages"><span>9. Use SQLite for data packages</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="./decision-record.html#10-use-the-entity-value-attribute-pattern-for-our-data-model"><span>10. Use the Entity-Value-Attribute pattern for our data model</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="./decision-record.html#11-avoid-git-submodules-wherever-possible"><span>11. Avoid git submodules wherever possible</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="./decision-record.html#12-collection-names-should-be-singular"><span>12. Collection names should be singular</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="./decision-record.html#13-use-github-lfs-for-large-git-files"><span>13. Use Github LFS for large git files</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="./decision-record.html#14-use-kebab-case-for-names-in-data"><span>14. Use kebab-case for names in data</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="./decision-record.html#15-write-new-tests-at-the-lowest-possible-levels"><span>15. Write new tests at the lowest possible levels</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="./decision-record.html#16-missing-entry-dates"><span>16. Missing entry-dates</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
      <li>
        <a href="./decision-record.html#17-use-vector-tiles-to-display-geographic-data-on-a-map"><span>17. Use vector tiles to display geographic data on a map</span></a>
        <ul>
          <li>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
            <h1 id="infrastructure">Infrastructure</h1>
<p>The planning data <a href="https://github.com/digital-land/digital-land-infrastructure">infrastructure repository</a> contains
terraform configuration files that create the necessary services to deploy applications and background tasks for the
planning data system.</p>
<h2 id="overview">Overview</h2>
<p><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="586px" preserveAspectRatio="none" style="width:1121px;height:586px;background:#FFFFFF;" version="1.1" viewBox="0 0 1121 586" width="1121px" zoomAndPan="magnify"><defs/><g><g id="elem_user_data_provider"><rect fill="#08427B" height="135.5156" rx="2.5" ry="2.5" style="stroke:#073B6F;stroke-width:0.5;" width="183" x="24.5" y="232"/><image height="48" width="48" x="92" xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAIAAADYYG7QAAACD0lEQVR4Xu2YoU4EMRCGT+4j8Ai8AhaH4QHgAUjQuFMECUgMIUgwJAgMhgQsAYUiJCiQIBBY+EITsjfTdme6V24v4c8vyGbb+ZjOtN0bNcvjQXmkH83WvYBWto6PLm6v7p7uH1/w2fXD+PBycX1Pv2l3IdDm/vn7x+dXQiAubRzoURa7gRZWd0iGRIiJbOnhnfYBQZNJjNbuyY2eJG8fkDE3bbG4ep6MHUAsgYxmE3nVs6VsBWJSGccsOlFPmLIViMzLOB7pCVO2AtHJMohH7Fh6zqitQK7m0rJvAVYgGcEpe//PLdDz65sM4pF9N7ICcXDKIB5Nv6j7tD0NoSdM2QrU9Gg0ewE1LqBhHR3BBdvj2vapnidjHxD/q6vd7Pvhr31AwcY8eXMTXAKECZZJFXuEq27aLgQK5uLMohCenGGuGewOxSjBvYBqeG6B+Nqiblggdjnc+ZXDy+FNFpFzw76O3UBAROuXh6FoiAcf5g9eTvUgzy0nWg6I8cXHRUpg5bOVBCo+KDpFajOf23GgPme7RSQ+lacIENUgJ6gg1k6HjgOlqnLqip4tEuhv0hNEMXUD0clyXE3p6pZA0S2nnvTlXwLJEZWlb7cTQH1+USgTN4VhAenm/wea1OCAOmqo6fE1WCb9WSKBah+rbUWPWAmE2Rvk0ApiB45eOyNAzU8xcTvj8KvkKEoOaIYeHNA3ZuygAvFMUO0AAAAASUVORK5CYII=" y="242"/><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" textLength="41" x="55" y="304.8516">Data</text><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" textLength="6" x="96" y="304.8516">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" textLength="75" x="102" y="304.8516">Provider</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="114" y="321.6201">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="62" x="34.5" y="337.917">Prepares</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="96.5" y="337.917">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="26" x="100.5" y="337.917">and</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="126.5" y="337.917">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="67" x="130.5" y="337.917">publishes</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="34" x="99" y="354.2139">data.</text></g><g id="elem_user_planner"><rect fill="#08427B" height="135.5156" rx="2.5" ry="2.5" style="stroke:#073B6F;stroke-width:0.5;" width="169" x="812.5" y="7"/><image height="48" width="48" x="873" xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAIAAADYYG7QAAACD0lEQVR4Xu2YoU4EMRCGT+4j8Ai8AhaH4QHgAUjQuFMECUgMIUgwJAgMhgQsAYUiJCiQIBBY+EITsjfTdme6V24v4c8vyGbb+ZjOtN0bNcvjQXmkH83WvYBWto6PLm6v7p7uH1/w2fXD+PBycX1Pv2l3IdDm/vn7x+dXQiAubRzoURa7gRZWd0iGRIiJbOnhnfYBQZNJjNbuyY2eJG8fkDE3bbG4ep6MHUAsgYxmE3nVs6VsBWJSGccsOlFPmLIViMzLOB7pCVO2AtHJMohH7Fh6zqitQK7m0rJvAVYgGcEpe//PLdDz65sM4pF9N7ICcXDKIB5Nv6j7tD0NoSdM2QrU9Gg0ewE1LqBhHR3BBdvj2vapnidjHxD/q6vd7Pvhr31AwcY8eXMTXAKECZZJFXuEq27aLgQK5uLMohCenGGuGewOxSjBvYBqeG6B+Nqiblggdjnc+ZXDy+FNFpFzw76O3UBAROuXh6FoiAcf5g9eTvUgzy0nWg6I8cXHRUpg5bOVBCo+KDpFajOf23GgPme7RSQ+lacIENUgJ6gg1k6HjgOlqnLqip4tEuhv0hNEMXUD0clyXE3p6pZA0S2nnvTlXwLJEZWlb7cTQH1+USgTN4VhAenm/wea1OCAOmqo6fE1WCb9WSKBah+rbUWPWAmE2Rvk0ApiB45eOyNAzU8xcTvj8KvkKEoOaIYeHNA3ZuygAvFMUO0AAAAASUVORK5CYII=" y="17"/><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" textLength="67" x="863.5" y="79.8516">Planner</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="895" y="96.6201">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="822.5" y="112.917">Browses</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="882.5" y="112.917">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="23" x="886.5" y="112.917">the</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="909.5" y="112.917">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="58" x="913.5" y="112.917">available</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="64" x="865" y="129.2139">datasets.</text></g><g id="elem_app_data_provider"><rect fill="#999999" height="71.2188" rx="2.5" ry="2.5" style="stroke:#8A8A8A;stroke-width:0.5;" width="218" x="7" y="478"/><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" textLength="41" x="72" y="502.8516">Data</text><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" textLength="6" x="113" y="502.8516">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" textLength="41" x="119" y="502.8516">Host</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="114" y="519.6201">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="40" x="17" y="535.917">Hosts</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="57" y="535.917">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="30" x="61" y="535.917">data</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="91" y="535.917">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="95" y="535.917">provider</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="151" y="535.917">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="155" y="535.917">datasets</text></g><g id="elem_pipeline_collection"><path d="M372,458.5 L548,458.5 C553,458.5 553,513.5547 553,513.5547 C553,513.5547 553,568.6094 548,568.6094 L372,568.6094 C367,568.6094 367,513.5547 367,513.5547 C367,513.5547 367,458.5 372,458.5 " fill="#1168BD" style="stroke:#3C7FC0;stroke-width:0.5;"/><path d="M548,458.5 C543,458.5 543,513.5547 543,513.5547 C543,568.6094 548,568.6094 548,568.6094 " fill="none" style="stroke:#3C7FC0;stroke-width:0.5;"/><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" textLength="86" x="375" y="478.3516">Collection</text><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" textLength="6" x="461" y="478.3516">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" textLength="68" x="467" y="478.3516">Pipeline</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="453" y="495.1201">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="55" x="393" y="511.417">Collects</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="448" y="511.417">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="30" x="452" y="511.417">data</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="482" y="511.417">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="31" x="486" y="511.417">from</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="76" x="372.5" y="527.7139">publishers,</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="448.5" y="527.7139">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="63" x="452.5" y="527.7139">checking</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="515.5" y="527.7139">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="18" x="519.5" y="527.7139">for</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="41" x="372" y="544.0107">errors</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="413" y="544.0107">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="26" x="417" y="544.0107">and</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="443" y="544.0107">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="57" x="447" y="544.0107">merging</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="504" y="544.0107">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="30" x="508" y="544.0107">data</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="45" x="404.5" y="560.3076">before</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="449.5" y="560.3076">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="52" x="453.5" y="560.3076">storing.</text></g><g id="elem_app_main"><rect fill="#1168BD" height="103.8125" rx="2.5" ry="2.5" style="stroke:#3C7FC0;stroke-width:0.5;" width="209" x="674.5" y="248"/><a href="https://www.planning.data.gov.uk" target="_top" title="https://www.planning.data.gov.uk" xlink:actuate="onRequest" xlink:href="https://www.planning.data.gov.uk" xlink:show="new" xlink:title="https://www.planning.data.gov.uk" xlink:type="simple"><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" text-decoration="underline" textLength="96" x="731" y="272.8516">Application</text></a><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="777" y="289.6201">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="32" x="684.5" y="305.917">Main</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="716.5" y="305.917">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="74" x="720.5" y="305.917">application</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="794.5" y="305.917">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="75" x="798.5" y="305.917">presenting</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="30" x="696.5" y="322.2139">data</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="726.5" y="322.2139">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="14" x="730.5" y="322.2139">to</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="744.5" y="322.2139">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="39" x="748.5" y="322.2139">users</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="787.5" y="322.2139">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="12" x="791.5" y="322.2139">in</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="803.5" y="322.2139">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="54" x="807.5" y="322.2139">multiple</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="56" x="751" y="338.5107">formats.</text></g><g id="elem_app_datasette_tiles"><rect fill="#1168BD" height="103.8125" rx="2.5" ry="2.5" style="stroke:#3C7FC0;stroke-width:0.5;" width="197" x="918.5" y="248"/><a href="https://datasette-tiles.planning.data.gov.uk" target="_top" title="https://datasette-tiles.planning.data.gov.uk" xlink:actuate="onRequest" xlink:href="https://datasette-tiles.planning.data.gov.uk" xlink:show="new" xlink:title="https://datasette-tiles.planning.data.gov.uk" xlink:type="simple"><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" text-decoration="underline" textLength="37" x="962.5" y="272.8516">Map</text></a><a href="https://datasette-tiles.planning.data.gov.uk" target="_top" title="https://datasette-tiles.planning.data.gov.uk" xlink:actuate="onRequest" xlink:href="https://datasette-tiles.planning.data.gov.uk" xlink:show="new" xlink:title="https://datasette-tiles.planning.data.gov.uk" xlink:type="simple"><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" text-decoration="underline" textLength="6" x="999.5" y="272.8516">&#160;</text></a><a href="https://datasette-tiles.planning.data.gov.uk" target="_top" title="https://datasette-tiles.planning.data.gov.uk" xlink:actuate="onRequest" xlink:href="https://datasette-tiles.planning.data.gov.uk" xlink:show="new" xlink:title="https://datasette-tiles.planning.data.gov.uk" xlink:type="simple"><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" text-decoration="underline" textLength="30" x="1005.5" y="272.8516">Tile</text></a><a href="https://datasette-tiles.planning.data.gov.uk" target="_top" title="https://datasette-tiles.planning.data.gov.uk" xlink:actuate="onRequest" xlink:href="https://datasette-tiles.planning.data.gov.uk" xlink:show="new" xlink:title="https://datasette-tiles.planning.data.gov.uk" xlink:type="simple"><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" text-decoration="underline" textLength="6" x="1035.5" y="272.8516">&#160;</text></a><a href="https://datasette-tiles.planning.data.gov.uk" target="_top" title="https://datasette-tiles.planning.data.gov.uk" xlink:actuate="onRequest" xlink:href="https://datasette-tiles.planning.data.gov.uk" xlink:show="new" xlink:title="https://datasette-tiles.planning.data.gov.uk" xlink:type="simple"><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" text-decoration="underline" textLength="30" x="1041.5" y="272.8516">API</text></a><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="1015" y="289.6201">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="29" x="938" y="305.917">Map</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="967" y="305.917">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="20" x="971" y="305.917">tile</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="991" y="305.917">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="47" x="995" y="305.917">server,</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="1042" y="305.917">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="50" x="1046" y="305.917">serving</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="51" x="933.5" y="322.2139">vectors</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="984.5" y="322.2139">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="18" x="988.5" y="322.2139">for</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="1006.5" y="322.2139">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="26" x="1010.5" y="322.2139">use</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="1036.5" y="322.2139">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="23" x="1040.5" y="322.2139">the</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="1063.5" y="322.2139">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="33" x="1067.5" y="322.2139">main</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="74" x="928.5" y="338.5107">application</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="1002.5" y="338.5107">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="31" x="1006.5" y="338.5107">user</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="1037.5" y="338.5107">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="64" x="1041.5" y="338.5107">interface.</text></g><g id="elem_app_datasette"><rect fill="#1168BD" height="103.8125" rx="2.5" ry="2.5" style="stroke:#3C7FC0;stroke-width:0.5;" width="204" x="330" y="248"/><a href="https://datasette.planning.data.gov.uk" target="_top" title="https://datasette.planning.data.gov.uk" xlink:actuate="onRequest" xlink:href="https://datasette.planning.data.gov.uk" xlink:show="new" xlink:title="https://datasette.planning.data.gov.uk" xlink:type="simple"><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" text-decoration="underline" textLength="41" x="393.5" y="272.8516">Data</text></a><a href="https://datasette.planning.data.gov.uk" target="_top" title="https://datasette.planning.data.gov.uk" xlink:actuate="onRequest" xlink:href="https://datasette.planning.data.gov.uk" xlink:show="new" xlink:title="https://datasette.planning.data.gov.uk" xlink:type="simple"><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" text-decoration="underline" textLength="6" x="434.5" y="272.8516">&#160;</text></a><a href="https://datasette.planning.data.gov.uk" target="_top" title="https://datasette.planning.data.gov.uk" xlink:actuate="onRequest" xlink:href="https://datasette.planning.data.gov.uk" xlink:show="new" xlink:title="https://datasette.planning.data.gov.uk" xlink:type="simple"><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" text-decoration="underline" textLength="30" x="440.5" y="272.8516">API</text></a><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="430" y="289.6201">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="32" x="340" y="305.917">Data</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="372" y="305.917">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="47" x="376" y="305.917">server,</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="423" y="305.917">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="79" x="427" y="305.917">responding</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="506" y="305.917">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="14" x="510" y="305.917">to</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="27" x="341" y="322.2139">SQL</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="368" y="322.2139">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="52" x="372" y="322.2139">queries</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="424" y="322.2139">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="31" x="428" y="322.2139">from</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="459" y="322.2139">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="23" x="463" y="322.2139">the</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="486" y="322.2139">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="33" x="490" y="322.2139">main</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="78" x="393" y="338.5107">application.</text></g><g id="elem_data_static_files"><path d="M674,467 C674,457 779,457 779,457 C779,457 884,457 884,467 L884,559.8125 C884,569.8125 779,569.8125 779,569.8125 C779,569.8125 674,569.8125 674,559.8125 L674,467 " fill="#1168BD" style="stroke:#3C7FC0;stroke-width:0.5;"/><path d="M674,467 C674,477 779,477 779,477 C779,477 884,477 884,467 " fill="none" style="stroke:#3C7FC0;stroke-width:0.5;"/><a href="https://files.planning.data.gov.uk/index.html" target="_top" title="https://files.planning.data.gov.uk/index.html" xlink:actuate="onRequest" xlink:href="https://files.planning.data.gov.uk/index.html" xlink:show="new" xlink:title="https://files.planning.data.gov.uk/index.html" xlink:type="simple"><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" text-decoration="underline" textLength="66" x="708" y="495.8516">Archive</text></a><a href="https://files.planning.data.gov.uk/index.html" target="_top" title="https://files.planning.data.gov.uk/index.html" xlink:actuate="onRequest" xlink:href="https://files.planning.data.gov.uk/index.html" xlink:show="new" xlink:title="https://files.planning.data.gov.uk/index.html" xlink:type="simple"><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" text-decoration="underline" textLength="6" x="774" y="495.8516">&#160;</text></a><a href="https://files.planning.data.gov.uk/index.html" target="_top" title="https://files.planning.data.gov.uk/index.html" xlink:actuate="onRequest" xlink:href="https://files.planning.data.gov.uk/index.html" xlink:show="new" xlink:title="https://files.planning.data.gov.uk/index.html" xlink:type="simple"><text fill="#FFFFFF" font-family="sans-serif" font-size="16" font-weight="bold" lengthAdjust="spacing" text-decoration="underline" textLength="70" x="780" y="495.8516">Storage</text></a><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="777" y="512.6201">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="45" x="684" y="528.917">Stores</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="729" y="528.917">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="30" x="733" y="528.917">data</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="763" y="528.917">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="31" x="767" y="528.917">from</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="798" y="528.917">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="72" x="802" y="528.917">publishers</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="50" x="688" y="545.2139">making</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="738" y="545.2139">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="8" x="742" y="545.2139">it</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="750" y="545.2139">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="58" x="754" y="545.2139">available</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="812" y="545.2139">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="18" x="816" y="545.2139">for</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="834" y="545.2139">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="32" x="838" y="545.2139">sync</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="28" x="699.5" y="561.5107">with</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="727.5" y="561.5107">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="37" x="731.5" y="561.5107">other</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="768.5" y="561.5107">&#160;</text><text fill="#FFFFFF" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="86" x="772.5" y="561.5107">applications.</text></g><g id="link_user_data_provider_app_data_provider"><path d="M116,368.21 C116,401.35 116,440.33 116,469.42 " fill="none" id="user_data_provider-to-app_data_provider" style="stroke:#666666;stroke-width:1.0;"/><polygon fill="#666666" points="116,477.73,119,469.73,113,469.73,116,477.73" style="stroke:#666666;stroke-width:1.0;"/><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="69" x="117" y="417.1387">Publishes</text><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="4" x="186" y="417.1387">&#160;</text><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="34" x="190" y="417.1387">Data</text></g><g id="link_app_data_provider_pipeline_collection"><path d="M233.39,513.5 C276.96,513.5 325.76,513.5 366.87,513.5 " fill="none" id="app_data_provider-backto-pipeline_collection" style="stroke:#666666;stroke-width:1.0;"/><polygon fill="#666666" points="225.32,513.5,233.32,516.5,233.32,510.5,225.32,513.5" style="stroke:#666666;stroke-width:1.0;"/><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="67" x="243.5" y="493.6387">Retrieves</text><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="4" x="310.5" y="493.6387">&#160;</text><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="34" x="314.5" y="493.6387">Data</text><text fill="#666666" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="48" x="272" y="507.6074">[HTTPS]</text></g><g id="link_pipeline_collection_data_static_files"><path d="M553.13,513.5 C588.35,513.5 628.82,513.5 665.69,513.5 " fill="none" id="pipeline_collection-to-data_static_files" style="stroke:#666666;stroke-width:1.0;"/><polygon fill="#666666" points="673.99,513.5,665.99,510.5,665.99,516.5,673.99,513.5" style="stroke:#666666;stroke-width:1.0;"/><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="47" x="571.5" y="493.6387">Stores</text><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="4" x="618.5" y="493.6387">&#160;</text><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="33" x="622.5" y="493.6387">data</text><text fill="#666666" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="48" x="589.5" y="507.6074">[HTTPS]</text></g><g id="link_app_datasette_data_static_files"><path d="M523.09,356.52 C573.91,387.5 637.03,425.97 687.87,456.95 " fill="none" id="app_datasette-backto-data_static_files" style="stroke:#666666;stroke-width:1.0;"/><polygon fill="#666666" points="516,352.2,521.263,358.9306,524.3909,353.8103,516,352.2" style="stroke:#666666;stroke-width:1.0;"/><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="33" x="637" y="410.1387">Sync</text><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="4" x="670" y="410.1387">&#160;</text><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="46" x="674" y="410.1387">SQLite</text><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="4" x="720" y="410.1387">&#160;</text><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="30" x="724" y="410.1387">files</text><text fill="#666666" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="60" x="665.5" y="424.1074">[Lambda]</text></g><g id="link_app_datasette_tiles_data_static_files"><path d="M960.64,358.02 C938.2,380.09 911.84,405.22 887,427 C875.67,436.93 863.38,447.15 851.28,456.92 " fill="none" id="app_datasette_tiles-backto-data_static_files" style="stroke:#666666;stroke-width:1.0;"/><polygon fill="#666666" points="966.56,352.19,958.7553,355.6665,962.9656,359.9412,966.56,352.19" style="stroke:#666666;stroke-width:1.0;"/><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="33" x="917" y="410.1387">Sync</text><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="4" x="950" y="410.1387">&#160;</text><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="30" x="954" y="410.1387">map</text><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="4" x="984" y="410.1387">&#160;</text><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="23" x="988" y="410.1387">tile</text><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="4" x="1011" y="410.1387">&#160;</text><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="30" x="1015" y="410.1387">files</text><text fill="#666666" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="29" x="948" y="424.1074">[ECS</text><text fill="#666666" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="4" x="977" y="424.1074">&#160;</text><text fill="#666666" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="33" x="981" y="424.1074">Task]</text></g><g id="link_app_main_data_static_files"><path d="M779,360.55 C779,390.79 779,427.3 779,456.95 " fill="none" id="app_main-backto-data_static_files" style="stroke:#666666;stroke-width:1.0;"/><polygon fill="#666666" points="779,352.2,776,360.2,782,360.2,779,352.2" style="stroke:#666666;stroke-width:1.0;"/><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="33" x="780" y="410.1387">Sync</text><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="4" x="813" y="410.1387">&#160;</text><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="24" x="817" y="410.1387">live</text><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="4" x="841" y="410.1387">&#160;</text><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="33" x="845" y="410.1387">data</text><text fill="#666666" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="29" x="796" y="424.1074">[ECS</text><text fill="#666666" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="4" x="825" y="424.1074">&#160;</text><text fill="#666666" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="33" x="829" y="424.1074">Task]</text></g><g id="link_app_datasette_app_main"><path d="M542.34,300 C584.64,300 632.75,300 674.49,300 " fill="none" id="app_datasette-backto-app_main" style="stroke:#666666;stroke-width:1.0;"/><polygon fill="#666666" points="534.23,300,542.23,303,542.23,297,534.23,300" style="stroke:#666666;stroke-width:1.0;"/><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="67" x="552.25" y="280.1387">Requests</text><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="4" x="619.25" y="280.1387">&#160;</text><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="33" x="623.25" y="280.1387">data</text><text fill="#666666" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="48" x="580.25" y="294.1074">[HTTPS]</text></g><g id="link_user_planner_app_main"><path d="M861.44,143.21 C845.05,174.18 825.77,210.6 809.99,240.44 " fill="none" id="user_planner-to-app_main" style="stroke:#666666;stroke-width:1.0;"/><polygon fill="#666666" points="806.05,247.88,812.4439,242.2128,807.141,239.4059,806.05,247.88" style="stroke:#666666;stroke-width:1.0;"/><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="61" x="846" y="185.1387">Browses</text><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="4" x="907" y="185.1387">&#160;</text><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="34" x="911" y="185.1387">Data</text><text fill="#666666" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="48" x="871.5" y="199.1074">[HTTPS]</text></g><g id="link_user_planner_app_datasette_tiles"><path d="M936.33,143.05 C942.01,153.04 947.72,163.26 953,173 C964.82,194.8 977.28,219.03 988.04,240.37 " fill="none" id="user_planner-to-app_datasette_tiles" style="stroke:#666666;stroke-width:1.0;"/><polygon fill="#666666" points="991.77,247.79,990.8688,239.2937,985.5044,241.9812,991.77,247.79" style="stroke:#666666;stroke-width:1.0;"/><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="42" x="968" y="185.1387">Views</text><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="4" x="1010" y="185.1387">&#160;</text><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="30" x="1014" y="185.1387">Map</text><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="4" x="1044" y="185.1387">&#160;</text><text fill="#666666" font-family="sans-serif" font-size="12" font-weight="bold" lengthAdjust="spacing" textLength="33" x="1048" y="185.1387">Tiles</text><text fill="#666666" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="48" x="1000.5" y="199.1074">[HTTPS]</text></g></g></svg>
There are two repositories that handle our infrastructure:</p>

<ul>
<li>Digital Land Infrastructure - this contains our primary infrastructure and allows the user to interact all environments and is what the instructions in this guide aim to help with.</li>
<li>Global Digital Land Infrastructure - this mainly contains infrastructure that needs to lie outside of the other repo such as nameserver records to subdomains as well as lagacy infrustructure such as s3 buckets who&rsquo;s content is stored in glacier</li>
</ul>
<h2 id="deploying">Deploying</h2>
<h4 id="authentication">Authentication</h4>
<p><a href="https://github.com/99designs/aws-vault">aws-vault</a> is recommended to assume the correct role for deploying resources to
the AWS environments. This guide does not cover the correct configuration of aws-vault.</p>
<p>Once configured correctly all the following commands can be executed as follows.</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code>aws-vault <span class="nb">exec</span> &lt;profile&gt; <span class="nt">--</span> &lt;<span class="nb">command</span><span class="o">&gt;</span>
</code></pre></div><h3 id="an-existing-environment">An Existing Environment</h3>
<p>To deploy updates to an existing environment first, clone the
<a href="https://github.com/digital-land/digital-land-infrastructure">infrastructure repository</a>
<code>git clone git@github.com:digital-land/digital-land-infrastructure.git</code>.</p>
<p>Once cloned, run <code>make apply STAGE=&lt;environment&gt;</code> to deploy the updated infrastructure configuration.</p>
<h3 id="a-new-environment">A New Environment</h3>
<p>To deploy a new environment the following details are needed:</p>

<ul>
<li>Environment name</li>
<li>Root domain name</li>
</ul>
<p>First, clone the <a href="https://github.com/digital-land/digital-land-infrastructure">infrastructure repository</a>
<code>git clone git@github.com:digital-land/digital-land-infrastructure.git</code>.</p>
<p>Once cloned, run <code>make new-environment STAGE=&lt;environment&gt; DOMAIN=&lt;root domain&gt;</code> to create the needed configuration
files. Commit the created files to the repository.</p>
<p>Run <code>make apply STAGE=&lt;environment&gt;</code> to deploy the new environment, do not worry about errors, this will fail the first
time you deploy a new environment. There should be roughly 500 new resources created to action the deployment.</p>
<p>On completion of the first deployment run you will see errors regarding the verification of SSL certificates created for
the environment.</p>
<p><strong>First <code>terraform apply</code> output</strong></p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code> Error: error creating CloudFront Distribution: InvalidViewerCertificate: The specified SSL certificate doesn<span class="s1">'t exist, isn'</span>t <span class="k">in </span>us-east-1 region, isn<span class="s1">'t valid, or doesn'</span>t include a valid certificate chain.
       status code: 400, request <span class="nb">id</span>: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx

   with module.application_main.aws_cloudfront_distribution.cdn,
   on modules/application/application_traffic.tf line 28, <span class="k">in </span>resource <span class="s2">"aws_cloudfront_distribution"</span> <span class="s2">"cdn"</span>:
   28: resource <span class="s2">"aws_cloudfront_distribution"</span> <span class="s2">"cdn"</span> <span class="o">{</span>

</code></pre></div><p>To resolve this error we must configure the DNS provider for the root domain to use these nameservers, and then run the
deployment for the environment a second time. To obtain the DNS nameservers, first log into the AWS console
(<code>aws-vault login &lt;profile&gt;</code>), then access Route53 &gt; Hosted Zones &gt; [domain] and get the four values for the NS record,
configuring these servers with the domain&rsquo;s DNS provider.</p>
<p>This can be done by using the global digital land infrastructure to create the required record.</p>
<p>Once DNS delegation is complete, you may check that the SSL certificate has been generated by logging into AWS for the
appropriate account and checking the ACM service in the us-east-1 region. The relevant certificate will show as verified
once delegation is complete.</p>
<p>You can now run <code>make apply STAGE=&lt;environment&gt;</code> for the second time and should see changes to the CDN and Route53
resources. The new infrastructure is now set up, and all that remains is to deploy applications into the new
environment. At this point all applications will serve a page stating that the service will shortly be resumed.</p>
<p><strong>Note:</strong> The following slack bot token parameters required to be update manaully in the aws Parameter Store (SSM). 
The slack bot token <code>(dl-github-actions)</code> values are the same across all envirnments and can be obtains from other environment notification slack token or from Slack direct.</p>

<ul>
<li><code>/&lt;environment&gt;-datasette-tiles/notifications/slack-token</code></li>
<li><code>/&lt;environment&gt;-datasette/notifications/slack-token</code></li>
<li><code>/&lt;environment&gt;-main/notifications/slack-token</code></li>
<li><code>/&lt;environment&gt;-status/notifications/slack-token</code></li>
</ul>
<h4 id="deploying-data">Deploying data</h4>
<p>In order for the applications to start and run we must have data in the platform. Firstly we need both background tasks
deployed to the environment prior to uploading data for processing.</p>
<p>Deploy the following applications using the dispatch workflow</p>

<ul>
<li><a href="https://github.com/digital-land/tiles-builder/actions/workflows/deploy-task.yml">datasette-tiles (task)</a>
A background task that builds <a href="https://github.com/mapbox/mbtiles-spec">MBTiles</a> files for use in the datasette-tiles
application.</li>
<li><a href="https://github.com/digital-land/digital-land-postgres/actions/workflows/deploy.yml">postgres-importer</a>
A background task that imports the digital-land.sqlite3 in a postgres database.</li>
</ul>
<p>Once both applications are deployed we can now copy data into the environment. Data generally enters the environment via
upload as part of a <a href="https://github.com/digital-land?q=-collection">collection job</a> or via the
<a href="https://github.com/digital-land/entity-builder">entity-builder</a> and
<a href="https://github.com/digital-land/digital-land-builder">digital-land-builder</a> jobs.</p>
<p>While these data pipelines run on a regular basis you may need to start with a set of data from another environment in
order to successfully deploy the various applications needed to run the system. The AWS command line application has a
command to make this easier. Run with <code>--dryrun</code> to preview the files to be synced (though the output is not useful).</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code>aws s3 <span class="nb">sync </span>s3://[source]-collection-data s3://[destination]-collection-data
</code></pre></div><p><strong>Note:</strong> It may be worth deployed the main application once before deploying data and once after as the database schema is applied when the application is</p>
<h4 id="deploying-applications">Deploying applications</h4>
<p>Now the new environment is up and running you should deploy the following applications:</p>

<ul>
<li><a href="https://github.com/digital-land/digital-land.info/actions/workflows/continuous-deployment.yml">main</a>
The main digital land web application.</li>
<li><a href="https://github.com/digital-land/datasette-builder/actions/workflows/deploy.yml">datasette</a>
A web service and API allowing SQL queries against sqlite databases.</li>
<li><a href="https://github.com/digital-land/tiles-builder/actions/workflows/deploy-application.yml">datasette-tiles (application)</a>
A web service that allows the main application&rsquo;s frontend to draw vector tiles on the map feature from our datasets.</li>
<li><a href="https://github.com/digital-land/digital-land-status/actions/workflows/deploy.yml">digital-land-status</a>
A simple web page which show the digital land dependencies status.</li>
</ul>
<p><strong>Note:</strong> data may need to be re-deployed to the postgres db once the application has been deployed due to the build failing if no data is found but the database schema only being deployed when the app is</p>
<h2 id="configuration-changes">Configuration Changes</h2>
<h3 id="add-a-new-application">Add a new application</h3>
<p>To create a new application in the terraform configuration, you will need to know the following:</p>

<ul>
<li>The <strong>GitHub repository</strong> (under the <a href="https://github.com/digital-land">digital-land</a> organisation) hosting the application code.</li>
<li>The <strong>subdomain</strong> of <code>planning.data.gov.uk</code> that the application will run under.</li>
<li>An estimate of the <strong>memory usage</strong> of the application.</li>
<li>A list of the application <strong>environment variables</strong>.</li>
<li>If the application needs access to the SQLite or MBTiles files generated by background tasks.</li>
</ul>
<p>Add a new section to <code>variables.tf</code> under <code>locals.application_defaults</code>, replacing attributes as required.</p>
<div class="highlight"><pre class="highlight hcl" tabindex="0"><code><span class="err">&lt;</span><span class="nx">name</span><span class="err">&gt;</span> <span class="err">=</span> <span class="p">{</span>
  <span class="c1">// The subdomain to serve the application from</span>
  <span class="nx">access</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">domain</span> <span class="p">=</span> <span class="s2">"&lt;subdomain&gt;"</span>
  <span class="p">}</span>

  <span class="c1">// Any static environment variables</span>
  <span class="nx">environment</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">PORT</span> <span class="p">=</span> <span class="mi">5000</span> <span class="c1">// Defaults to 80</span>
  <span class="p">}</span>

  <span class="c1">// The GitHub repository that hosts the application code</span>
  <span class="nx">github_repository</span> <span class="p">=</span> <span class="s2">"&lt;organisation&gt;/&lt;repository&gt;"</span>

  <span class="c1">// Set to true if the GitHub repository contains both an</span>
  <span class="c1">// application and a background task.</span>
  <span class="nx">github_repository_dual</span> <span class="p">=</span> <span class="kc">false</span>

  <span class="c1">// The application healthcheck path and timeout</span>
  <span class="nx">healthcheck</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">endpoint</span> <span class="p">=</span> <span class="s2">"/"</span>
    <span class="nx">timeout</span> <span class="p">=</span> <span class="s2">"30"</span>
  <span class="p">}</span>

  <span class="c1">// Minimum and maximum number of application instances</span>
  <span class="c1">// The auto-scaling configuration scales the initial</span>
  <span class="c1">// number on 60% CPU Utilisation</span>
  <span class="nx">instances</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">minimum</span> <span class="p">=</span> <span class="mi">1</span>
    <span class="nx">maximum</span> <span class="p">=</span> <span class="mi">2</span>
    <span class="nx">initial</span> <span class="p">=</span> <span class="mi">1</span>
  <span class="p">}</span>

  <span class="c1">// The resources needed per application instance</span>
  <span class="nx">resources</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">memory</span>      <span class="p">=</span> <span class="mi">1024</span>
    <span class="nx">cpu_credits</span> <span class="p">=</span> <span class="mi">20</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>Add a new application block in <code>main_apps.tf</code>, replacing attributes as required.</li>
</ul>
<div class="highlight"><pre class="highlight hcl" tabindex="0"><code><span class="nx">module</span> <span class="s2">"application_&lt;name&gt;"</span> <span class="p">{</span>
  <span class="nx">source</span> <span class="p">=</span> <span class="s2">"./modules/application"</span>

  <span class="c1">// Application name</span>
  <span class="nx">name</span>                   <span class="p">=</span> <span class="s2">"&lt;name&gt;"</span>

  <span class="c1">// The environment this application is deployed to (do not change)</span>
  <span class="nx">stage</span>                  <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">stage</span>

  <span class="c1">// All resources created by this module with have their names</span>
  <span class="c1">// prefixed with the string here.</span>
  <span class="nx">resource_prefix</span>        <span class="p">=</span> <span class="s2">"${var.stage}-&lt;name&gt;"</span>

  <span class="c1">// The ECS cluster this application is deployed to</span>
  <span class="nx">cluster</span>                <span class="p">=</span> <span class="nx">module</span><span class="err">.</span><span class="nx">cluster</span><span class="err">.</span><span class="nx">cluster</span>
  <span class="c1">// Tags associated with</span>
  <span class="nx">tags</span>                   <span class="p">=</span> <span class="nx">module</span><span class="err">.</span><span class="nx">tags</span><span class="err">.</span><span class="nx">computed</span>
  <span class="c1">// The environment variables to expose to the application</span>
  <span class="nx">environment</span>            <span class="p">=</span> <span class="nx">merge</span><span class="err">(</span>
    <span class="nx">module</span><span class="err">.</span><span class="nx">storage</span><span class="err">.</span><span class="nx">environment</span><span class="err">,</span>
    <span class="nx">local</span><span class="err">.</span><span class="nx">applications</span><span class="p">[</span><span class="s2">"&lt;name&gt;"</span><span class="p">]</span><span class="err">.</span><span class="nx">environment</span><span class="err">,</span>
  <span class="err">)</span>
  <span class="c1">// The stored secrets to inject into the application environment</span>
  <span class="nx">secrets</span>                <span class="p">=</span> <span class="nx">module</span><span class="err">.</span><span class="nx">storage</span><span class="err">.</span><span class="nx">secrets</span>
  <span class="c1">// var.deployment_approval set to a list of users will enforce approvals</span>
  <span class="c1">//   to deploy to this environment</span>
  <span class="nx">deployment_approval</span>    <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">deployment_approval</span>

  <span class="c1">// These are set via the `locals.application_defaults` section in `variables.tf`</span>
  <span class="nx">github_repository</span>      <span class="p">=</span> <span class="nx">local</span><span class="err">.</span><span class="nx">applications</span><span class="p">[</span><span class="s2">"&lt;name&gt;"</span><span class="p">]</span><span class="err">.</span><span class="nx">github_repository</span>
  <span class="nx">github_repository_dual</span> <span class="p">=</span> <span class="nx">local</span><span class="err">.</span><span class="nx">applications</span><span class="p">[</span><span class="s2">"&lt;name&gt;"</span><span class="p">]</span><span class="err">.</span><span class="nx">github_repository_dual</span>
  <span class="nx">healthcheck</span>            <span class="p">=</span> <span class="nx">local</span><span class="err">.</span><span class="nx">applications</span><span class="p">[</span><span class="s2">"&lt;name&gt;"</span><span class="p">]</span><span class="err">.</span><span class="nx">healthcheck</span>
  <span class="nx">instances</span>              <span class="p">=</span> <span class="nx">local</span><span class="err">.</span><span class="nx">applications</span><span class="p">[</span><span class="s2">"&lt;name&gt;"</span><span class="p">]</span><span class="err">.</span><span class="nx">instances</span>
  <span class="nx">resources</span>              <span class="p">=</span> <span class="nx">local</span><span class="err">.</span><span class="nx">applications</span><span class="p">[</span><span class="s2">"&lt;name&gt;"</span><span class="p">]</span><span class="err">.</span><span class="nx">resources</span>
  <span class="nx">access</span>                 <span class="p">=</span> <span class="nx">merge</span><span class="err">(</span>
    <span class="nx">local</span><span class="err">.</span><span class="nx">applications</span><span class="p">[</span><span class="s2">"&lt;name&gt;"</span><span class="p">]</span><span class="err">.</span><span class="nx">access</span><span class="err">,</span>
    <span class="p">{</span>
      <span class="nx">certificate_arn</span> <span class="p">=</span> <span class="nx">module</span><span class="err">.</span><span class="nx">domain</span><span class="err">.</span><span class="nx">certificate_arn</span>
      <span class="nx">zone_id</span>         <span class="p">=</span> <span class="nx">module</span><span class="err">.</span><span class="nx">domain</span><span class="err">.</span><span class="nx">zone_id</span>
    <span class="p">}</span>
  <span class="err">)</span>

  <span class="c1">// EFS volumes to mount for this application</span>
  <span class="c1">//   (must set network mode to awsvpc)</span>
  <span class="nx">volumes</span>                <span class="p">=</span> <span class="p">{</span>
    <span class="nx">datasets</span> <span class="p">=</span> <span class="nx">merge</span><span class="err">(</span>
      <span class="nx">module</span><span class="err">.</span><span class="nx">storage</span><span class="err">.</span><span class="nx">files</span><span class="err">.</span><span class="nx">datasets</span><span class="err">,</span>
      <span class="c1">// Add this if you wish the volume to be mounted read-only</span>
      <span class="p">{</span>
          <span class="nx">readonly</span> <span class="p">=</span> <span class="kc">true</span>
      <span class="p">}</span>
    <span class="err">)</span>
  <span class="p">}</span>

  <span class="c1">// Additional IAM permissions, see `outputs.tf` in `modules/storage`</span>
  <span class="c1">//   for a list of permissions</span>
  <span class="nx">additional_permissions</span> <span class="p">=</span> <span class="nx">merge</span><span class="err">(</span><span class="nx">module</span><span class="err">.</span><span class="nx">storage</span><span class="err">.</span><span class="nx">permissions</span><span class="err">.</span><span class="nx">efs_read</span><span class="err">)</span>

  <span class="nx">network</span> <span class="p">=</span> <span class="p">{</span>
    <span class="c1">// Set to awsvpc if you need to mount a volume, bridge otherwise</span>
    <span class="nx">mode</span>            <span class="p">=</span> <span class="s2">"awsvpc"</span>
    <span class="nx">vpc_id</span>          <span class="p">=</span> <span class="nx">module</span><span class="err">.</span><span class="nx">network</span><span class="err">.</span><span class="nx">vpc_id</span>
    <span class="nx">subnets</span>         <span class="p">=</span> <span class="nx">module</span><span class="err">.</span><span class="nx">network</span><span class="err">.</span><span class="nx">subnet_public_ids</span>
    <span class="nx">security_groups</span> <span class="p">=</span> <span class="p">[</span><span class="nx">module</span><span class="err">.</span><span class="nx">network</span><span class="err">.</span><span class="nx">security_group_public_id</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>Run terraform apply</li>
<li>Check that the service is running on the appropriate domain name, if it is you will see a holding page.</li>
<li>Update the slackbot token at <code>/&lt;environment&gt;-&lt;application&gt;/notifications/slack-token</code> in AWS SSM</li>
<li>If configured with a GitHub repository add a deployment workflow to the repo,
otherwise you need only authenticate using the details under <code>/&lt;environment&gt;-&lt;name&gt;/deployer/access_*</code>
and push a built docker image to the</li>
</ul>
<p><strong>GitHub deployment workflow (Application Only)</strong></p>
<div class="highlight"><pre class="highlight yaml" tabindex="0"><code><span class="na">name</span><span class="pi">:</span> <span class="s">Deploy</span>
<span class="na">on</span><span class="pi">:</span>
  <span class="na">push</span><span class="pi">:</span>
    <span class="na">branches</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">main</span><span class="pi">]</span>
  <span class="na">workflow_dispatch</span><span class="pi">:</span>
    <span class="na">inputs</span><span class="pi">:</span>
      <span class="na">environment</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">environment</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">The environment to deploy to.</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="c1"># Include any tests or audits in jobs prior to detect-environments.</span>
  <span class="na">detect-environments</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">needs</span><span class="pi">:</span> <span class="pi">[]</span> <span class="c1"># Add any previous jobs here</span>
    <span class="na">outputs</span><span class="pi">:</span>
      <span class="na">environments</span><span class="pi">:</span> <span class="s">${{ steps.environments.outputs.result }}</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/github-script@v6</span>
        <span class="na">id</span><span class="pi">:</span> <span class="s">environments</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">github-token</span><span class="pi">:</span> <span class="s">${{ secrets.GITHUB_TOKEN }}</span>
          <span class="na">result-encoding</span><span class="pi">:</span> <span class="s">json</span>
          <span class="na">script</span><span class="pi">:</span> <span class="pi">|</span>
            <span class="s">if (context.payload?.inputs?.environment) return [context.payload?.inputs?.environment];</span>
            <span class="s">const {data: {environments}} =</span>
              <span class="s">await github.request(`GET /repos/${process.env.GITHUB_REPOSITORY}/environments`);</span>
            <span class="s">return environments.map(e =&gt; e.name)</span>

  <span class="na">deploy</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">env</span><span class="pi">:</span>
      <span class="na">DOCKER_REPO</span><span class="pi">:</span> <span class="s">${{ secrets.DEPLOY_DOCKER_REPOSITORY }}</span>
    <span class="na">needs</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">detect-environments</span><span class="pi">]</span>
    <span class="na">strategy</span><span class="pi">:</span>
      <span class="na">matrix</span><span class="pi">:</span>
        <span class="na">environment</span><span class="pi">:</span> <span class="s">${{ fromJSON(needs.detect-environments.outputs.environments) }}</span>
    <span class="na">environment</span><span class="pi">:</span> <span class="s">${{ matrix.environment }}</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v3</span>
      <span class="pi">-</span> <span class="na">id</span><span class="pi">:</span> <span class="s">vars</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">echo "sha_short=$(git rev-parse --short HEAD)" &gt;&gt; $GITHUB_OUTPUT</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">sudo apt-get update</span>
          <span class="s">sudo apt-get install -y rsync</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">aws-actions/configure-aws-credentials@v1-node16</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">aws-access-key-id</span><span class="pi">:</span> <span class="s">${{ secrets.DEPLOY_AWS_ACCESS_KEY_ID }}</span>
          <span class="na">aws-secret-access-key</span><span class="pi">:</span> <span class="s">${{ secrets.DEPLOY_AWS_SECRET_ACCESS_KEY }}</span>
          <span class="na">aws-region</span><span class="pi">:</span> <span class="s">eu-west-2</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">aws-actions/amazon-ecr-login@v1</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker pull $DOCKER_REPO:latest</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker build -t $DOCKER_REPO:${{ steps.vars.outputs.sha_short }} .</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker tag $DOCKER_REPO:${{ steps.vars.outputs.sha_short }} $DOCKER_REPO:latest</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker push $DOCKER_REPO:${{ steps.vars.outputs.sha_short }}</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker push $DOCKER_REPO:latest</span>
</code></pre></div><h3 id="add-a-new-background-task">Add a new background task</h3>
<p>To create a new background task in the terraform configuration, you will need to know the following:</p>

<ul>
<li>The <strong>GitHub repository</strong> (under the <a href="https://github.com/digital-land">digital-land</a> organisation) hosting the task code.</li>
<li>A list of events that should trigger a background task run (currently only s3 events are supported).</li>
<li>An estimate of the <strong>memory usage</strong> of the task.</li>
<li>A list of the task <strong>environment variables</strong>.</li>
<li>If the task needs access to the SQLite or MBTiles files.</li>
</ul>
<p>Add a new section to <code>variables.tf</code> under <code>locals.task_defaults</code>, replacing attributes as required.</p>
<div class="highlight"><pre class="highlight hcl" tabindex="0"><code><span class="err">&lt;</span><span class="nx">name</span><span class="err">&gt;</span> <span class="err">=</span> <span class="p">{</span>
  <span class="c1">// The GitHub repository that hosts the background task code</span>
  <span class="nx">github_repository</span> <span class="p">=</span> <span class="s2">"&lt;organisation&gt;/&lt;repository&gt;"</span>

  <span class="c1">// Set to true if the GitHub repository contains both a</span>
  <span class="c1">// background task and an application.</span>
  <span class="nx">github_repository_dual</span> <span class="p">=</span> <span class="kc">false</span>

  <span class="c1">// The resources needed per background task invocation</span>
  <span class="nx">resources</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">memory</span>      <span class="p">=</span> <span class="mi">8192</span>
    <span class="nx">cpu_credits</span> <span class="p">=</span> <span class="mi">1024</span>
  <span class="p">}</span>

  <span class="c1">// A map of the events that should trigger this task</span>
  <span class="nx">triggers</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">entity</span><span class="err">-</span><span class="nx">uploaded</span> <span class="p">=</span> <span class="p">{</span>
      <span class="c1">// The events that trigger the task</span>
      <span class="nx">events</span> <span class="p">=</span> <span class="p">[</span><span class="s2">"PutObject"</span><span class="p">,</span> <span class="s2">"CompleteMultipartUpload"</span><span class="p">]</span>
      <span class="c1">// The S3 bucket to watch for events</span>
      <span class="nx">bucket</span> <span class="p">=</span> <span class="s2">"${var.stage}-collection-data"</span>
      <span class="c1">// The keys of S3 objects to watch for</span>
      <span class="nx">watch</span>  <span class="p">=</span> <span class="p">[</span><span class="s2">"/entity-builder/dataset/entity.sqlite3"</span><span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>Add a new task block in <code>main_tasks.tf</code>, replacing attributes as required.</li>
</ul>
<div class="highlight"><pre class="highlight hcl" tabindex="0"><code><span class="nx">module</span> <span class="s2">"task_&lt;name&gt;"</span> <span class="p">{</span>
  <span class="nx">source</span> <span class="p">=</span> <span class="s2">"./modules/application-task"</span>

  <span class="c1">// Application name</span>
  <span class="nx">name</span>                   <span class="p">=</span> <span class="s2">"&lt;name&gt;"</span>

  <span class="c1">// The environment this task is deployed to (do not change)</span>
  <span class="nx">stage</span>                  <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">stage</span>

  <span class="c1">// All resources created by this module with have their names</span>
  <span class="c1">// prefixed with the string here.</span>
  <span class="nx">resource_prefix</span>        <span class="p">=</span> <span class="s2">"${var.stage}-&lt;name&gt;"</span>

  <span class="c1">// The ECS cluster this task is deployed to</span>
  <span class="nx">cluster</span>                <span class="p">=</span> <span class="nx">module</span><span class="err">.</span><span class="nx">cluster</span><span class="err">.</span><span class="nx">cluster</span>
  <span class="c1">// Tags associated with</span>
  <span class="nx">tags</span>                   <span class="p">=</span> <span class="nx">module</span><span class="err">.</span><span class="nx">tags</span><span class="err">.</span><span class="nx">computed</span>
  <span class="c1">// The environment variables to expose to the task</span>
  <span class="nx">environment</span>            <span class="p">=</span> <span class="nx">merge</span><span class="err">(</span>
    <span class="nx">module</span><span class="err">.</span><span class="nx">storage</span><span class="err">.</span><span class="nx">environment</span><span class="err">,</span>
    <span class="nx">local</span><span class="err">.</span><span class="nx">tasks</span><span class="p">[</span><span class="s2">"&lt;name&gt;"</span><span class="p">]</span><span class="err">.</span><span class="nx">environment</span><span class="err">,</span>
  <span class="err">)</span>
  <span class="c1">// The stored secrets to inject into the task environment</span>
  <span class="nx">secrets</span>                <span class="p">=</span> <span class="nx">module</span><span class="err">.</span><span class="nx">storage</span><span class="err">.</span><span class="nx">secrets</span>
  <span class="c1">// var.deployment_approval set to a list of users will enforce approvals</span>
  <span class="c1">//   to deploy to this environment</span>
  <span class="nx">deployment_approval</span>    <span class="p">=</span> <span class="nx">var</span><span class="err">.</span><span class="nx">deployment_approval</span>

  <span class="c1">// These are set via the `locals.task_defaults` section in `variables.tf`</span>
  <span class="nx">github_repository</span>      <span class="p">=</span> <span class="nx">local</span><span class="err">.</span><span class="nx">tasks</span><span class="p">[</span><span class="s2">"&lt;name&gt;"</span><span class="p">]</span><span class="err">.</span><span class="nx">github_repository</span>
  <span class="nx">github_repository_dual</span> <span class="p">=</span> <span class="nx">local</span><span class="err">.</span><span class="nx">tasks</span><span class="p">[</span><span class="s2">"&lt;name&gt;"</span><span class="p">]</span><span class="err">.</span><span class="nx">github_repository_dual</span>
  <span class="nx">triggers</span>               <span class="p">=</span> <span class="nx">local</span><span class="err">.</span><span class="nx">tasks</span><span class="p">[</span><span class="s2">"&lt;name&gt;"</span><span class="p">]</span><span class="err">.</span><span class="nx">triggers</span>
  <span class="nx">instances</span>              <span class="p">=</span> <span class="nx">local</span><span class="err">.</span><span class="nx">tasks</span><span class="p">[</span><span class="s2">"&lt;name&gt;"</span><span class="p">]</span><span class="err">.</span><span class="nx">instances</span>
  <span class="nx">resources</span>              <span class="p">=</span> <span class="nx">local</span><span class="err">.</span><span class="nx">tasks</span><span class="p">[</span><span class="s2">"&lt;name&gt;"</span><span class="p">]</span><span class="err">.</span><span class="nx">resources</span>

  <span class="c1">// EFS volumes to mount for this task</span>
  <span class="nx">volumes</span>                <span class="p">=</span> <span class="p">{</span>
    <span class="nx">datasets</span> <span class="p">=</span> <span class="nx">merge</span><span class="err">(</span>
      <span class="nx">module</span><span class="err">.</span><span class="nx">storage</span><span class="err">.</span><span class="nx">files</span><span class="err">.</span><span class="nx">datasets</span><span class="err">,</span>
      <span class="c1">// Add this if you wish the volume to be mounted read-only</span>
      <span class="p">{</span>
          <span class="nx">readonly</span> <span class="p">=</span> <span class="kc">true</span>
      <span class="p">}</span>
    <span class="err">)</span>
  <span class="p">}</span>

  <span class="c1">// Additional IAM permissions, see `outputs.tf` in `modules/storage`</span>
  <span class="c1">//   for a list of permissions</span>
  <span class="nx">additional_permissions</span> <span class="p">=</span> <span class="nx">merge</span><span class="err">(</span><span class="nx">module</span><span class="err">.</span><span class="nx">storage</span><span class="err">.</span><span class="nx">permissions</span><span class="err">.</span><span class="nx">efs_read</span><span class="err">)</span>

  <span class="nx">network</span> <span class="p">=</span> <span class="p">{</span>
    <span class="nx">vpc_id</span>          <span class="p">=</span> <span class="nx">module</span><span class="err">.</span><span class="nx">network</span><span class="err">.</span><span class="nx">vpc_id</span>
    <span class="nx">subnets</span>         <span class="p">=</span> <span class="nx">module</span><span class="err">.</span><span class="nx">network</span><span class="err">.</span><span class="nx">subnet_public_ids</span>
    <span class="nx">security_groups</span> <span class="p">=</span> <span class="p">[</span><span class="nx">module</span><span class="err">.</span><span class="nx">network</span><span class="err">.</span><span class="nx">security_group_public_id</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ul>
<li>Run terraform apply</li>
<li>If configured with a GitHub repository add a deployment workflow to the repo,
otherwise you need only authenticate using the details under <code>/&lt;environment&gt;-&lt;name&gt;/deployer/access_*</code>
and push a built docker image to the</li>
</ul>
<p><strong>GitHub deployment workflow (Task Only)</strong></p>
<div class="highlight"><pre class="highlight yaml" tabindex="0"><code><span class="na">name</span><span class="pi">:</span> <span class="s">Deploy</span>
<span class="na">on</span><span class="pi">:</span>
  <span class="na">push</span><span class="pi">:</span>
    <span class="na">branches</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">main</span><span class="pi">]</span>
  <span class="na">workflow_dispatch</span><span class="pi">:</span>
    <span class="na">inputs</span><span class="pi">:</span>
      <span class="na">environment</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">environment</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">The environment to deploy to.</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">detect-environments</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">outputs</span><span class="pi">:</span>
      <span class="na">environments</span><span class="pi">:</span> <span class="s">${{ steps.environments.outputs.result }}</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/github-script@v6</span>
        <span class="na">id</span><span class="pi">:</span> <span class="s">environments</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">github-token</span><span class="pi">:</span> <span class="s">${{ secrets.GITHUB_TOKEN }}</span>
          <span class="na">result-encoding</span><span class="pi">:</span> <span class="s">json</span>
          <span class="na">script</span><span class="pi">:</span> <span class="pi">|</span>
            <span class="s">if (context.payload?.inputs?.environment) return [context.payload?.inputs?.environment];</span>
            <span class="s">const {data: {environments}} =</span>
              <span class="s">await github.request(`GET /repos/${process.env.GITHUB_REPOSITORY}/environments`);</span>
            <span class="s">return environments.map(e =&gt; e.name)</span>

  <span class="na">deploy</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">env</span><span class="pi">:</span>
      <span class="na">DOCKER_REPO</span><span class="pi">:</span> <span class="s">${{ secrets.DEPLOY_DOCKER_REPOSITORY }}</span>
    <span class="na">needs</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">detect-environments</span><span class="pi">]</span>
    <span class="na">strategy</span><span class="pi">:</span>
      <span class="na">matrix</span><span class="pi">:</span>
        <span class="na">environment</span><span class="pi">:</span> <span class="s">${{ fromJSON(needs.detect-environments.outputs.environments) }}</span>
    <span class="na">environment</span><span class="pi">:</span> <span class="s">${{ matrix.environment }}</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v3</span>
      <span class="pi">-</span> <span class="na">id</span><span class="pi">:</span> <span class="s">vars</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">echo "sha_short=$(git rev-parse --short HEAD)" &gt;&gt; $GITHUB_OUTPUT</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">sudo apt-get update</span>
          <span class="s">sudo apt-get install -y rsync</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">aws-actions/configure-aws-credentials@v1-node16</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">aws-access-key-id</span><span class="pi">:</span> <span class="s">${{ secrets.DEPLOY_AWS_ACCESS_KEY_ID }}</span>
          <span class="na">aws-secret-access-key</span><span class="pi">:</span> <span class="s">${{ secrets.DEPLOY_AWS_SECRET_ACCESS_KEY }}</span>
          <span class="na">aws-region</span><span class="pi">:</span> <span class="s">eu-west-2</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">aws-actions/amazon-ecr-login@v1</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker pull $DOCKER_REPO:latest</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker build -t $DOCKER_REPO:${{ steps.vars.outputs.sha_short }} .</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker tag $DOCKER_REPO:${{ steps.vars.outputs.sha_short }} $DOCKER_REPO:latest</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker push $DOCKER_REPO:${{ steps.vars.outputs.sha_short }}</span>
      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker push $DOCKER_REPO:latest</span>
</code></pre></div><h4 id="deploy-a-task-and-application">Deploy a Task and Application</h4>
<p>To deploy both a task and application from the same repository, use the following two github actions workflows.</p>
<p><strong><code>.github/workflows/deploy-application.yml</code></strong></p>
<div class="highlight"><pre class="highlight yaml" tabindex="0"><code><span class="na">name</span><span class="pi">:</span> <span class="s">Deploy Application</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="na">push</span><span class="pi">:</span>
    <span class="na">branches</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">main</span><span class="pi">]</span>
    <span class="c1"># Put a path here for the folder to watch for changes</span>
    <span class="na">paths</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">application/</span><span class="pi">]</span>
  <span class="na">workflow_dispatch</span><span class="pi">:</span>
    <span class="na">inputs</span><span class="pi">:</span>
      <span class="na">environment</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">environment</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">The environment to deploy to (select an -application environment).</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">detect-environments</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">outputs</span><span class="pi">:</span>
      <span class="na">environments</span><span class="pi">:</span> <span class="s">${{ steps.environments.outputs.result }}</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/github-script@v6</span>
        <span class="na">id</span><span class="pi">:</span> <span class="s">environments</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">github-token</span><span class="pi">:</span> <span class="s">${{ secrets.GITHUB_TOKEN }}</span>
          <span class="na">result-encoding</span><span class="pi">:</span> <span class="s">json</span>
          <span class="na">script</span><span class="pi">:</span> <span class="pi">|</span>
            <span class="s">if (context.payload?.inputs?.environment) return [context.payload?.inputs?.environment];</span>
            <span class="s">const {data: {environments}} =</span>
              <span class="s">await github.request(`GET /repos/${process.env.GITHUB_REPOSITORY}/environments`);</span>
            <span class="s">return environments.map(e =&gt; e.name).filter(e =&gt; e.indexOf('-application') != -1)</span>

  <span class="na">deploy</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">env</span><span class="pi">:</span>
      <span class="na">DOCKER_REPO</span><span class="pi">:</span> <span class="s">${{ secrets.DEPLOY_DOCKER_REPOSITORY }}</span>
    <span class="na">needs</span><span class="pi">:</span> <span class="pi">[</span> <span class="nv">detect-environments</span> <span class="pi">]</span>
    <span class="na">strategy</span><span class="pi">:</span>
      <span class="na">matrix</span><span class="pi">:</span>
        <span class="na">environment</span><span class="pi">:</span> <span class="s">${{ fromJSON(needs.detect-environments.outputs.environments) }}</span>
    <span class="na">environment</span><span class="pi">:</span> <span class="s">${{ matrix.environment }}</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v3</span>

      <span class="pi">-</span> <span class="na">id</span><span class="pi">:</span> <span class="s">vars</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">echo "sha_short=$(git rev-parse --short HEAD)" &gt;&gt; $GITHUB_OUTPUT</span>

      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"</span>
          <span class="s">unzip -q awscliv2.zip</span>
          <span class="s">sudo ./aws/install --update</span>
          <span class="s">sudo apt-get update</span>
          <span class="s">sudo apt-get install -y rsync</span>

      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">aws-actions/configure-aws-credentials@v1-node16</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">aws-access-key-id</span><span class="pi">:</span> <span class="s">${{ secrets.DEPLOY_AWS_ACCESS_KEY_ID }}</span>
          <span class="na">aws-secret-access-key</span><span class="pi">:</span> <span class="s">${{ secrets.DEPLOY_AWS_SECRET_ACCESS_KEY }}</span>
          <span class="na">aws-region</span><span class="pi">:</span> <span class="s">eu-west-2</span>

      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">aws-actions/amazon-ecr-login@v1</span>

      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker pull $DOCKER_REPO:latest || echo "no current latest image"</span>

      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker build -t $DOCKER_REPO:${{ steps.vars.outputs.sha_short }} .</span>
        <span class="na">working-directory</span><span class="pi">:</span> <span class="s">./application</span>

      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker tag $DOCKER_REPO:${{ steps.vars.outputs.sha_short }} $DOCKER_REPO:latest</span>

      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker push $DOCKER_REPO:${{ steps.vars.outputs.sha_short }}</span>

      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker push $DOCKER_REPO:latest</span>
</code></pre></div><p><strong><code>.github/workflows/deploy-task.yml</code></strong></p>
<div class="highlight"><pre class="highlight yaml" tabindex="0"><code><span class="na">name</span><span class="pi">:</span> <span class="s">Deploy Task</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="na">push</span><span class="pi">:</span>
    <span class="na">branches</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">main</span><span class="pi">]</span>
    <span class="c1"># Put a path here for the folder to watch for changes</span>
    <span class="na">paths</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">task/</span><span class="pi">]</span>
  <span class="na">workflow_dispatch</span><span class="pi">:</span>
    <span class="na">inputs</span><span class="pi">:</span>
      <span class="na">environment</span><span class="pi">:</span>
        <span class="na">type</span><span class="pi">:</span> <span class="s">environment</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">The environment to deploy to (select an -application environment).</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">detect-environments</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">outputs</span><span class="pi">:</span>
      <span class="na">environments</span><span class="pi">:</span> <span class="s">${{ steps.environments.outputs.result }}</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/github-script@v6</span>
        <span class="na">id</span><span class="pi">:</span> <span class="s">environments</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">github-token</span><span class="pi">:</span> <span class="s">${{ secrets.GITHUB_TOKEN }}</span>
          <span class="na">result-encoding</span><span class="pi">:</span> <span class="s">json</span>
          <span class="na">script</span><span class="pi">:</span> <span class="pi">|</span>
            <span class="s">if (context.payload?.inputs?.environment) return [context.payload?.inputs?.environment];</span>
            <span class="s">const {data: {environments}} =</span>
              <span class="s">await github.request(`GET /repos/${process.env.GITHUB_REPOSITORY}/environments`);</span>
            <span class="s">return environments.map(e =&gt; e.name).filter(e =&gt; e.indexOf('-application') != -1)</span>

  <span class="na">deploy</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">env</span><span class="pi">:</span>
      <span class="na">DOCKER_REPO</span><span class="pi">:</span> <span class="s">${{ secrets.DEPLOY_DOCKER_REPOSITORY }}</span>
    <span class="na">needs</span><span class="pi">:</span> <span class="pi">[</span> <span class="nv">detect-environments</span> <span class="pi">]</span>
    <span class="na">strategy</span><span class="pi">:</span>
      <span class="na">matrix</span><span class="pi">:</span>
        <span class="na">environment</span><span class="pi">:</span> <span class="s">${{ fromJSON(needs.detect-environments.outputs.environments) }}</span>
    <span class="na">environment</span><span class="pi">:</span> <span class="s">${{ matrix.environment }}</span>
    <span class="na">steps</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v3</span>

      <span class="pi">-</span> <span class="na">id</span><span class="pi">:</span> <span class="s">vars</span>
        <span class="na">run</span><span class="pi">:</span> <span class="s">echo "sha_short=$(git rev-parse --short HEAD)" &gt;&gt; $GITHUB_OUTPUT</span>

      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
          <span class="s">curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"</span>
          <span class="s">unzip -q awscliv2.zip</span>
          <span class="s">sudo ./aws/install --update</span>
          <span class="s">sudo apt-get update</span>
          <span class="s">sudo apt-get install -y rsync</span>

      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">aws-actions/configure-aws-credentials@v1-node16</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">aws-access-key-id</span><span class="pi">:</span> <span class="s">${{ secrets.DEPLOY_AWS_ACCESS_KEY_ID }}</span>
          <span class="na">aws-secret-access-key</span><span class="pi">:</span> <span class="s">${{ secrets.DEPLOY_AWS_SECRET_ACCESS_KEY }}</span>
          <span class="na">aws-region</span><span class="pi">:</span> <span class="s">eu-west-2</span>

      <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">aws-actions/amazon-ecr-login@v1</span>

      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker pull $DOCKER_REPO:latest || echo "no current latest image"</span>

      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker build -t $DOCKER_REPO:${{ steps.vars.outputs.sha_short }} .</span>
        <span class="na">working-directory</span><span class="pi">:</span> <span class="s">./task</span>

      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker tag $DOCKER_REPO:${{ steps.vars.outputs.sha_short }} $DOCKER_REPO:latest</span>

      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker push $DOCKER_REPO:${{ steps.vars.outputs.sha_short }}</span>

      <span class="pi">-</span> <span class="na">run</span><span class="pi">:</span> <span class="s">docker push $DOCKER_REPO:latest</span>
</code></pre></div>
            
          </main>

          <aside>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">


      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      > Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="javascripts/application.js"></script>
  </body>
</html>

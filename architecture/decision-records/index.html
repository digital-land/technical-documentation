<!doctype html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>Architecture Decision Records - Planning Data</title>

    <link href="../../stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="digital-land.github.io/architecture/decision-records/">

      <meta name="robots" content="noindex" />
      <meta name="twitter:card" content="summary" />
      <meta name="twitter:image" content="digital-land.github.io/images/govuk-large.png" />
      <meta name="twitter:title" content="Architecture Decision Records - Planning Data" />
      <meta name="twitter:url" content="digital-land.github.io/architecture/decision-records/" />

      <meta property="og:image" content="digital-land.github.io/images/govuk-large.png" />
      <meta property="og:site_name" content="Planning Data" />
      <meta property="og:title" content="Architecture Decision Records" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="digital-land.github.io/architecture/decision-records/" />

    
  </head>

  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link" data-module="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="https://planning.data.gov.uk" class="govuk-header__link govuk-header__link--homepage">
        <span class="govuk-header__product-name">
          Planning Data
        </span>
      </a>
        <strong class="govuk-tag">Beta</strong>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <button type="button" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </button>
        </div>

      <div class="app-pane__body" data-module="in-page-navigation">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents" tabindex="-1" aria-label="Table of contents" role="dialog">
              <div class="search" data-module="search" data-path-to-site-root="../../">
  <form action="https://www.google.co.uk/search" method="get" role="search" class="search__form govuk-!-margin-bottom-4">
    <input type="hidden" name="as_sitesearch" value="digital-land.github.io"/>
    <label class="govuk-label search__label" for="search" aria-hidden="true">
      Search (via Google)
    </label>
    <input
      type="text"
      id="search" name="q"
      class="govuk-input govuk-!-margin-bottom-0 search__input"
      aria-controls="search-results"
      placeholder="Search">
    <button type="submit" class="search__button">Search</button>
  </form>
</div>

              <button type="button" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></button>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading" data-module="collapsible-navigation">
                      <ul>
  <li>
    <a href="../../index.html"><span>Planning Data Service</span></a>
  </li>
  <li>
    <a href="../../documentation/index.html"><span>Documentation</span></a>
  </li>
<li><a href="../../architecture/index.html"><span>Architecture</span></a>
<ul>
  <li>
    <a href="../../architecture/decision-records/index.html"><span>Architecture Decision Records (ADRs)</span></a>
  </li>
<li><a href="../../architecture/design/index.html"><span>Solution design index</span></a>
<ul>
<li><a href="../../architecture/design/latest/index.html"><span>Solution design</span></a>
<ul>
  <li>
    <a href="../../architecture/design/latest/data-pipelines/index.html"><span>Solution design - Data Pipelines</span></a>
  </li>
  <li>
    <a href="../../architecture/design/latest/planning-data-platform/index.html"><span>Solution design - Planning Data Platform</span></a>
  </li>
  <li>
    <a href="../../architecture/design/latest/publish-service/index.html"><span>Solution design - Publish Service</span></a>
  </li>
</ul>
</li>
<li><a href="../../architecture/design/archive/index.html"><span>Solution design archive</span></a>
<ul>
  <li>
    <a href="../../architecture/design/archive/2022-11/index.html"><span>Solution design - November 2022</span></a>
  </li>
</ul>
</li>
<li><a href="../../architecture/design/proposals/index.html"><span>Open Design Proposals</span></a>
<ul>
  <li>
    <a href="../../architecture/design/proposals/template.html"><span>Open Design Proposal - 00X - Title (Template)</span></a>
  </li>
  <li>
    <a href="../../architecture/design/proposals/002-data-pipelines-migration/index.html"><span>Open Design Proposal 002 - Data Pipelines Migration</span></a>
  </li>
  <li>
    <a href="../../architecture/design/proposals/001-publish-async/index.html"><span>Open Design Proposal 001 - Publish service - Async</span></a>
  </li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
  <li>
    <a href="../../infrastructure.html"><span>Infrastructure</span></a>
  </li>
  <li>
    <a href="../../runbook.html"><span>Run Book</span></a>
  </li>
  <li>
    <a href="../../WorkingWithLPA_GIS.html"><span>Working with LPA GIS Systems</span></a>
  </li>
  <li>
    <a href="../../HowTos.html"><span>How-to Guides</span></a>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled" aria-label="Content" tabindex="0">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
            <h1 id="architecture-decision-records-adrs">Architecture Decision Records (ADRs)</h1>
<h2 id="1-record-architecture-decisions">1. Record architecture decisions</h2>
<p>Date: 2021-03-05</p>
<h4 id="status">Status</h4>
<p>Accepted</p>
<h4 id="context">Context</h4>
<p>We need to record the architectural decisions made on this project.</p>
<h4 id="decision">Decision</h4>
<p>We will use Architecture Decision Records, as
<a href="http://thinkrelevance.com/blog/2011/11/15/documenting-architecture-decisions">described by Michael Nygard</a>, starting by
recording some of our existing technical decisions, which we&rsquo;ll review as a team.</p>
<p>We&rsquo;ve elected to keep the source markdown files in the <code>content</code> directory to be consistent with our other <em>render</em>
repositories.</p>
<p>We can later tag decisions, and render them as HTML in the <code>doc</code> directory so they can be more easily searched and
navigated on the digital land site.</p>
<h4 id="consequences">Consequences</h4>
<p>See Michael Nygard&rsquo;s article, linked above. For a lightweight ADR toolset, see Nat Pryce&rsquo;s
<a href="https://github.com/npryce/adr-tools">adr-tools</a>.</p>
<h2 id="2-floating-package-dependencies">2. floating-package-dependencies</h2>
<p>Date: 2021-03-05</p>
<h4 id="2-floating-package-dependencies-status">Status</h4>
<p>Accepted</p>
<h4 id="2-floating-package-dependencies-context">Context</h4>
<p>We&rsquo;ve experienced conflicting package versions when between those installed by the <code>digital-land-python</code> repository, and
those pinned in a <code>requirements.txt</code>
file.</p>
<h4 id="2-floating-package-dependencies-decision">Decision</h4>
<p>List the smallest possible number of packages as dependencies, and don&rsquo;t pin the version of packages, as in this example
<code>requirements.txt</code> file:</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>-e git+https://github.com/digital-land/digital-land-python.git#egg=digital-land
</code></pre></div><p>We may move back to frozen, pinned packages in a <code>setup.py</code> once our core python code is more stable, or is packaged and
installed via PyPi.</p>
<h4 id="2-floating-package-dependencies-consequences">Consequences</h4>

<ul>
<li>Moving to unpinned versions reduces the risk of conflicting versions with those listed in other packages.</li>
<li>Reducing the number of dependencies makes it easier to undersand the packages directly required by a repository.</li>
<li>It&rsquo;s possible to break repository if it depends on a package installed as a dependency to another package, and that
implicit dependency is removed.</li>
</ul>
<h2 id="3-use-the-repository-pattern-to-access-a-database">3. Use the repository-pattern to access a database</h2>
<p>Date: 2021-03-05</p>
<h4 id="3-use-the-repository-pattern-to-access-a-database-status">Status</h4>
<p>Proposed</p>
<h4 id="3-use-the-repository-pattern-to-access-a-database-context">Context</h4>
<p>As we introduce a database into our architecture it will be useful to agree some access patterns so that we have a
shared understanding of what &ldquo;good&rdquo; looks like when writing code and performing code reviews. The key considerations for
choosing an approach include:</p>

<ul>
<li>testability; it should be easy to write unit tests without the need to connect to a real database</li>
<li>readability; it should be easy to write code that makes the database interactions easy to understand</li>
<li>encapsulation; all of the specific code/queries required to implement the underlying persistence technologies, should
be contained in their own module(s)</li>
</ul>
<p>The commonly used <em>Repository Pattern</em> provides access to the underlying persistence via an abstraction that is written
in the language of the domain. It gives the developer a clear interface that can be used to create a test double (likely
storing data in-memory) and encapsulates all queries relating to a single &ldquo;aggregate&rdquo; in one place.</p>
<p>NB An <em>aggregate</em> is a cluster of associated objects that we treat as a unit for the purpose of data changes</p>
<p><strong>Example</strong></p>
<p>Because Provenance requires a Fact in order to be meaningful, Fact and Provenance may be grouped together into a Fact
 aggregate, served from a single FactRepository. Another way to think about this is to consider how the data will be
 accessed. It is unlikely we would have a page per Provenance entry; it&rsquo;s just too fine grained to be useful. More
 likely is that at the lowest level there is a page per Fact, with the relevant Provenance listed as a form of
 &ldquo;history&rdquo;. We would also not expect external systems to reference individual entries of Provenance, but they may
 reference a specific Fact.</p>
<p>With that in mind, here is what an interface to FactRepository might look like:</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>class FactRepository:
    def add_entry_facts(self, entry)
        "add all facts from the provided entry to the repository"

    def find_by_resource(self, resource_hash)
        "return all facts that were contained in the specified resource"

    def find_by_entity(self, entity_ref)
        "return all facts relating to the specified entity"
</code></pre></div><h4 id="3-use-the-repository-pattern-to-access-a-database-decision">Decision</h4>
<p>Use the <a href="https://martinfowler.com/eaaCatalog/repository.html">repository pattern</a></p>
<h4 id="3-use-the-repository-pattern-to-access-a-database-consequences">Consequences</h4>

<ul>
<li>This facilitates unit testing where the repository can be replaced with an in memory store and easily populated with
test data.</li>
<li>It provides a readable interface to the underlying collections</li>
<li>Once in place, it is important that the repository is the only channel through which data is written or updated for a
given aggregate</li>
<li>It enables easier transition to different storage technologies</li>
</ul>
<h2 id="4-implement-plugins-using-pluggy">4. Implement plugins using pluggy</h2>
<p>Date: 2021-03-05</p>
<h4 id="4-implement-plugins-using-pluggy-status">Status</h4>
<p>Accepted</p>
<h4 id="4-implement-plugins-using-pluggy-context">Context</h4>
<p>The pipeline has the ability to name a <a href="https://digital-land.github.io/specification/field/plugin/">plugin</a> used to
configure different behaviour and extend the core pipeline code.</p>
<p>For example:</p>

<ul>
<li>a plugin value of <code>wfs</code> in the
<a href="https://github.com/digital-land/conservation-area-collection/blob/main/collection/endpoint.csv">collection/endpoint.csv</a>
file indicates the <a href="https://digital-land.github.io/specification/field/endpoint-url/">endpoint-url</a> is an
<a href="https://en.wikipedia.org/wiki/Web_Feature_Service">OGC Web Feature Service</a> endpoint, and the GML content, which is
 different each time we collect it, needs canonicalisation. Similar plugins are needed for APIs which are paginated,
 or require a SPARQL or other script.</li>
<li>a plugin value of <code>fixed</code> in the
<a href="https://github.com/digital-land/brownfield-land-collection/blob/main/pipeline/convert.csv">pipeline/convert.csv</a>
file indicates a fixed resouce file should be used instead of attempting to convert the collected resource file.</li>
<li>the brownfield-land pipeline
<a href="https://github.com/digital-land/brownfield-land-collection/blob/main/pipeline/plugins.py">has plugin code</a> to
harmonise an <a href="https://digital-land.github.io/specification/field/OrganisationURI/">OrganisationURI</a> value into the
CURIE needed by the <a href="https://digital-land.github.io/specification/field/organisation/">organisation</a> field.</li>
</ul>
<h4 id="4-implement-plugins-using-pluggy-decision">Decision</h4>
<p>We use the Python <a href="#">pluggy</a> framework these can either be run <em>instead of</em> or <em>as well as</em> the vanilla pipeline
functions. Rather than confuse the general purpose pipeline code with conditional branches to handle one specific case.
We can inject our own version of certain functions at run time.</p>
<p>The Python code currently may be migrated to a package in the future, so it can be shared across pipelines.</p>
<h4 id="4-implement-plugins-using-pluggy-consequences">Consequences</h4>

<ul>
<li>We have a consitent framework for using code from third-parties.</li>
<li>Our core code doesn&rsquo;t have to depend on dependencies only used in a small number of pipelines.</li>
<li>Plugins need to be written in Python, or have a Python wrapper.</li>
<li>Developers will need documentation to understand how the pluggy framework works.</li>
</ul>
<h2 id="5-load-external-frontend-assets-first">5. Load external frontend assets first</h2>
<p>Date: 2021-03-07</p>
<h4 id="5-load-external-frontend-assets-first-status">Status</h4>
<p>Accepted</p>
<h4 id="5-load-external-frontend-assets-first-context">Context</h4>
<p>The order the frontend assets are loaded matters.</p>
<p>We use a number of 3rd party assets, as well as writing our own CSS and JS. For example, our CSS builds on the GOV.UK
frontend CSS. Likewise, our JS builds on the GOV.UK frontend JS. Therefore we need to include the 3rd party assets
before our assets.</p>
<h4 id="5-load-external-frontend-assets-first-decision">Decision</h4>
<p>3rd party assets are loaded before Digital land frontend assets.</p>
<p>Add CSS link elements to the head, before <code>dl-frontend.css</code>. E.g.</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>{%- block dlCss %}
&lt;!-- link tags for 3rd party stylesheets go here --&gt;
{{ super() }} # this includes all the digital land defined stylesheets
{% endblock %}
</code></pre></div><p>Add Javascript to the end of the body, before <code>dl-frontend.js</code>. E.g.</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>{%- block bodyEndScripts %}
&lt;!-- script tags for 3rd party JS go here --&gt;
{{ super() }} # this includes all the digital land defined JS
{% endblock %}
</code></pre></div><p>There will be times when you choose to load JS in the head to help maintain the dependencies. For example, it makes
sense to keep the CSS and JS required for leaflet maps together.
<a href="https://github.com/digital-land/frontend/blob/main/digital_land_frontend/templates/partials/dl-map-assets.html">We load these in the head</a>.</p>
<h4 id="5-load-external-frontend-assets-first-consequences">Consequences</h4>

<ul>
<li>3rd party assets won&rsquo;t override our assets</li>
<li>Our CSS and JS can build on code inherited from 3rd party assets</li>
<li>Debugging is easier because we can trace the order CSS and JS is loaded</li>
<li>Using jinja blocks means we can maintain fine grain control on a specific page if we need to</li>
<li>Loading stylesheets in the head means the user should see the page content as you intended</li>
<li>Loading JS at the end of the page means failing JS will not block the page from loading. Important for our progressive
enhancement approach to JS</li>
</ul>
<h2 id="6-use-github-pages-for-our-content">6. Use Github pages for our content</h2>
<p>Date: 2021-03-08</p>
<h4 id="6-use-github-pages-for-our-content-status">Status</h4>
<p>Proposed</p>
<h4 id="6-use-github-pages-for-our-content-context">Context</h4>
<p>TODO</p>
<h4 id="6-use-github-pages-for-our-content-decision">Decision</h4>
<p>TODO</p>
<h4 id="6-use-github-pages-for-our-content-consequences">Consequences</h4>
<p>TODO</p>
<h2 id="7-provide-unique-ids-for-dataset-entries">7. Provide unique IDs for dataset entries</h2>
<p>Date: 2021-03-08</p>
<h4 id="7-provide-unique-ids-for-dataset-entries-status">Status</h4>
<p>Proposed</p>
<h4 id="7-provide-unique-ids-for-dataset-entries-context">Context</h4>
<p>TODO</p>
<h4 id="7-provide-unique-ids-for-dataset-entries-decision">Decision</h4>
<p>TODO</p>
<h4 id="7-provide-unique-ids-for-dataset-entries-consequences">Consequences</h4>
<p>TODO</p>
<h2 id="8-use-files-for-repositories-databases-as-indexes">8. Use files for repositories, databases as indexes</h2>
<p>Date: 2021-03-08</p>
<h4 id="8-use-files-for-repositories-databases-as-indexes-status">Status</h4>
<p>Proposed</p>
<h4 id="8-use-files-for-repositories-databases-as-indexes-context">Context</h4>
<p>TODO</p>
<h4 id="8-use-files-for-repositories-databases-as-indexes-decision">Decision</h4>
<p>TODO</p>
<h4 id="8-use-files-for-repositories-databases-as-indexes-consequences">Consequences</h4>
<p>TODO</p>
<h2 id="9-use-sqlite-for-data-packages">9. Use SQLite for data packages</h2>
<p>Date: 2021-03-08</p>
<h4 id="9-use-sqlite-for-data-packages-status">Status</h4>
<p>Proposed</p>
<h4 id="9-use-sqlite-for-data-packages-context">Context</h4>
<p>TODO</p>
<h4 id="9-use-sqlite-for-data-packages-decision">Decision</h4>
<p>TODO</p>
<h4 id="9-use-sqlite-for-data-packages-consequences">Consequences</h4>
<p>TODO</p>
<h2 id="10-use-the-entity-value-attribute-pattern-for-our-data-model">10. Use the Entity-Value-Attribute pattern for our data model</h2>
<p>Date: 2021-03-08</p>
<h4 id="10-use-the-entity-value-attribute-pattern-for-our-data-model-status">Status</h4>
<p>Proposed</p>
<h4 id="10-use-the-entity-value-attribute-pattern-for-our-data-model-context">Context</h4>
<p>We need a data model to represent the data we collect.</p>
<p>The model is likely to change frequently as we add new types of entity, each with potentially new attributes.
The model also needs to be be able to store the history of changes to an entity.
The same information may be found in multiple resources, we need to be able to cite the resources where each fact came
from, its provenance.</p>
<h4 id="10-use-the-entity-value-attribute-pattern-for-our-data-model-decision">Decision</h4>
<p>Load transformed resources into a <a href="https://en.wikipedia.org/wiki/Entity%E2%80%93attribute%E2%80%93value_model">Entity-attribute-model</a>.
The model should provide a &ldquo;fact&rdquo; identifier for each entity-attribute-value triple.</p>
<p><a href="https://www.flickr.com/photos/psd/50806905348/in/dateposted-public/" title="Different models">
<img src="https://live.staticflickr.com/65535/50806905348_9d613daea2_c.jpg" alt="Different models"></a></p>
<h4 id="10-use-the-entity-value-attribute-pattern-for-our-data-model-consequences">Consequences</h4>

<ul>
<li>The model may then be used to link a fact to the list of resources which provide the fact, and from the resources we
can show its provenance, when and from where the resource was collected.</li>
<li>Querying an EAV model is more complicated and expensive. We may need other models to render pages, these can be data
pacakges: see <a href="0009-use-sqlite-for-data-packages.md">9. Use SQLite for data packages</a>.</li>
<li>The specification can still be used to document, check, and control how we process data in this schema-less model.</li>
</ul>
<h2 id="11-avoid-git-submodules-wherever-possible">11. Avoid git submodules wherever possible</h2>
<p>Date: 2021-03-08</p>
<h4 id="11-avoid-git-submodules-wherever-possible-status">Status</h4>
<p>Proposed</p>
<h4 id="11-avoid-git-submodules-wherever-possible-context">Context</h4>
<p>Git submodules allow you to keep a Git repository as a subdirectory of another Git repository.
Git submodules are simply a reference to another repository at a particular snapshot in time.
Git submodules enable a Git repository to incorporate and track version history of external code.
(taken from https://www.atlassian.com/git/tutorials/git-submodule)</p>
<p>Unfortunately, git submodules are a very rudimentary way to share code between projects and is
very clumsy and cumbersome to work with in practice.  In reality, code sharing should be via
distributable packages rather than sharing whole source code repositories.</p>
<h4 id="11-avoid-git-submodules-wherever-possible-decision">Decision</h4>
<p>Instead of git submodules, make use of appropriate dependency management (i.e. Pip for Python, Bundler for Ruby,
NPM for Javascript) in order to use external code in a controlled, versioned manner.</p>
<h4 id="11-avoid-git-submodules-wherever-possible-consequences">Consequences</h4>

<ul>
<li>New projects should not use git submodules</li>
<li>Existing or adopted projects using git submodules should be migrated where possible</li>
</ul>
<h2 id="12-collection-names-should-be-singular">12. Collection names should be singular</h2>
<p>Date: 2021-03-08</p>
<h4 id="12-collection-names-should-be-singular-status">Status</h4>
<p>Proposed</p>
<h4 id="12-collection-names-should-be-singular-context">Context</h4>

<ul>
<li>Is this referring to python collection names or database table entities?</li>
</ul>
<h4 id="12-collection-names-should-be-singular-decision">Decision</h4>
<p>TODO</p>
<h4 id="12-collection-names-should-be-singular-consequences">Consequences</h4>
<p>TODO</p>
<h2 id="13-use-github-lfs-for-large-git-files">13. Use Github LFS for large git files</h2>
<p>Date: 2021-03-08</p>
<h4 id="13-use-github-lfs-for-large-git-files-status">Status</h4>
<p>Proposed</p>
<h4 id="13-use-github-lfs-for-large-git-files-context">Context</h4>
<p>Some datasets involve the collection of large resources. These files cannot be easily stored in version control.
However, they should be associated with the repository and it should be possible to retrieve them easily if necessary.
There are several options for hosting these files.</p>
<h4 id="13-use-github-lfs-for-large-git-files-decision">Decision</h4>
<p>Hosting these files on Github is the most straightforward option as it doesn’t require third-party/custom tooling (Git
LFS requires a hosted server).</p>
<h4 id="13-use-github-lfs-for-large-git-files-consequences">Consequences</h4>
<p>There is a cost associated with hosting on Github. Users will need to have Git LFS installed in order to be able to
retrieve large files.</p>
<h2 id="14-use-kebab-case-for-names-in-data">14. Use kebab-case for names in data</h2>
<p>Date: 2021-03-08</p>
<h4 id="14-use-kebab-case-for-names-in-data-status">Status</h4>
<p>Proposed</p>
<h4 id="14-use-kebab-case-for-names-in-data-context">Context</h4>
<p>Kebab case &ndash; or kebab-case &ndash; is a programming variable naming convention where a developer replaces the spaces
between words with a dash.</p>
<h4 id="14-use-kebab-case-for-names-in-data-decision">Decision</h4>
<p>TODO</p>
<h4 id="14-use-kebab-case-for-names-in-data-consequences">Consequences</h4>
<p>TODO</p>
<h2 id="15-write-new-tests-at-the-lowest-possible-levels">15. Write new tests at the lowest possible levels</h2>
<p>Date: 2021-03-09</p>
<h4 id="15-write-new-tests-at-the-lowest-possible-levels-status">Status</h4>
<p>Proposed</p>
<h4 id="15-write-new-tests-at-the-lowest-possible-levels-context">Context</h4>
<p>Software testing can occur at different levels and different granularities. A well-developed CI pipeline will require a
test suite that finds the balance between speed and coverage. Low level tests, such as unit tests, are fast to run and
target a specific &lsquo;unit&rsquo; of code. High level tests, such as end-to-end tests, focus on behaviour and application
workflow. These tests have wider coverage but take longer to execute.</p>
<h4 id="15-write-new-tests-at-the-lowest-possible-levels-decision">Decision</h4>
<p>We should aim to test a feature or development extensively at the lowest possible levels. This will allow the test suite
to remain fast. It will also increase the chance of catching issues earlier and making them easier to debug. This should
not preclude us from adding high level tests where appropriate; often these will only need to cover a happy path
scenario.</p>
<p>See <a href="https://martinfowler.com/articles/practical-test-pyramid.html#TheTestPyramid">here</a> for more details.</p>
<h4 id="15-write-new-tests-at-the-lowest-possible-levels-consequences">Consequences</h4>
<h2 id="16-missing-entry-dates">16. Missing entry-dates</h2>
<p>Date: 2021-04-20</p>
<h4 id="16-missing-entry-dates-status">Status</h4>
<p>Proposed</p>
<h4 id="16-missing-entry-dates-context">Context</h4>
<p>The entry-date field is a very important part of all of our data schemas. It is this entry-date that allows us to
sequence entries and ultimately provide an accurate snapshot of the data as it is or was at a given point in time. Due
to the criticality of the entry-date, when this value is missing from an entry it presents us with a problem. The
pipeline contains some logic that will set missing entry-dates to a default value (currently the date on when we first
collected the resource containing the entry), but this is not reliable.</p>
<p>This problem becomes particularly acute when dealing with historic resources that are missing entry-dates. If we start
collecting a historic resource on 1st Jan 2021, that date will be used as the default for any missing entry-dates
despite the fact that this data may have been published decades earlier. Suddenly these historic entries would take
precedence over any other data collected prior to 1st Jan 2021.</p>
<h4 id="16-missing-entry-dates-decision">Decision</h4>
<p>It&rsquo;s impossible for us to guess the correct value for the entry-date, so we will instead accept that these dates are
imperfect. In the case where we know for certain that an entry-date is incorrect and this is causing data accuracy
issues (e.g. as described above), we will use the existing patching mechanism to correct it.</p>
<h4 id="16-missing-entry-dates-consequences">Consequences</h4>

<ul>
<li>We should be explicit with data providers about the importance and usage of the entry-date field, so that they can
treat it with the care it deserves (where possible).</li>
<li>The existing mechanism to default missing entry-date values to the date of the first collection will remain in place.</li>
<li>Patches should be added to set entry-date in cases where it is known to be wrong.</li>
<li>Data providers will have visibility of any changes that our processes make to entry-date values, so that they can
correct the source data ahead of any future submissions (where possible).</li>
</ul>
<h2 id="17-use-vector-tiles-to-display-geographic-data-on-a-map">17. Use vector tiles to display geographic data on a map</h2>
<p>Date: 2021-07-22</p>
<h4 id="17-use-vector-tiles-to-display-geographic-data-on-a-map-status">Status</h4>
<p>Accepted</p>
<h4 id="17-use-vector-tiles-to-display-geographic-data-on-a-map-context">Context</h4>
<p>We need to be able to display multiple geography datasets on a map. These vary from large to small datasets, with
varying densities and scales. The geometry data is converted to GeoJSON and stored in the view model. Points for
consideration
- the map should be performant
- it should be quick to add/modify a dataset
- it should be possible to style each dataset individually
- the data should be provided in a widely supported format
- retrieval of data should be fast, efficient and scalable</p>
<h4 id="17-use-vector-tiles-to-display-geographic-data-on-a-map-decision">Decision</h4>
<p>Geographic data should be served as vector tiles using Datasette and the MBTiles specification. This involves a
conversion step from GeoJSON to vector tiles, where some processing is done to package data into tiles corresponding to
different grid cells and zoom levels. Each dataset will produce its own corresponding tileset. The vector tile server is
hosted via Datasette on a dedicated instance. Access to this data is provided through Datasette&rsquo;s API and through a
source url that is compatible with vector-based map libraries.</p>
<h4 id="17-use-vector-tiles-to-display-geographic-data-on-a-map-consequences">Consequences</h4>

<ul>
<li>This approach allows the map to be performant as it will only request the tiles necessary for the viewport. This also
reduces the load on the tile server.</li>
<li>Vector tiles are optimised for different scales </li>
<li>Vector tiles allow for styling individual layers (datasets)</li>
<li>Since each dataset has its own tileset, a dataset toggle feature on the map will only retrieve the dataset(s)
requested by the user</li>
<li>It is possible for users to download the vector tilesets for their own use. It is packaged in MBTiles (sqlite), a
well-known format.</li>
<li>The tile server simply serves the tile requested - there is no expensive logic or spatial queries required.</li>
<li>The generation of the tilesets is an added time cost to our CI/CD pipeline. </li>
<li>We should be careful not to use conversion options that change the underlying data (e.g. removing polygons/points)</li>
</ul>
<h2 id="18-use-nodejs-to-serve-the-frontend-of-the-new-data-validation-tool-and-interact-with-other-apis">18. Use NodeJS to serve the frontend of the new data validation tool and interact with other APIs</h2>
<p>Date: 2023-10-24</p>
<h4 id="18-use-nodejs-to-serve-the-frontend-of-the-new-data-validation-tool-and-interact-with-other-apis-status">Status</h4>
<p>Pending</p>
<h4 id="18-use-nodejs-to-serve-the-frontend-of-the-new-data-validation-tool-and-interact-with-other-apis-context">Context</h4>
<p>We need some way to serve our frontend to users, and handle forwarding requests onto our other APIs needed for validation. at the moment the requirements on this are fairly limited, but we want the room to grow if needed.</p>
<h4 id="18-use-nodejs-to-serve-the-frontend-of-the-new-data-validation-tool-and-interact-with-other-apis-decision">Decision</h4>
<p>We will start with a simple nodeJS application and will review if this was the right call a couple of weeks from now.
All the buisness logic should be delegated to other APIs, and exception to this will be documented.</p>
<h4 id="18-use-nodejs-to-serve-the-frontend-of-the-new-data-validation-tool-and-interact-with-other-apis-consequences">Consequences</h4>

<ul>
<li>This approach would have slight performance improvements over fastAPI.</li>
<li>Prototypes produced by our designer Adam Silver can be easily used as a starting point as they are built with nunjucks and the gds.</li>
<li>Frontend developers may find it easier to onboard as they will be familiar with the tech stack. and wont need to upskill in python.</li>
<li>We should be careful not to include too much business logic within the nodeJS application, or risk needing our developers to upskill in nodejs and fastapi.</li>
<li>We will be able to use the official GDS frontend toolkit, which will make it easier to build a consistent UI. as opposed to using the unofficial python port / nunjucks implementation of the GDS frontend toolkit.</li>
</ul>
<h2 id="19-use-pytest-and-jsonschema-as-the-contract-validation-and-testing-solution">19. Use PyTest and JSONSchema as the Contract validation and testing solution</h2>
<p>Date: 2023-10-24</p>
<h4 id="19-use-pytest-and-jsonschema-as-the-contract-validation-and-testing-solution-status">Status</h4>
<p>Pending</p>
<h4 id="19-use-pytest-and-jsonschema-as-the-contract-validation-and-testing-solution-context">Context</h4>
<p>Ideally, we would like to:
- test messages flowing in and out of our API endpoints - Requests &amp; Responses
- establish message schemas for the service-oriented elements of the Products we create</p>
<h4 id="19-use-pytest-and-jsonschema-as-the-contract-validation-and-testing-solution-decision">Decision</h4>
<p>We will develop a suite of tests (over time) that will typically
be run by the CI/CD pipeline.</p>
<p>The tests will be based on the PyTest framework as it has proven to
be an effective testing framework, and is already used extensively in our code base.</p>
<p>The tests will focus on:
- validating that correct messages produce valid,
and expected responses.
- validating that incorrect messages produce a suitable error response</p>
<h4 id="19-use-pytest-and-jsonschema-as-the-contract-validation-and-testing-solution-consequences">Consequences</h4>

<ul>
<li>The approach assumes that the API front end is capable of injecting the validation service as a dependency.</li>
<li>The approach may prove too simplistic and need replacing with something better suited to the purpose.</li>
<li>The first tests will be based on the FastAPI framework. If we later decide to use another framework,
the tests will extensive re-factoring to continue working</li>
</ul>

            
          </main>

          <aside>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">


      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="../../javascripts/application.js"></script>
  </body>
</html>

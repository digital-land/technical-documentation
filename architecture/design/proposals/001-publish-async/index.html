<!doctype html>
<html lang="en" class="govuk-template no-js">
  <head>
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>Open Design Proposal Template - Planning Data</title>

    <link href="../../../../stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="digital-land.github.io/architecture/design/proposals/001-publish-async/">

      <meta name="robots" content="noindex" />
      <meta name="twitter:card" content="summary" />
      <meta name="twitter:image" content="digital-land.github.io/images/govuk-large.png" />
      <meta name="twitter:title" content="Open Design Proposal Template - Planning Data" />
      <meta name="twitter:url" content="digital-land.github.io/architecture/design/proposals/001-publish-async/" />

      <meta property="og:image" content="digital-land.github.io/images/govuk-large.png" />
      <meta property="og:site_name" content="Planning Data" />
      <meta property="og:title" content="Open Design Proposal Template" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="digital-land.github.io/architecture/design/proposals/001-publish-async/" />

    
  </head>

  <body class="govuk-template__body">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link" data-module="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="https://planning.data.gov.uk" class="govuk-header__link govuk-header__link--homepage">
        <span class="govuk-header__product-name">
          Planning Data
        </span>
      </a>
        <strong class="govuk-tag">Beta</strong>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <button type="button" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </button>
        </div>

      <div class="app-pane__body" data-module="in-page-navigation">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents" tabindex="-1" aria-label="Table of contents" role="dialog">
              <div class="search" data-module="search" data-path-to-site-root="../../../../">
  <form action="https://www.google.co.uk/search" method="get" role="search" class="search__form govuk-!-margin-bottom-4">
    <input type="hidden" name="as_sitesearch" value="digital-land.github.io"/>
    <label class="govuk-label search__label" for="search" aria-hidden="true">
      Search (via Google)
    </label>
    <input
      type="text"
      id="search" name="q"
      class="govuk-input govuk-!-margin-bottom-0 search__input"
      aria-controls="search-results"
      placeholder="Search">
    <button type="submit" class="search__button">Search</button>
  </form>
</div>

              <button type="button" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></button>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading" data-module="collapsible-navigation">
                      <ul>
  <li>
    <a href="../../../../index.html"><span>Planning Data Service</span></a>
  </li>
  <li>
    <a href="../../../../documentation/index.html"><span>Documentation</span></a>
  </li>
<li><a href="../../../../architecture/index.html"><span>Architecture</span></a>
<ul>
  <li>
    <a href="../../../../architecture/decision-records/index.html"><span>Architecture Decision Records (ADRs)</span></a>
  </li>
<li><a href="../../../../architecture/design/index.html"><span>Solution design index</span></a>
<ul>
<li><a href="../../../../architecture/design/archive/index.html"><span>Solution design archive</span></a>
<ul>
  <li>
    <a href="../../../../architecture/design/archive/2022-11/index.html"><span>Solution design - November 2022</span></a>
  </li>
</ul>
</li>
<li><a href="../../../../architecture/design/latest/index.html"><span>Solution design</span></a>
<ul>
  <li>
    <a href="../../../../architecture/design/latest/data-pipelines/index.html"><span>Solution design - Data Pipelines</span></a>
  </li>
  <li>
    <a href="../../../../architecture/design/latest/planning-data-platform/index.html"><span>Solution design - Planning Data Platform</span></a>
  </li>
  <li>
    <a href="../../../../architecture/design/latest/publish-service/index.html"><span>Solution design - Publish Service</span></a>
  </li>
</ul>
</li>
<li><a href="../../../../architecture/design/proposals/index.html"><span>Open Design Proposals</span></a>
<ul>
  <li>
    <a href="../../../../architecture/design/proposals/template.html"><span>Open Design Proposal - 00X - Title (Template)</span></a>
  </li>
  <li>
    <a href="../../../../architecture/design/proposals/002-data-pipelines-migration/index.html"><span>Open Design Proposal 002 - Data Pipelines Migration</span></a>
  </li>
  <li>
    <a href="../../../../architecture/design/proposals/001-publish-async/index.html"><span>Open Design Proposal 001 - Publish service - Async</span></a>
  </li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
  <li>
    <a href="../../../../infrastructure.html"><span>Infrastructure</span></a>
  </li>
  <li>
    <a href="../../../../data-operations-manual.html"><span>Data Operations</span></a>
  </li>
  <li>
    <a href="../../../../runbook.html"><span>Run Book</span></a>
  </li>
  <li>
    <a href="../../../../WorkingWithLPA_GIS.html"><span>Working with LPA GIS Systems</span></a>
  </li>
  <li>
    <a href="../../../../HowTos.html"><span>How-to Guides</span></a>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled" aria-label="Content" tabindex="0">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
            <h1 id="open-design-proposal-001-publish-service-async">Open Design Proposal 001 - Publish service - Async</h1>
<p>Author(s) - <a href="mailto:chris.cundill@tpximpact.com">Chris Cundill</a></p>
<h2 id="status">Status</h2>
<p>Open</p>
<h2 id="introduction">Introduction</h2>
<p>The first iteration of the Publish service offers validation of data files via an upload.  Interaction with the user
is currently synchronous, meaning that a user uploads their data file and waits for an immediate validation response.
The service needs to scale to support many more data sets and concurrent users meaning that the this approach is likely
to result in system failure and/or poor user experience.</p>
<p>Causes of system failure might include:</p>

<ul>
<li>Gateway/request timeout: requests take too long to process due to the size</li>
<li>Out of memory: available memory might be &lsquo;maxxed&rsquo; out when trying to handle multiple large data files concurrently</li>
<li>No more disk space: disk space might also be exceeded when trying to handle multiple large data files concurrently</li>
<li>Request size too large: uploads of large files might exceed what the gateway or web servers are able to handle</li>
</ul>
<p>Meanwhile, poor user experience might be caused by excessive wait times for validation of large files.</p>
<p>During development of the current service, it was observed that a data file of ~11MB was taking over 30 seconds to
process.  Clearly, there are genuine scenarios where it will not be feasible to provide validation responses to end
users synchronously.</p>
<h2 id="detail">Detail</h2>
<h3 id="overview">Overview</h3>
<p>In order to address the problems outlined, the following changes are proposed:</p>

<ul>
<li>Respond to validation requests asynchronously</li>
<li>Upload files direct to S3</li>
</ul>
<p>By responding to validation requests asynchronously, the system is able to fulfil a user&rsquo;s request in a manner that
minimises the risk of system failure.  Memory and disk space can be optimised for processing each individual request.
A database will be introduced to persist requests and validation results while a queue will be used to trigger
asynchronous processing of requests.</p>
<p>By uploading files directly to S3, large files will be handled by AWS&rsquo; dedicated infrastructure designed for multipart
uploads.  Gateways, web servers and APIs do not need to be scaled for file-based requests. In addition, allocated disk
space does not need to cater for storage of multiple concurrent uploaded files.</p>
<h3 id="containers">Containers</h3>
<h4 id="structure">Structure</h4>
<p><a href="images/containers.drawio.png" rel="noopener noreferrer"><img src="images/containers.drawio.png" alt="Planning Data Service System Context" /></a></p>
<p>The Publish Request API will manage request data and persist such to a Postgres database.</p>
<p>An SQS queue will be used to trigger request to be fulfilled by the Publish Request Processor.</p>
<p>The Publish Request Processor will process just one request at a time meaning its CPU, memory and disk requirements
need only be as large as is necessary to process one file.  Running multiple instances of the Processor allows the
system to process multiple requests concurrently.</p>
<p>GOV.UK Notify will be used to send an email notification to users</p>
<h4 id="interaction">Interaction</h4>
<p><a href="images/container-interaction.drawio.png" rel="noopener noreferrer"><img src="images/container-interaction.drawio.png" alt="Planning Data Service System Context" /></a></p>
<h3 id="testing">Testing</h3>
<p>In order to validate the solution and indeed arrive at the correct assignment of compute resources (e.g. CPU, memory and disk),
it will be necessary to undertake load testing.  This testing will also help determine the necessary number of processors
required to meet concurrency targets.</p>
<p>One possible method for the load testing could be using AWS&rsquo;s Distributed Load Testing pattern
(see https://aws.amazon.com/solutions/implementations/distributed-load-testing-on-aws/).</p>
<h2 id="implementation-considerations">Implementation considerations</h2>

<ul>
<li><p>New AWS resources will need to be provisioned for:</p>

<ul>
<li>Publish Request Database (Postgres on AWS RDS Aurora)

<ul>
<li>Create empty database and app users for Publish Request API</li>
</ul></li>
<li>Publish Request Queue (SQS)</li>
<li>Publish Request Files (S3 Bucket)</li>
</ul></li>
<li><p>New code repositories, GitHub pipelines, ECR image repositories and ECS tasks will be needed for:</p>

<ul>
<li>Publish Request API

<ul>
<li>Service should be able to migrate/mange own database schema</li>
<li>No need for CloudFront distribution</li>
<li>Internal load balancer sufficient</li>
</ul></li>
<li>Publish Request Processor

<ul>
<li>No need for CloudFront distribution nor a load balancer</li>
</ul></li>
</ul></li>
<li><p>For upload direct to S3, users will be required to have Javascript enabled.</p></li>
<li><p>For load testing, it will be necessary to identify realistic figures for concurrent users and file sizes.</p>

<ul>
<li>It would be useful to identify min, max and average file sizes</li>
</ul></li>
</ul>
<h2 id="design-comments-questions">Design Comments/Questions</h2>
<p>No feedback yet.</p>

            
          </main>

          <aside>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">


      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="../../../../javascripts/application.js"></script>
  </body>
</html>
